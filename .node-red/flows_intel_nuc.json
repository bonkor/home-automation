[{"id":"b3e2291e.f32e58","type":"tab","label":"Flow 1","disabled":false,"info":""},{"id":"51445fb5.e4d8f8","type":"tab","label":"Server common","disabled":false,"info":"Common setups"},{"id":"d82282fe.72a6f","type":"tab","label":"ZWave common","disabled":false,"info":""},{"id":"2708f35f.d8411c","type":"tab","label":"Zwave statistics","disabled":false,"info":""},{"id":"98294fdc.335fa","type":"tab","label":"Telegram common","disabled":false,"info":""},{"id":"f2224d70.f96078","type":"tab","label":"Weather","disabled":false,"info":""},{"id":"3c3e5440.4b857c","type":"tab","label":"History","disabled":false,"info":""},{"id":"da0e7180.b9ebd8","type":"tab","label":"Presence","disabled":false,"info":""},{"id":"d93a928a.102338","type":"tab","label":"PresenceOld","disabled":true,"info":""},{"id":"b92ee226.f85478","type":"tab","label":"Thermo floor","disabled":false,"info":""},{"id":"9f161aad.b6b7b8","type":"tab","label":"Ventilation common","disabled":true,"info":""},{"id":"4a108442.009864","type":"tab","label":"Ventilation","disabled":true,"info":""},{"id":"ff9f5d72.eb6f2","type":"tab","label":"Thermo floor old","disabled":true,"info":""},{"id":"93883042.bbe68","type":"tab","label":"Blinds","disabled":true,"info":""},{"id":"98f6b4ab.de8e9","type":"tab","label":"Water leakage","disabled":true,"info":""},{"id":"2585caa7.9d343e","type":"tab","label":"Smoke","disabled":true,"info":""},{"id":"3a3cfd59.03e752","type":"tab","label":"Lights","disabled":true,"info":""},{"id":"dc8c9c.eb0bdb68","type":"tab","label":"Conditionaire common","disabled":true,"info":""},{"id":"1c7b4521.d6dd8b","type":"tab","label":"Conditionaire","disabled":true,"info":""},{"id":"8cb7951c.d33fd8","type":"tab","label":"Media","disabled":true,"info":""},{"id":"c06450d5.5deb8","type":"tab","label":"Radiator","disabled":true,"info":""},{"id":"27131d46.3b7e1a","type":"subflow","name":"Concat values","info":"Can concat values\npayload: {value: 1, interval: 1000}","category":"","in":[{"x":60,"y":120,"wires":[{"id":"2bf56014.74fc8"}]}],"out":[{"x":340,"y":120,"wires":[{"id":"2bf56014.74fc8","port":0}]}]},{"id":"8f22b76d.1c6718","type":"subflow","name":"isWeekend","info":"check is weekend","category":"","in":[{"x":80,"y":80,"wires":[{"id":"878fd92c.a21bd8"}]}],"out":[{"x":800,"y":40,"wires":[{"id":"33fde4a6.c2b2ac","port":0}]},{"x":800,"y":120,"wires":[{"id":"33fde4a6.c2b2ac","port":1}]}]},{"id":"97ace3bb.49fd58","type":"subflow","name":"Telegram confirm","info":"","category":"","in":[{"x":80,"y":60,"wires":[{"id":"fdae9023.7d455"}]}],"out":[{"x":1180,"y":360,"wires":[{"id":"66f55a40.3c22a4","port":0}]},{"x":1180,"y":460,"wires":[{"id":"d1d4b160.2e08f","port":0}]},{"x":1180,"y":520,"wires":[{"id":"8af919ab.9e27d","port":2}]}],"env":[]},{"id":"fdf44b03.831398","type":"subflow","name":"Telegram msg","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"231cc159.27ce0e"}]}],"out":[],"env":[]},{"id":"cd15286e.157c08","type":"subflow","name":"Get ventilation saved props","info":"","category":"ventilation","in":[{"x":40,"y":80,"wires":[{"id":"80886b8d.7089b"}]}],"out":[{"x":660,"y":80,"wires":[{"id":"1ee1a448.c539cc","port":0}]}],"env":[]},{"id":"9ae1a772.3c7408","type":"subflow","name":"Check blinds position","info":"","category":"blinds","in":[{"x":80,"y":80,"wires":[{"id":"1306de92.ae96c9"}]}],"out":[{"x":640,"y":40,"wires":[{"id":"160ba9d0.14edb6","port":0}]},{"x":640,"y":100,"wires":[{"id":"160ba9d0.14edb6","port":1}]}],"env":[]},{"id":"fd825ba0.07d958","type":"subflow","name":"get lux","info":"","category":"","in":[{"x":120,"y":140,"wires":[{"id":"7000c3d2.890694"}]}],"out":[{"x":680,"y":140,"wires":[{"id":"39f29dd.de3d4e2","port":0}]}],"env":[]},{"id":"dcdd460.216ae38","type":"subflow","name":"get humidity","info":"","category":"","in":[{"x":160,"y":100,"wires":[{"id":"18a65679.750f5a"}]}],"out":[{"x":720,"y":100,"wires":[{"id":"3d7cbbc6.6b1324","port":0}]}],"env":[]},{"id":"747dd001.60d558","type":"subflow","name":"getNodeName","info":"","category":"","in":[{"x":60,"y":120,"wires":[{"id":"36b10e50.0bd1fa"}]}],"out":[{"x":740,"y":120,"wires":[{"id":"c598138a.8e5fc","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"e312d9ea.c89338","type":"mqtt-broker","z":"","name":"broker","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"b0c4e7bf.f27208","type":"mongodb","z":"","hostname":"127.0.0.1","port":"27017","db":"server","name":"mongo"},{"id":"bab0b0b8.f47798","type":"modbus-client","z":"","name":"modbus","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":false,"tcpHost":"localhost","tcpPort":"4444","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"1000","reconnectTimeout":"2000"},{"id":"d47f185f.a8541","type":"influxdb","z":"","hostname":"127.0.0.1","port":"8086","protocol":"http","database":"statistics","name":"influx config","usetls":false,"tls":""},{"id":"c0f9546c.dfb49","type":"rmdevice","z":"","folder":"/home-automation/broadlink/SharedData","mac":"FFFFFFFFFFFF","host":"127.0.0.1"},{"id":"3e9f2b83.e4fc44","type":"rmdevice","z":"","folder":"/home-automation/broadlink/SharedData","mac":"FFFFFFFFFFFF","host":"127.0.0.1"},{"id":"77f89cfa.c3377c","type":"zwave-controller","z":"","port":"/dev/ttyACM0","driverattempts":"3","pollinterval":"1800000","allowunreadyupdates":true,"networkkey":"","logging":"full"},{"id":"7fd9f3a.bc9e48c","type":"telegram bot","z":"","botname":"bonkorbot","usernames":"bonkor_ks","chatids":"403702051","baseapiurl":"","updatemode":"polling","pollinterval":"300","usesocks":false,"sockshost":"88.198.46.66","socksport":"2337","socksusername":"foo","sockspassword":"bar","bothost":"","localbotport":"8443","publicbotport":"8443","privatekey":"","certificate":"","useselfsignedcertificate":false,"sslterminated":false,"verboselogging":false},{"id":"c7e407f3.2cfc6","type":"mongodb in","z":"51445fb5.e4d8f8","mongodb":"b0c4e7bf.f27208","name":"","collection":"config","operation":"find","x":560,"y":100,"wires":[["79705343.3a60bc"]]},{"id":"4916e707.ce8118","type":"function","z":"51445fb5.e4d8f8","name":"config func","func":"msg.payload = {id: 1};\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":100,"wires":[["c7e407f3.2cfc6"]]},{"id":"79705343.3a60bc","type":"function","z":"51445fb5.e4d8f8","name":"get config","func":"if(msg.payload && msg.payload.length) {\n    var result = msg.payload[0];\n    delete result._id;\n    delete result.id;\n    msg.payload = result;\n}\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":100,"wires":[["55978ce5.63f50c"]]},{"id":"9b0c6e0e.8aef38","type":"mqtt in dynamic","z":"51445fb5.e4d8f8","topic":"/server/settings/request","qos":"1","name":"settings request","broker":"e312d9ea.c89338","x":140,"y":140,"wires":[["4916e707.ce8118"]]},{"id":"661808dc.586688","type":"mqtt out dynamic","z":"51445fb5.e4d8f8","name":"mqtt out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1040,"y":100,"wires":[]},{"id":"d18f94bc.032c7","type":"inject","z":"51445fb5.e4d8f8","name":"startup","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":140,"y":80,"wires":[["4916e707.ce8118"]]},{"id":"f6d69eb9.1161c8","type":"mqtt out dynamic","z":"51445fb5.e4d8f8","name":"heartbit out","topic":"/server/heartbit/response","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1250,"y":200,"wires":[]},{"id":"b7a51a8e.e590d","type":"inject","z":"51445fb5.e4d8f8","name":"heartbit","topic":"","payload":"{}","payloadType":"json","repeat":"2","crontab":"","once":false,"onceDelay":0.1,"x":1080,"y":200,"wires":[["f6d69eb9.1161c8"]]},{"id":"55978ce5.63f50c","type":"function","z":"51445fb5.e4d8f8","name":"init","func":"msg.topic = '/server/settings/init';\nmsg.payload = {};\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":100,"wires":[["661808dc.586688"]]},{"id":"55ec50e.02377b","type":"zwave-in","z":"d82282fe.72a6f","name":"zwave in","controller":"77f89cfa.c3377c","x":120,"y":100,"wires":[["234eed9e.27a1e2","12d9ca7f.4b7c56"]]},{"id":"234eed9e.27a1e2","type":"switch","z":"d82282fe.72a6f","name":"message type switch","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"zwave: scan complete","vt":"str"},{"t":"eq","v":"zwave: node added","vt":"str"},{"t":"eq","v":"zwave: value added","vt":"str"},{"t":"eq","v":"zwave: value changed","vt":"str"},{"t":"eq","v":"zwave: value refreshed","vt":"str"},{"t":"eq","v":"zwave: node ready","vt":"str"},{"t":"eq","v":"zwave: notification","vt":"str"},{"t":"eq","v":"zwave: node removed","vt":"str"},{"t":"eq","v":"zwave: controller command","vt":"str"}],"checkall":"true","repair":false,"outputs":9,"x":180,"y":220,"wires":[["d542ba02.bca17","d7d35584.4a561"],["3e176af.5308996","2daba046.fc0a"],["3e176af.5308996"],["16e1131d.30aabd","e9bf0d44.5266d"],["e9bf0d44.5266d","16e1131d.30aabd"],["2daba046.fc0a","3e176af.5308996"],["468e26a5.20dbd8"],["2daba046.fc0a","d7881ded.e90b28","e38c23c3.f02ef8"],["b0a5fffa.fa8948","2daba046.fc0a"]]},{"id":"a84613f6.bcbcc8","type":"mqtt out dynamic","z":"d82282fe.72a6f","name":"mqtt out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":740,"y":460,"wires":[]},{"id":"547216ff.04ab7","type":"function","z":"d82282fe.72a6f","name":"ready func","func":"msg.topic = '/zwave/ready/response';\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":920,"wires":[["bc8bb616.40fad"]]},{"id":"a846b44b.8f1008","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/ready/request","qos":"1","name":"ready in","broker":"e312d9ea.c89338","x":120,"y":360,"wires":[["5542f2ad.481f74"]]},{"id":"d542ba02.bca17","type":"function","z":"d82282fe.72a6f","name":"set ready","func":"\nflow.set('ready', true);\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":40,"wires":[["d1ff4422.c2091"]]},{"id":"5542f2ad.481f74","type":"function","z":"d82282fe.72a6f","name":"get ready","func":"var isReady = flow.get('ready');\n\nif(isReady) {\n    return msg;\n}\nreturn;","outputs":1,"noerr":0,"x":320,"y":360,"wires":[["55186ea0.9fd0a8"]]},{"id":"832e3af4.9aa638","type":"zwave-out","z":"d82282fe.72a6f","name":"zwave out","controller":"77f89cfa.c3377c","x":740,"y":520,"wires":[["5e169b87.d5e75c","76f137b5.3678c"]]},{"id":"e863613c.2215f","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/hardreset/request","qos":"1","name":"hard reset in","broker":"e312d9ea.c89338","x":130,"y":440,"wires":[["3a31f254.264dce"]]},{"id":"3a31f254.264dce","type":"function","z":"d82282fe.72a6f","name":"reset zwave","func":"var msg = {};\n\nmsg.topic = \"hardReset\";\nmsg.payload = {};\nmsg.removeAll = true;\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":440,"wires":[["ac912452.fb9f3","4aa12319.3e7544"]]},{"id":"b1d47c39.dad518","type":"link in","z":"d82282fe.72a6f","name":"zwave out","links":["ac912452.fb9f3","d06f589d.66ce8","5c78d5f4.405064","55dd4d11.f7271c","ff3f6d62.ad2438","dabbe9e7.7b78f","855b1daa.33ae","39f725ba.982c82","1d64fca1.a53533","234c60ac.1a3258","7d9e65b7.fa525c","6f88af81.5d4dc","f19a27a8.90341","2978b39.099174c","386b77ef.2fc2b8","e60f1237.204d5","aeca2828.fd8788","aece5505.3a1","1fc50465.ca1d74"],"x":615,"y":520,"wires":[["832e3af4.9aa638","c6244e99.f9d5e"]]},{"id":"ac912452.fb9f3","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":475,"y":460,"wires":[]},{"id":"5ca2a6ed.aa3178","type":"link in","z":"d82282fe.72a6f","name":"mqtt out","links":["bc8bb616.40fad","7e3fa210.a7fb54","6fe906c1.bc3e98","1c7944f2.0b88f3","53648415.fb5e44","a3c44550.40773","6917b550.fb7ce4","c9371606.ff3ef8","8e983d62.be5d08","80084f8f.8638b","e7031f5e.bd0a1","39971fdf.4f6398","64853206.9d007c"],"x":615,"y":460,"wires":[["a84613f6.bcbcc8"]]},{"id":"bc8bb616.40fad","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":915,"y":920,"wires":[]},{"id":"d643114e.5ed07","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/addnode/request","qos":"1","name":"add node in","broker":"e312d9ea.c89338","x":130,"y":520,"wires":[["4ffb1704.dcebb"]]},{"id":"4ffb1704.dcebb","type":"function","z":"d82282fe.72a6f","name":"add zwave node","func":"var msg = {};\n\nmsg.topic = \"addNode\";\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":520,"wires":[["d06f589d.66ce8"]]},{"id":"d06f589d.66ce8","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":475,"y":520,"wires":[]},{"id":"fc9208f9.b82108","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/cancelaction/request","qos":"1","name":"cancel action in","broker":"e312d9ea.c89338","x":120,"y":640,"wires":[["dec30b7d.ca3998"]]},{"id":"dec30b7d.ca3998","type":"function","z":"d82282fe.72a6f","name":"cancel zwave action","func":"var msg = {};\n\nmsg.topic = \"cancelControllerCommand\";\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":640,"wires":[["5c78d5f4.405064"]]},{"id":"5c78d5f4.405064","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":475,"y":640,"wires":[]},{"id":"39819150.59ea7e","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/removenode/request","qos":"1","name":"remove node in","broker":"e312d9ea.c89338","x":120,"y":580,"wires":[["e7d1c980.f2dce8"]]},{"id":"e7d1c980.f2dce8","type":"function","z":"d82282fe.72a6f","name":"remove zwave node","func":"var msg = {};\n\nmsg.topic = \"removeNode\";\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":580,"wires":[["55dd4d11.f7271c"]]},{"id":"55dd4d11.f7271c","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":475,"y":580,"wires":[]},{"id":"2daba046.fc0a","type":"function","z":"d82282fe.72a6f","name":"save config","func":"const newMsg = {};\n\nnewMsg.topic = \"writeConfig\";\nnewMsg.payload = {};\n\nreturn newMsg;","outputs":1,"noerr":0,"x":550,"y":220,"wires":[["ff3f6d62.ad2438"]]},{"id":"ff3f6d62.ad2438","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":715,"y":220,"wires":[]},{"id":"aebc840d.454aa8","type":"function","z":"d82282fe.72a6f","name":"node ready","func":"const newMsg = {};\nnewMsg.topic = '/zwave/addnode/response';\nnewMsg.payload = msg.payload;\n\nreturn newMsg;","outputs":1,"noerr":0,"x":790,"y":660,"wires":[["7e3fa210.a7fb54"]]},{"id":"7e3fa210.a7fb54","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":935,"y":660,"wires":[]},{"id":"d7881ded.e90b28","type":"function","z":"d82282fe.72a6f","name":"node removed","func":"const nodeId = msg.payload.nodeid;\nmsg = {};\nmsg.topic = '/zwave/removenode/response';\nmsg.payload = {nodeid: nodeId};\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":300,"wires":[["6fe906c1.bc3e98"]]},{"id":"6fe906c1.bc3e98","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":815,"y":300,"wires":[]},{"id":"a3c44550.40773","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":715,"y":140,"wires":[]},{"id":"16e1131d.30aabd","type":"function","z":"d82282fe.72a6f","name":"value changes","func":"const value = msg.payload.value;\nmsg.topic = '/zwave/changevalue/response';\nmsg.payload = value;\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":140,"wires":[["a3c44550.40773"]]},{"id":"1b2816aa.b2a369","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/getnodes/request","qos":"1","name":"get nodes","broker":"e312d9ea.c89338","x":120,"y":820,"wires":[["96e29002.6905"]]},{"id":"96e29002.6905","type":"mongodb in","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"get nodes","collection":"zwave-nodes","operation":"find","x":320,"y":840,"wires":[["cdc03838.dff0b"]]},{"id":"6260d215.c65894","type":"inject","z":"d82282fe.72a6f","name":"startup send nodes","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":130,"y":900,"wires":[["96e29002.6905"]]},{"id":"cdc03838.dff0b","type":"function","z":"d82282fe.72a6f","name":"get nodes response","func":"msg.topic = '/zwave/getnodes/response';\nmsg.payload.forEach(x=>{\n    delete x._id;\n});\nmsg.payload = msg.payload;\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":900,"wires":[["6917b550.fb7ce4"]]},{"id":"6917b550.fb7ce4","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":535,"y":900,"wires":[]},{"id":"b0a5fffa.fa8948","type":"function","z":"d82282fe.72a6f","name":"failed node remove","func":"if(msg.state !== 8) return;\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":360,"wires":[["d7881ded.e90b28"]]},{"id":"e1553934.f194c","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/namechange/request","qos":"1","name":"change name in","broker":"e312d9ea.c89338","x":120,"y":980,"wires":[["10186d63.2b72bb","744d6d78.31c8e4"]]},{"id":"312ffdff.48136a","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/changevalue/request","qos":"1","name":"change value in","broker":"e312d9ea.c89338","x":110,"y":1040,"wires":[["b3c72e0f.4c7218","a95ca81.805aad8"]]},{"id":"b3c72e0f.4c7218","type":"function","z":"d82282fe.72a6f","name":"transform node for zwave","func":"msg.topic = 'setValue';\nconst value = msg.payload.value;\n\nconst cmd = {};\ncmd.nodeid = value.node_id;\ncmd.cmdclass = value.class_id;\ncmd.instance = value.instance;\ncmd.cmdidx = value.index;\ncmd.value = value.value;\n    \nmsg.payload = cmd;\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":1040,"wires":[["ede0b265.c4e2a8","ffba13c7.cc6cb8","6af5584b.ba551"]]},{"id":"855b1daa.33ae","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":885,"y":980,"wires":[]},{"id":"d853961e.172338","type":"function","z":"d82282fe.72a6f","name":"heal network","func":"var msg = {};\n\nmsg.topic = \"healNetwork\";\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":700,"wires":[["39f725ba.982c82"]]},{"id":"de25103a.8e2cd","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/healnetwork/request","qos":"1","name":"heal in","broker":"e312d9ea.c89338","x":90,"y":700,"wires":[["d853961e.172338"]]},{"id":"39f725ba.982c82","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":475,"y":700,"wires":[]},{"id":"468e26a5.20dbd8","type":"function","z":"d82282fe.72a6f","name":"transform payload dead/not dead","func":"const nodeid = msg.payload.nodeid;\nconst newPayload = {};\n\n\nif(msg.payload.notification === 5) {\n   newPayload.dead = true;\n}\n\nelse if(msg.payload.notification === 6) {\n   newPayload.dead = false;\n} else {\n    return;\n}\n\n\nnewPayload.nodeid = nodeid\nmsg.payload = newPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":260,"wires":[["9ef45558.936c2","ce9eba82.4dc79"]]},{"id":"9ef45558.936c2","type":"function","z":"d82282fe.72a6f","name":"update node status","func":"msg.topic = '/zwave/nodestatus/response';\nmsg.payload = {nodeid: msg.payload.nodeid, dead: msg.payload.dead};\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":260,"wires":[["c9371606.ff3ef8"]]},{"id":"c9371606.ff3ef8","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":1015,"y":260,"wires":[]},{"id":"deff971a.aebeb","type":"mqtt in dynamic","z":"51445fb5.e4d8f8","topic":"/dashboard/save/request","qos":"1","name":"save","broker":"e312d9ea.c89338","x":110,"y":200,"wires":[["3974bf3a.96bd88"]]},{"id":"3974bf3a.96bd88","type":"function","z":"51445fb5.e4d8f8","name":"before search","func":"msg.original = msg.payload;\nmsg.payload = {id: 1};\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":200,"wires":[["fa601ab0.f6b9f8"]]},{"id":"5061604d.857ad8","type":"mongodb out","z":"51445fb5.e4d8f8","mongodb":"b0c4e7bf.f27208","name":"save dashboard","collection":"dashboard","payonly":true,"upsert":false,"multi":false,"operation":"store","x":840,"y":200,"wires":[]},{"id":"fa601ab0.f6b9f8","type":"mongodb in","z":"51445fb5.e4d8f8","mongodb":"b0c4e7bf.f27208","name":"find","collection":"dashboard","operation":"find","x":470,"y":200,"wires":[["d34e80cf.194b18","e45ddef6.7e6138"]]},{"id":"d34e80cf.194b18","type":"function","z":"51445fb5.e4d8f8","name":"after search","func":"if(msg.loading) return;\n\nlet found = msg.payload[0];\n\nif(!found) {\n    found = {id: 1};\n}\n\nfound.data = msg.original;\nmsg.payload = found;\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":200,"wires":[["5061604d.857ad8"]]},{"id":"81ecbcaf.701478","type":"mqtt in dynamic","z":"51445fb5.e4d8f8","topic":"/dashboard/load/request","qos":"1","name":"load","broker":"e312d9ea.c89338","x":110,"y":300,"wires":[["69883eea.693ae"]]},{"id":"48ea16dc.6b8a38","type":"mqtt out dynamic","z":"51445fb5.e4d8f8","name":"send dashboard","topic":"/dashboard/load/response","qos":"1","retain":"","broker":"e312d9ea.c89338","x":840,"y":300,"wires":[]},{"id":"e45ddef6.7e6138","type":"function","z":"51445fb5.e4d8f8","name":"after load","func":"let found = msg.payload[0];\n\nif(!found) {\n    return;\n}\n\nif(!msg.loading) {\n    const newMsg = {};\n    newMsg.payload = { data: msg.original };\n    \n    return newMsg;\n}\n\nmsg.payload = {data: found.data};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":300,"wires":[["48ea16dc.6b8a38"]]},{"id":"69883eea.693ae","type":"function","z":"51445fb5.e4d8f8","name":"before load","func":"msg.loading = true;\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["3974bf3a.96bd88"]]},{"id":"a51c4b1.8835c38","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/removedead/request","qos":"1","name":"remove dead in","broker":"e312d9ea.c89338","x":140,"y":760,"wires":[["eb2095da.6df77","d3a4455.cc2b838"]]},{"id":"1d64fca1.a53533","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":435,"y":800,"wires":[]},{"id":"eb2095da.6df77","type":"function","z":"d82282fe.72a6f","name":"remove dead","func":"const nodeId = msg.payload.nodeid;\n\nmsg.topic = \"removeFailedNode\";\nmsg.payload = { args: [nodeId] };\n\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":800,"wires":[["1d64fca1.a53533"]]},{"id":"2120a038.d2aff8","type":"inject","z":"9f161aad.b6b7b8","name":"Get status","topic":"","payload":"{\"payload\":{}}","payloadType":"json","repeat":"1","crontab":"","once":true,"onceDelay":"1","x":130,"y":260,"wires":[["86f207f0.8c5a5","3f39e710.456d8","bf8b89d9.85a598","28d6c8e5.a33ba","4baaea3a.05c26c","4e391fa0.2d759","7954775a.d06c7","edb53ce7.4f6ef8"]]},{"id":"44f9c49a.1c89dc","type":"function","z":"9f161aad.b6b7b8","name":"set modbus get params","func":"if(!msg.payload.quantity) {\n    msg.payload.quantity = 1;\n}\nif(!msg.payload.fc) {\n    msg.payload.fc = 4;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":260,"wires":[["f458b590.7c57"]]},{"id":"86f207f0.8c5a5","type":"function","z":"9f161aad.b6b7b8","name":"get error code","func":"msg.topic = 'error';\nmsg.payload.address = 19;\nmsg.payload.quantity = 2;\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":200,"wires":[["44f9c49a.1c89dc"]]},{"id":"f458b590.7c57","type":"modbus-flex-getter","z":"9f161aad.b6b7b8","name":"status get","showStatusActivities":false,"showErrors":false,"logIOActivities":false,"server":"bab0b0b8.f47798","useIOFile":false,"ioFile":"","useIOForPayload":false,"x":820,"y":260,"wires":[[],["728dd926.642498"]]},{"id":"728dd926.642498","type":"switch","z":"9f161aad.b6b7b8","name":"","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"error","vt":"str"},{"t":"eq","v":"power status","vt":"str"},{"t":"eq","v":"temperature","vt":"str"},{"t":"eq","v":"temperature setted","vt":"str"},{"t":"eq","v":"fan speed","vt":"str"},{"t":"eq","v":"fan speed setted","vt":"str"},{"t":"eq","v":"fan consumption","vt":"str"},{"t":"eq","v":"ten consumption","vt":"str"}],"checkall":"true","repair":false,"outputs":8,"x":990,"y":180,"wires":[["969ef95c.dbb638"],["76711996.c04038"],["fd79ab20.22fdd"],["ebf5aadc.258628"],["dd32af21.ebaf98"],["da691650.3ddb3"],["be096ecd.671dd"],["68c08f79.6cc068"]]},{"id":"969ef95c.dbb638","type":"function","z":"9f161aad.b6b7b8","name":"error","func":"const {data} = msg.payload;\nmsg.payload = {};\nif(data[0]+data[1]*0x10000 !== 0) {\n    msg.payload.error = true;\n} else {\n      msg.payload.error = false;\n}\n\nflow.set('error', msg.payload.error);\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":140,"wires":[["5ac08074.918c18"]]},{"id":"3f39e710.456d8","type":"function","z":"9f161aad.b6b7b8","name":"get power status","func":"msg.topic = 'power status';\nmsg.payload.address = 10;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":260,"wires":[["44f9c49a.1c89dc"]]},{"id":"76711996.c04038","type":"function","z":"9f161aad.b6b7b8","name":"power status","func":"const {data} = msg.payload;\nmsg.payload = {};\nif(data[0] == 1) {\n    msg.payload.enabled = true;\n} else {\n      msg.payload.enabled = false;\n}\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":200,"wires":[["33c51ba8.f7ce44","5ac08074.918c18"]]},{"id":"bf8b89d9.85a598","type":"function","z":"9f161aad.b6b7b8","name":"get temperature","func":"msg.topic = 'temperature';\nmsg.payload.address = 13;\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":320,"wires":[["44f9c49a.1c89dc"]]},{"id":"fd79ab20.22fdd","type":"function","z":"9f161aad.b6b7b8","name":"temperature","func":"const {data} = msg.payload;\nmsg.payload = {temperature: data[0]/10};\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;","outputs":1,"noerr":0,"x":1230,"y":260,"wires":[["33c51ba8.f7ce44","5ac08074.918c18"]]},{"id":"28d6c8e5.a33ba","type":"function","z":"9f161aad.b6b7b8","name":"get fan speed","func":"msg.topic = 'fan speed';\nmsg.payload.address = 17;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":380,"wires":[["44f9c49a.1c89dc"]]},{"id":"dd32af21.ebaf98","type":"function","z":"9f161aad.b6b7b8","name":"fan speed","func":"const {data} = msg.payload;\nmsg.payload = {speed: data[0]/100};\nmsg.topic = '/ventilation/status/response';\nreturn msg;","outputs":1,"noerr":0,"x":1220,"y":380,"wires":[["33c51ba8.f7ce44","5ac08074.918c18"]]},{"id":"4baaea3a.05c26c","type":"function","z":"9f161aad.b6b7b8","name":"get fan consuption","func":"msg.topic = 'fan consumption';\nmsg.payload.address = 10004;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":580,"wires":[["44f9c49a.1c89dc"]]},{"id":"be096ecd.671dd","type":"function","z":"9f161aad.b6b7b8","name":"fan consumption","func":"const {data} = msg.payload;\n\nlet value = data[0] / 60 / 60;\n\nmsg.payload = {value: value, interval: (1000*60)*60};\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":540,"wires":[["7e79c487.44a304"]]},{"id":"4e391fa0.2d759","type":"function","z":"9f161aad.b6b7b8","name":"get ten consuption","func":"msg.topic = 'ten consumption';\nmsg.payload.address = 14004;\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":640,"wires":[["44f9c49a.1c89dc"]]},{"id":"68c08f79.6cc068","type":"function","z":"9f161aad.b6b7b8","name":"ten consumption","func":"const {data} = msg.payload;\n\nlet value = data[0] / 60 / 60;\n\nmsg.payload = {value: value, interval: (1000*60)*60};\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":580,"wires":[["3ce896c9.d77d2a"]]},{"id":"2bf56014.74fc8","type":"function","z":"27131d46.3b7e1a","name":"concat value","func":"let concatValue = context.get('val');\nconst setInt = context.get('set');\n\nif(!concatValue) {\n    concatValue = 0;\n}\n\nconcatValue += msg.payload.value;\n\ncontext.set('val', concatValue);\n\nif(!setInt) {\n    const interval = msg.payload.interval ? msg.payload.interval : 1000;\n    setInterval(()=>{\n        node.send({topic: msg.topic, payload: {value: concatValue}});\n        context.set('val', 0);\n    }, interval);\n    context.set('set', true);\n}\n","outputs":1,"noerr":0,"x":190,"y":120,"wires":[[]]},{"id":"7e79c487.44a304","type":"subflow:27131d46.3b7e1a","z":"9f161aad.b6b7b8","name":"","x":1490,"y":540,"wires":[["eee0884c.66d68"]]},{"id":"3ce896c9.d77d2a","type":"subflow:27131d46.3b7e1a","z":"9f161aad.b6b7b8","name":"","x":1490,"y":580,"wires":[["eee0884c.66d68"]]},{"id":"f3a77468.f20b38","type":"mongodb out","z":"9f161aad.b6b7b8","mongodb":"b0c4e7bf.f27208","name":"save to db","collection":"ventilation","payonly":false,"upsert":true,"multi":false,"operation":"update","x":720,"y":80,"wires":[]},{"id":"5ac08074.918c18","type":"link out","z":"9f161aad.b6b7b8","name":"","links":["ab8ab091.750de8"],"x":1635,"y":240,"wires":[]},{"id":"ab8ab091.750de8","type":"link in","z":"9f161aad.b6b7b8","name":"save to db","links":["5ac08074.918c18","2815858d.5d1a5a"],"x":355,"y":80,"wires":[["b4060943.6ae9d8"]]},{"id":"1915fca2.839543","type":"link in","z":"9f161aad.b6b7b8","name":"mqtt out","links":["33c51ba8.f7ce44","17798e84.df4c61"],"x":585,"y":140,"wires":[["8d2086e1.66c1c"]]},{"id":"33c51ba8.f7ce44","type":"link out","z":"9f161aad.b6b7b8","name":"","links":["1915fca2.839543"],"x":1635,"y":320,"wires":[]},{"id":"6b890954.7bbe58","type":"mqtt in dynamic","z":"9f161aad.b6b7b8","topic":"/ventilation/allstatus/request","qos":"1","name":"request status","broker":"e312d9ea.c89338","x":140,"y":800,"wires":[["8ecae92e.0fb388"]]},{"id":"8d2086e1.66c1c","type":"mqtt out dynamic","z":"9f161aad.b6b7b8","name":"mqtt out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":710,"y":140,"wires":[]},{"id":"8ecae92e.0fb388","type":"function","z":"9f161aad.b6b7b8","name":"get item","func":"msg.payload = {id: 1};\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":800,"wires":[["b2fe2051.88dc98"]]},{"id":"b2fe2051.88dc98","type":"mongodb in","z":"9f161aad.b6b7b8","mongodb":"b0c4e7bf.f27208","name":"find item","collection":"ventilation","operation":"find","x":530,"y":800,"wires":[["b090f583.f8138"]]},{"id":"b090f583.f8138","type":"function","z":"9f161aad.b6b7b8","name":"ready to send","func":"msg.payload = {data: msg.payload[0]};\nmsg.topic = '/ventilation/allstatus/response';\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":800,"wires":[["17798e84.df4c61"]]},{"id":"17798e84.df4c61","type":"link out","z":"9f161aad.b6b7b8","name":"","links":["1915fca2.839543"],"x":845,"y":800,"wires":[]},{"id":"245ced2e.e4c802","type":"modbus-flex-write","z":"9f161aad.b6b7b8","name":"change values","showStatusActivities":false,"showErrors":false,"server":"bab0b0b8.f47798","x":980,"y":1000,"wires":[[],[]]},{"id":"4f843c83.32d8bc","type":"function","z":"9f161aad.b6b7b8","name":"set modbus post params","func":"const isError = flow.get('error');\n\nif(isError) return;\n\nmsg.payload.fc = 6;\nmsg.payload.quantity = 1;\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":1000,"wires":[["245ced2e.e4c802"]]},{"id":"b4060943.6ae9d8","type":"function","z":"9f161aad.b6b7b8","name":"set ready to save","func":"msg.payload.id = 1;\nconst $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {id:1}};\nreturn newMsg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[["f3a77468.f20b38"]]},{"id":"a5f98ba2.9598","type":"function","z":"9f161aad.b6b7b8","name":"enable/disable","func":"if(msg.payload.value !== 0 && msg.payload.value !== 1) return;\n\nmsg.payload.address = 3;\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":1000,"wires":[["4f843c83.32d8bc"]]},{"id":"92d30cdf.0396c8","type":"function","z":"9f161aad.b6b7b8","name":"temperature","func":"msg.payload.value = Math.round(msg.payload.value);\n\nif(msg.payload.value < 5 && msg.payload.value > 34) return;\n\nmsg.payload.value = msg.payload.value * 10;\nmsg.payload.address = 1;\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1040,"wires":[["4f843c83.32d8bc"]]},{"id":"fbc87a41.523188","type":"function","z":"9f161aad.b6b7b8","name":"fan speed","func":"if((msg.payload.value < 15 && msg.payload.value > 100) || (msg.payload.value !== 15 && msg.payload.value%10 !== 0)) return;\n\nmsg.payload.value = msg.payload.value * 100;\nmsg.payload.address = 0;\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":1080,"wires":[["4f843c83.32d8bc"]]},{"id":"fc2ca352.da188","type":"mqtt in dynamic","z":"9f161aad.b6b7b8","topic":"/ventilation/setpower/request","qos":"1","name":"set power","broker":"e312d9ea.c89338","x":100,"y":1000,"wires":[["a5f98ba2.9598"]]},{"id":"d46f4c51.ef2d2","type":"mqtt in dynamic","z":"9f161aad.b6b7b8","topic":"/ventilation/settemperature/request","qos":"1","name":"set temperature","broker":"e312d9ea.c89338","x":120,"y":1040,"wires":[["92d30cdf.0396c8"]]},{"id":"644bda55.8d513c","type":"mqtt in dynamic","z":"9f161aad.b6b7b8","topic":"/ventilation/setfanspeed/request","qos":"1","name":"set fan speed","broker":"e312d9ea.c89338","x":120,"y":1080,"wires":[["fbc87a41.523188"]]},{"id":"7954775a.d06c7","type":"function","z":"9f161aad.b6b7b8","name":"get setted fan speed","func":"msg.topic = 'fan speed setted';\nmsg.payload.address = 0;\nmsg.payload.fc = 3;\nreturn msg;","outputs":1,"noerr":0,"x":371,"y":438,"wires":[["44f9c49a.1c89dc"]]},{"id":"da691650.3ddb3","type":"function","z":"9f161aad.b6b7b8","name":"fan speed setted","func":"const {data} = msg.payload;\nmsg.payload = {settedSpeed: data[0]/100};\nmsg.topic = '/ventilation/status/response';\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":440,"wires":[["33c51ba8.f7ce44","5ac08074.918c18"]]},{"id":"edb53ce7.4f6ef8","type":"function","z":"9f161aad.b6b7b8","name":"get setted temperature","func":"msg.topic = 'temperature setted';\nmsg.payload.address = 1;\nmsg.payload.fc = 3;\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":500,"wires":[["44f9c49a.1c89dc"]]},{"id":"ebf5aadc.258628","type":"function","z":"9f161aad.b6b7b8","name":"temperature setted","func":"const {data} = msg.payload;\nmsg.payload = {settedTemperature: data[0]/10};\nmsg.topic = '/ventilation/status/response';\n\nreturn msg;","outputs":1,"noerr":0,"x":1250,"y":320,"wires":[["33c51ba8.f7ce44","5ac08074.918c18"]]},{"id":"72798ba6.7ac72c","type":"link in","z":"d82282fe.72a6f","name":"update without create in db","links":["10186d63.2b72bb","ce9eba82.4dc79","55a8b86e.07314","92eb7753.80b22","a1c43ae8.bafe08","4d84ef64.735b18","9932ba00.d84eb"],"x":595,"y":720,"wires":[["9dfec221.c46078"]]},{"id":"f7309790.fd5fe","type":"mongodb out","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"update without create","collection":"zwave-nodes","payonly":false,"upsert":false,"multi":false,"operation":"update","x":1000,"y":720,"wires":[]},{"id":"89bf36fa.3b8ac","type":"link in","z":"d82282fe.72a6f","name":"update with create in db","links":["30afe4c4.212114","6d422b68.3208f4","12e28cef.d95be3"],"x":595,"y":780,"wires":[["3f06172f.a88a"]]},{"id":"da8d1b0d.76c958","type":"mongodb out","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"update with create","collection":"zwave-nodes","payonly":false,"upsert":true,"multi":false,"operation":"update","x":1010,"y":780,"wires":[]},{"id":"9dfec221.c46078","type":"function","z":"d82282fe.72a6f","name":"set ready to update","func":"const $set = {$set: msg.payload};\nconst query = msg.query ? msg.query : {nodeid: msg.payload.nodeid};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;","outputs":1,"noerr":0,"x":750,"y":720,"wires":[["f7309790.fd5fe"]]},{"id":"3f06172f.a88a","type":"function","z":"d82282fe.72a6f","name":"set ready to update","func":"const $set = {$set: msg.payload};\nconst newMsg = {payload: $set, query: {nodeid: msg.payload.nodeid}};\nreturn newMsg;","outputs":1,"noerr":0,"x":750,"y":780,"wires":[["da8d1b0d.76c958"]]},{"id":"10186d63.2b72bb","type":"link out","z":"d82282fe.72a6f","name":"","links":["72798ba6.7ac72c","82cc3504.c1f368"],"x":245,"y":940,"wires":[]},{"id":"19732583.39b242","type":"link in","z":"d82282fe.72a6f","name":"remove node from db","links":["d3a4455.cc2b838","4aa12319.3e7544","e38c23c3.f02ef8","aa3861bc.9b2d4"],"x":595,"y":840,"wires":[["ffb6008c.bf3e7"]]},{"id":"5a3d5933.3df47","type":"mongodb out","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"remove node","collection":"zwave-nodes","payonly":false,"upsert":false,"multi":false,"operation":"delete","x":970,"y":840,"wires":[]},{"id":"ffb6008c.bf3e7","type":"function","z":"d82282fe.72a6f","name":"remove from db","func":"if(msg.removeAll) {\n    msg.payload = {};\n} else if(msg.payload.nodeid != null) {\n    msg.payload = {nodeid: msg.payload.nodeid};\n} else {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":840,"wires":[["5a3d5933.3df47"]]},{"id":"d3a4455.cc2b838","type":"link out","z":"d82282fe.72a6f","name":"","links":["19732583.39b242"],"x":295,"y":760,"wires":[]},{"id":"4aa12319.3e7544","type":"link out","z":"d82282fe.72a6f","name":"","links":["19732583.39b242"],"x":475,"y":420,"wires":[]},{"id":"e38c23c3.f02ef8","type":"link out","z":"d82282fe.72a6f","name":"","links":["19732583.39b242"],"x":495,"y":320,"wires":[]},{"id":"15557928.7ad677","type":"link in","z":"d82282fe.72a6f","name":"set ready","links":["55186ea0.9fd0a8","d1ff4422.c2091"],"x":600,"y":920,"wires":[["547216ff.04ab7"]]},{"id":"55186ea0.9fd0a8","type":"link out","z":"d82282fe.72a6f","name":"","links":["15557928.7ad677"],"x":435,"y":360,"wires":[]},{"id":"d1ff4422.c2091","type":"link out","z":"d82282fe.72a6f","name":"","links":["15557928.7ad677"],"x":575,"y":40,"wires":[]},{"id":"ce9eba82.4dc79","type":"link out","z":"d82282fe.72a6f","name":"","links":["72798ba6.7ac72c","82cc3504.c1f368"],"x":815,"y":220,"wires":[]},{"id":"e9bf0d44.5266d","type":"function","z":"d82282fe.72a6f","name":"update value","func":"msg.query = {\n        nodeid: msg.payload.nodeid,\n        values: { \n            $elemMatch:{\n                value_id: msg.payload.value.value_id\n            }\n        }\n};\n\nmsg.payload = {\n    'values.$.value': msg.payload.value.value\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":180,"wires":[["a1c43ae8.bafe08"]]},{"id":"3e176af.5308996","type":"function","z":"d82282fe.72a6f","name":"compile node","func":"var obj = msg.payload;\n\nvar nodeId = 'node_' + obj.nodeid;\n\nvar nodeZ = context.get(nodeId);\nif(!nodeZ) {\n    nodeZ = {values:[]};\n}\n\nnodeZ.nodeid = obj.nodeid;\n\nif(obj.value) {\n    nodeZ.values.push(obj.value);\n}\n\nif(obj.nodeinfo) {\n    nodeZ.info = obj.nodeinfo;\n    node.send({payload: nodeZ});\n    context.set(nodeId, null);\n} else {\n    context.set(nodeId, nodeZ)\n}\n\nreturn;","outputs":1,"noerr":0,"x":490,"y":80,"wires":[["6b65236.e77745c"]]},{"id":"6d422b68.3208f4","type":"link out","z":"d82282fe.72a6f","name":"","links":["89bf36fa.3b8ac"],"x":815,"y":620,"wires":[]},{"id":"d281caae.6568b","type":"http request","z":"51445fb5.e4d8f8","name":"request work calendar","method":"GET","ret":"txt","paytoqs":false,"url":"https://data.gov.ru/api/json/dataset/7708660670-proizvcalendar/version/20151123T183036/content?access_token=c3e92173f53a0620bcad048f02b00efa","tls":"","persist":false,"proxy":"","authType":"","x":340,"y":460,"wires":[["58d3538d.1e879c"]]},{"id":"58d3538d.1e879c","type":"json","z":"51445fb5.e4d8f8","name":"","property":"payload","action":"","pretty":false,"x":530,"y":460,"wires":[["dbefce10.e55cc","48cdab0.605ca54"]]},{"id":"dbefce10.e55cc","type":"function","z":"51445fb5.e4d8f8","name":"get this and next year","func":"const thisYear = new Date().getFullYear();\n\nconst nextAndThisYear = msg.payload.filter(x=>{\n    return x[\"Год/Месяц\"] === thisYear.toString() || x[\"Год/Месяц\"] === (thisYear + 1).toString();\n})\nconst newMsg = {payload: nextAndThisYear};\n\nreturn newMsg;","outputs":1,"noerr":0,"x":740,"y":460,"wires":[["4b7d41b5.7b85b8"]]},{"id":"4b7d41b5.7b85b8","type":"function","z":"51445fb5.e4d8f8","name":"transform","func":"const documents = [];\n\nmsg.payload.forEach(x=>{\n    const yearDocument = [];\n    \n    yearDocument[0] = x[\"Январь\"].split(',');\n    yearDocument[1] = x[\"Февраль\"].split(',');\n    yearDocument[2] = x[\"Март\"].split(',');\n    yearDocument[3] = x[\"Апрель\"].split(',');\n    yearDocument[4] = x[\"Май\"].split(',');\n    yearDocument[5] = x[\"Июнь\"].split(',');\n    yearDocument[6] = x[\"Июль\"].split(',');\n    yearDocument[7] = x[\"Август\"].split(',');\n    yearDocument[8] = x[\"Сентябрь\"].split(',');\n    yearDocument[9] = x[\"Октябрь\"].split(',');\n    yearDocument[10] = x[\"Ноябрь\"].split(',');\n    yearDocument[11] = x[\"Декабрь\"].split(',');\n    \n    documents.push(yearDocument);\n});\n\nmsg.payload = documents;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":460,"wires":[["7833b08d.fc308"]]},{"id":"7833b08d.fc308","type":"split","z":"51445fb5.e4d8f8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":610,"y":560,"wires":[["8350e1ff.04b67"]]},{"id":"8350e1ff.04b67","type":"function","z":"51445fb5.e4d8f8","name":"transform for db","func":"const newMsg = {};\nconst thisYear = new Date().getFullYear();\n\nnewMsg.payload = {\n    year: msg.parts.index === 0 ? thisYear : thisYear + 1,\n    monthes: msg.payload\n}\n\nreturn newMsg;","outputs":1,"noerr":0,"x":780,"y":560,"wires":[["d052cbf6.004338"]]},{"id":"d052cbf6.004338","type":"function","z":"51445fb5.e4d8f8","name":"set ready to save","func":"const $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {year:msg.payload.year}};\nreturn newMsg;","outputs":1,"noerr":0,"x":1010,"y":560,"wires":[["4e96f229.95fac4","f0b6945b.44425"]]},{"id":"4e96f229.95fac4","type":"mongodb out","z":"51445fb5.e4d8f8","mongodb":"b0c4e7bf.f27208","name":"save to db","collection":"work-calendar","payonly":false,"upsert":true,"multi":false,"operation":"update","x":1210,"y":560,"wires":[]},{"id":"878fd92c.a21bd8","type":"function","z":"8f22b76d.1c6718","name":"transform for db","func":"msg.originalPayload = msg.payload ? msg.payload : {};\nconst thisYear = new Date().getFullYear();\n\nmsg.payload = {\n    year: thisYear\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":80,"wires":[["16f1d20e.6c9186"]]},{"id":"16f1d20e.6c9186","type":"mongodb in","z":"8f22b76d.1c6718","mongodb":"b0c4e7bf.f27208","name":"get this year","collection":"work-calendar","operation":"find","x":410,"y":80,"wires":[["33fde4a6.c2b2ac"]]},{"id":"33fde4a6.c2b2ac","type":"function","z":"8f22b76d.1c6718","name":"check if weekend","func":"const today = new Date();\nconst day = today.getDay();\nconst date = today.getDate();\nconst month = today.getMonth();\nconst year = today.getFullYear();\n\nconst thisYear = msg.payload[0];\n\nif(!thisYear) return;\n\nconst thisMonth = thisYear.monthes[month];\n\nconst isWeekend = (day === 6) || (day === 0);\n\n msg.payload = msg.originalPayload;\n\nif(isWeekend) {\n    const checkDay = date + '*';\n    if(thisMonth.some(x=>x===checkDay)) {\n        return [null, msg];\n    }\n}\n\n if(!thisMonth.some(x=>x===date.toString() || x === date + '+')) {\n     return [null, msg];\n }\n\nreturn [msg, null];","outputs":2,"noerr":0,"x":630,"y":80,"wires":[[],[]]},{"id":"f635b837.84734","type":"cron scheduler","z":"51445fb5.e4d8f8","name":"","schedule":"0 0 0 1 SEP *","x":120,"y":460,"wires":[["d281caae.6568b"]]},{"id":"5e169b87.d5e75c","type":"link out","z":"d82282fe.72a6f","name":"zwave out out","links":["e4ab262d.ab36c8","85854dfa.f88b28"],"x":855,"y":520,"wires":[]},{"id":"898c77ff.7f2a28","type":"function","z":"d82282fe.72a6f","name":"get associations","func":"msg.originalPayload = msg.payload;\nmsg.topic = 'getNumGroups';\nmsg.nodeid = msg.payload.nodeid;\nmsg.payload = {args: [msg.payload.nodeid]};\nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":80,"wires":[["6f88af81.5d4dc"]]},{"id":"6f88af81.5d4dc","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":1295,"y":80,"wires":[]},{"id":"e4ab262d.ab36c8","type":"link in","z":"d82282fe.72a6f","name":"","links":["5e169b87.d5e75c"],"x":815,"y":360,"wires":[["c6e1df9d.3afdf"]]},{"id":"32d7bc81.085a6c","type":"link out","z":"d82282fe.72a6f","name":"associations finish","links":["3a2fc6d1.8c5562"],"x":1435,"y":340,"wires":[]},{"id":"65e478af.58c1d8","type":"function","z":"d82282fe.72a6f","name":"process associations","func":"if(!msg.payload.result) \n{\n    msg.payload = msg.originalPayload;\n    return [msg, null, null, null];\n}\n\n\nconst groupLabelMsg = {topic: 'getGroupLabel', originalPayload: msg.originalPayload, payload: []};\nconst associationsMsg =  {topic: 'getAssociations', originalPayload: msg.originalPayload, payload: []};\nconst maxAssociationsMsg =  {topic: 'getMaxAssociations', originalPayload: msg.originalPayload, payload: []};\n\nfor(let i = 1; i <= msg.payload.result; i++) {\n    groupLabelMsg.payload.push({args: [msg.payload.args[0], i]});\n    associationsMsg.payload.push({args: [msg.payload.args[0], i]});\n    maxAssociationsMsg.payload.push({args: [msg.payload.args[0], i]});\n}\n\n\n\nreturn [null, groupLabelMsg, associationsMsg, maxAssociationsMsg];","outputs":4,"noerr":0,"x":1280,"y":440,"wires":[["32d7bc81.085a6c"],["ffc23303.19e89"],["ffc23303.19e89"],["ffc23303.19e89"]]},{"id":"f1dcd5fe.bc86","type":"function","z":"d82282fe.72a6f","name":"compile associations","func":"const nodeid = msg.nodeid;\nlet originalPayload = context.get('associations_'+nodeid);\nlet topicsCount = context.get('topics_'+nodeid);\n\nif(!originalPayload) {\n    originalPayload = msg.originalPayload;\n    originalPayload.associations = [];\n}\n\nif(!topicsCount) {\n    topicsCount = 0;\n}\n\nswitch(msg.topic) {\n    case 'getGroupLabel':\n    {   \n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].name = msg.payload.result;\n        break;\n    }\n    case 'getAssociations': \n    {\n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].associations = msg.payload.result;\n        break;\n    }\n    case 'getMaxAssociations': \n    {\n        topicsCount++;\n        if(!originalPayload.associations[msg.parts.index]) {\n            originalPayload.associations[msg.parts.index] = {};\n        }\n        originalPayload.associations[msg.parts.index].max = msg.payload.result;\n        break;\n    }\n    default:\n    return;\n}\n\ncontext.set('associations_'+nodeid, originalPayload);\ncontext.set('topics_'+nodeid, topicsCount);\n\nif(topicsCount === msg.parts.count * 3) {\n    context.set('associations_'+nodeid, undefined);\n    context.set('topics_'+nodeid, undefined);\n    msg.payload = originalPayload;\n    return msg;\n}","outputs":1,"noerr":0,"x":1280,"y":340,"wires":[["32d7bc81.085a6c"]]},{"id":"f19a27a8.90341","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":1615,"y":440,"wires":[]},{"id":"ffc23303.19e89","type":"split","z":"d82282fe.72a6f","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1510,"y":440,"wires":[["f19a27a8.90341"]]},{"id":"3a2fc6d1.8c5562","type":"link in","z":"d82282fe.72a6f","name":"","links":["32d7bc81.085a6c"],"x":655,"y":640,"wires":[["aebc840d.454aa8","6d422b68.3208f4"]]},{"id":"c6e1df9d.3afdf","type":"switch","z":"d82282fe.72a6f","name":"switch association topics","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"getGroupLabel","vt":"str"},{"t":"eq","v":"getAssociations","vt":"str"},{"t":"eq","v":"getMaxAssociations","vt":"str"},{"t":"eq","v":"getNumGroups","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":1010,"y":360,"wires":[["f1dcd5fe.bc86"],["f1dcd5fe.bc86"],["f1dcd5fe.bc86"],["65e478af.58c1d8"]]},{"id":"1772053b.98db23","type":"telegram sender","z":"97ace3bb.49fd58","name":"Send message","bot":"7fd9f3a.bc9e48c","x":660,"y":240,"wires":[["245cc027.8fc8b8"]]},{"id":"a1c43ae8.bafe08","type":"link out","z":"d82282fe.72a6f","name":"","links":["72798ba6.7ac72c","82cc3504.c1f368"],"x":715,"y":180,"wires":[]},{"id":"6b65236.e77745c","type":"function","z":"d82282fe.72a6f","name":"check db","func":"msg.originalPayload = msg.payload;\nmsg.payload = {nodeid: msg.originalPayload.nodeid};\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":80,"wires":[["ee55990f.0065d"]]},{"id":"ee55990f.0065d","type":"mongodb in","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":820,"y":80,"wires":[["ca44db77.bda7f8"]]},{"id":"ca44db77.bda7f8","type":"function","z":"d82282fe.72a6f","name":"filter if exists","func":"if(msg.payload.length > 0 && msg.payload[0]) return;\n\nmsg.payload = msg.originalPayload;\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":80,"wires":[["898c77ff.7f2a28"]]},{"id":"744d6d78.31c8e4","type":"function","z":"d82282fe.72a6f","name":"name changed","func":"const newMsg = {};\nnewMsg.topic = '/zwave/namechange/response';\nnewMsg.payload = msg.payload;\nreturn newMsg;","outputs":1,"noerr":0,"x":360,"y":980,"wires":[["e7031f5e.bd0a1"]]},{"id":"e7031f5e.bd0a1","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":505,"y":980,"wires":[]},{"id":"afd15f6e.0735d8","type":"telegram event","z":"97ace3bb.49fd58","name":"Callback","bot":"7fd9f3a.bc9e48c","event":"callback_query","autoanswer":false,"x":140,"y":460,"wires":[["5c79c312.7e0934"]]},{"id":"78efb41b.bfb62c","type":"function","z":"97ace3bb.49fd58","name":"transform","func":"const content = msg.cachedPayload.content;\nconst incomeOpts =  msg.cachedPayload.telegramOpts;\n\ndelete msg.cachedPayload.content;\ndelete msg.cachedPayload.telegramOpts;\n\nconst newPayload = {};\n\nconst opts = incomeOpts ? incomeOpts : {\n    reply_markup: JSON.stringify({\n        \"inline_keyboard\": [[{\n            \"text\": \"Ok\",\n            \"callback_data\": 'Ok'\n        },\n        {\n            \"text\": \"Cancel\",\n            \"callback_data\": 'Cancel'\n        }]]\n    })\n}\n\n\nnewPayload.type = 'message';\nnewPayload.chatId = '403702051';\nnewPayload.content = content;\nnewPayload.options = opts;\n\nmsg.payload = newPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":340,"wires":[["1772053b.98db23"]]},{"id":"245cc027.8fc8b8","type":"function","z":"97ace3bb.49fd58","name":"save msg id","func":"let msgId = flow.get('msgId');\nlet originalMsg = flow.get('original');\n\nmsgId = msg.payload.sentMessageId;\noriginalMsg = msg.cachedPayload;\n\nflow.set('msgId', msgId);\nflow.set('original', originalMsg);\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":240,"wires":[["8a19e7c6.6887d"]]},{"id":"5c79c312.7e0934","type":"function","z":"97ace3bb.49fd58","name":"check callback","func":"const msgId = flow.get('msgId');\nif(msgId !== msg.payload.messageId) return;\n\nconst originalMsg = flow.get('original');\n\nmsg.cachedPayload = originalMsg;\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":460,"wires":[["b879d684.5e5618","d88ba729.b97d98","8af919ab.9e27d"]]},{"id":"8a19e7c6.6887d","type":"stoptimer","z":"97ace3bb.49fd58","duration":"4","units":"Minute","payloadtype":"num","payloadval":"0","name":"delay","x":1070,"y":140,"wires":[["d88ba729.b97d98","66f55a40.3c22a4"],[]]},{"id":"b879d684.5e5618","type":"function","z":"97ace3bb.49fd58","name":"cancel delay","func":"const newMsg = {payload: 'stop'};\nreturn newMsg;","outputs":1,"noerr":0,"x":550,"y":140,"wires":[["8a19e7c6.6887d"]]},{"id":"d88ba729.b97d98","type":"function","z":"97ace3bb.49fd58","name":"update msg","func":"const newMsg = {payload: {}};\nnewMsg.payload.type = 'editMessageText';\nconst messageId =  msg.payload.sentMessageId ?  msg.payload.sentMessageId :  msg.payload.messageId;\nconst isCallbackMsg = !msg.payload.sentMessageId;\nlet contentText = msg.payload.sentMessageId ? msg.payload.content.text : msg.originalMessage.message.text;\n\ncontentText = `${contentText} - ${isCallbackMsg && msg.payload.content === 'Cancel' ? 'Отменено' : 'Выполнено'}`;\n\nnewMsg.payload.chatId = '403702051';\nnewMsg.payload.content = contentText;\n\nnewMsg.payload.options = {\n    chat_id : newMsg.payload.chatId,\n    message_id : messageId\n};  \n\nflow.set('msgId', undefined);\nflow.set('original', undefined);\n\nreturn newMsg;","outputs":1,"noerr":0,"x":790,"y":340,"wires":[["ecc5e093.73195"]]},{"id":"ecc5e093.73195","type":"telegram sender","z":"97ace3bb.49fd58","name":"update","bot":"7fd9f3a.bc9e48c","x":1050,"y":60,"wires":[[]]},{"id":"8af919ab.9e27d","type":"switch","z":"97ace3bb.49fd58","name":"select","property":"payload.content","propertyType":"msg","rules":[{"t":"eq","v":"Ok","vt":"str"},{"t":"eq","v":"Cancel","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":630,"y":460,"wires":[["66f55a40.3c22a4"],["d1d4b160.2e08f"],[]]},{"id":"66f55a40.3c22a4","type":"function","z":"97ace3bb.49fd58","name":"Ok result","func":"msg.payload = msg.cachedPayload;\nreturn msg;","outputs":1,"noerr":0,"x":1040,"y":360,"wires":[[]]},{"id":"d1d4b160.2e08f","type":"function","z":"97ace3bb.49fd58","name":"Cancel result","func":"msg.payload = msg.cachedPayload;\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":460,"wires":[[]]},{"id":"d1625137.7f18d8","type":"cron scheduler","z":"4a108442.009864","name":"night on","schedule":"0 5 23 * * *","x":360,"y":120,"wires":[["1e49f694.a34439"]]},{"id":"f31b2496.29941","type":"mqtt out dynamic","z":"4a108442.009864","name":"set temp","topic":"/ventilation/settemperature/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":220,"y":840,"wires":[]},{"id":"c7943821.234f88","type":"mqtt out dynamic","z":"4a108442.009864","name":"set fan","topic":"/ventilation/setfanspeed/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":210,"y":900,"wires":[]},{"id":"8bebb322.3ca118","type":"function","z":"4a108442.009864","name":"set fan speed","func":"return {\n    payload: 30\n}","outputs":1,"noerr":0,"x":1400,"y":120,"wires":[["3e666c80.2bda34"]]},{"id":"b7dbee93.89e2","type":"cron scheduler","z":"4a108442.009864","name":"normal mode","schedule":"0 55 6 * * *","x":870,"y":300,"wires":[["5c059a7d.7a8484"]]},{"id":"3e666c80.2bda34","type":"link out","z":"4a108442.009864","name":"","links":["f1d02c55.470488"],"x":1555,"y":120,"wires":[]},{"id":"3e4d8433.b8a33c","type":"link in","z":"4a108442.009864","name":"temp","links":["ca56910d.9de1a","5dfd907.be78a7","33989e98.a04d3a","6d67075b.8367e","f937fc05.f39f1"],"x":100,"y":840,"wires":[["f31b2496.29941"]]},{"id":"3fc6a335.d99c8c","type":"link in","z":"4a108442.009864","name":"fan","links":["e2ebb84f.bd6d3","b8a10bec.ddeec"],"x":100,"y":900,"wires":[["c7943821.234f88"]]},{"id":"e937a043.221c78","type":"function","z":"4a108442.009864","name":"set fan speed","func":"return {\n    payload: 20\n}","outputs":1,"noerr":0,"x":1680,"y":300,"wires":[["44c4e588.2d2874"]]},{"id":"44c4e588.2d2874","type":"link out","z":"4a108442.009864","name":"","links":["f1d02c55.470488"],"x":1815,"y":300,"wires":[]},{"id":"38c026b2.d3c5ea","type":"function","z":"4a108442.009864","name":"set fan speed","func":"return {\n    payload: 10\n}","outputs":1,"noerr":0,"x":1280,"y":400,"wires":[["bef3e21f.4bbdd"]]},{"id":"bef3e21f.4bbdd","type":"link out","z":"4a108442.009864","name":"","links":["f1d02c55.470488"],"x":1395,"y":400,"wires":[]},{"id":"b17da5b1.63a558","type":"cron scheduler","z":"ff9f5d72.eb6f2","name":"night on","schedule":"0 0 23 * * *","x":140,"y":120,"wires":[["6ca809de.4990a8"]]},{"id":"7804df9.f80e4a","type":"mqtt out dynamic","z":"ff9f5d72.eb6f2","name":"set temp","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":960,"y":40,"wires":[]},{"id":"6ca809de.4990a8","type":"function","z":"ff9f5d72.eb6f2","name":"disable","func":"const value = {\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nmsg.payload = [13, 18, 23].map(x=> \n({value: {...value, node_id: x}}));\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":120,"wires":[["84d53750.ae6b08"]]},{"id":"61ddff96.7233d","type":"cron scheduler","z":"ff9f5d72.eb6f2","name":"normal mode (weekday)","schedule":"0 30 6 * * *","x":190,"y":420,"wires":[["56f949a5.9533b8"]]},{"id":"e3c13df9.5af368","type":"link out","z":"ff9f5d72.eb6f2","name":"","links":["49348cef.06733c","c0382aa6.c634b"],"x":875,"y":180,"wires":[]},{"id":"49348cef.06733c","type":"link in","z":"ff9f5d72.eb6f2","name":"temp","links":["e3c13df9.5af368","54198a37.e521ec","63b0ecbd.d16a54","6d67075b.8367e","46a65d9b.ff3bdc","d6ce6b98.ff2558","90ed1e6e.3d1fb8","4f6c56d0.560958","fffd7f66.cc6a88"],"x":840,"y":40,"wires":[["7804df9.f80e4a"]]},{"id":"56f949a5.9533b8","type":"subflow:8f22b76d.1c6718","z":"ff9f5d72.eb6f2","name":"","x":410,"y":420,"wires":[[],["6c8769ac.e5004"]]},{"id":"84d53750.ae6b08","type":"split","z":"ff9f5d72.eb6f2","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":660,"y":120,"wires":[["3a068fb9.cd8b08"]]},{"id":"a558015.3c51a","type":"cron scheduler","z":"ff9f5d72.eb6f2","name":"normal mode (weekend)","schedule":"0 30 8 * * *","x":190,"y":480,"wires":[["2ddef686.fe0d1a"]]},{"id":"2ddef686.fe0d1a","type":"subflow:8f22b76d.1c6718","z":"ff9f5d72.eb6f2","name":"","x":410,"y":480,"wires":[["6c8769ac.e5004"],[]]},{"id":"e8f05113.ea47b8","type":"function","z":"ff9f5d72.eb6f2","name":"enable","func":"const value = {\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Energy Heat'\n    };\n\nmsg.payload = [13, 18, 23].map(x=> \n({value: {...value, node_id: x}}));\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":400,"wires":[["f3280cd0.3a4e88"]]},{"id":"46a65d9b.ff3bdc","type":"link out","z":"ff9f5d72.eb6f2","name":"","links":["49348cef.06733c","c0382aa6.c634b"],"x":1435,"y":400,"wires":[]},{"id":"f3280cd0.3a4e88","type":"split","z":"ff9f5d72.eb6f2","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1150,"y":400,"wires":[["1076c09d.88fc67"]]},{"id":"bc7b081b.99b918","type":"mqtt out dynamic","z":"93883042.bbe68","name":"set position","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1330,"y":80,"wires":[]},{"id":"3184e159.7495b6","type":"link in","z":"93883042.bbe68","name":"position","links":["9dff8cd7.d98b38","46bde2ae.ffc654","9da38239.6e301","291ca239.37eed6","8d0549a4.6fbf3","f248867.594dff8","cca425d4.d9f6e","9c30f59e.5cadf8","873d0b58.b03b28","184bad8f.03280a","5ccb0e56.e5faf","177311de.a9acbe","7ed56e69.6d4c28","271833c9.bb4934","676b4d6.fa7e334","5f21fc7c.f9cbac","abaf04c6.d83b18","87038291.bad8a8","ae9d158.c9552e8","e17b3df1.e8b0b"],"x":1175,"y":80,"wires":[["bc7b081b.99b918"]]},{"id":"c9b8c431.fe0fb","type":"function","z":"93883042.bbe68","name":"close all","func":"const value = {\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 0\n    };\n\nmsg.payload = [2, 11, 25].map(x=> \n({value: {...value, node_id: x}}));\n\nmsg.topic = undefined;\n\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":60,"wires":[["4decf42f.29dbdc"]]},{"id":"4decf42f.29dbdc","type":"split","z":"93883042.bbe68","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":700,"y":60,"wires":[["9dff8cd7.d98b38"]]},{"id":"9dff8cd7.d98b38","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":835,"y":60,"wires":[]},{"id":"69b7257c.b2b024","type":"subflow:8f22b76d.1c6718","z":"93883042.bbe68","name":"","x":270,"y":240,"wires":[[],["a64d29d1.11a35"]]},{"id":"40fdc5a8.c79764","type":"cron scheduler","z":"93883042.bbe68","name":"weekday vika","schedule":"0 50 6 * * *","x":100,"y":240,"wires":[["69b7257c.b2b024"]]},{"id":"9ac85561.93087","type":"subflow:97ace3bb.49fd58","z":"93883042.bbe68","name":"","env":[],"x":1710,"y":280,"wires":[["46bde2ae.ffc654","88550280.de9e4"],[],["238a8c16.c540ec"]]},{"id":"2fa77910.02730e","type":"function","z":"93883042.bbe68","name":"set message","func":"msg.payload.content = 'Поднять шторы?';\nmsg.payload.telegramOpts = {\n    reply_markup: JSON.stringify({\n        \"inline_keyboard\": [[{\n            \"text\": \"Открыть\",\n            \"callback_data\": 'Ok'\n        },\n        {\n            \"text\": \"Отмена\",\n            \"callback_data\": 'Cancel'\n        }], \n        [{\n            \"text\": \"Отложить на 30мин\",\n            \"callback_data\": 'Postpone'\n        }]]\n    })\n};\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":280,"wires":[["9ac85561.93087"]]},{"id":"46bde2ae.ffc654","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":1895,"y":220,"wires":[]},{"id":"9da38239.6e301","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":1495,"y":360,"wires":[]},{"id":"ff126ec6.d1151","type":"cron scheduler","z":"93883042.bbe68","name":"weekend","schedule":"0 0 11 * * *","x":100,"y":360,"wires":[["462b01db.4ec4b8"]]},{"id":"462b01db.4ec4b8","type":"subflow:8f22b76d.1c6718","z":"93883042.bbe68","name":"","x":290,"y":360,"wires":[["126aa53a.d228f3"],[]]},{"id":"238a8c16.c540ec","type":"delay","z":"93883042.bbe68","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1910,"y":280,"wires":[["2fa77910.02730e"]]},{"id":"c8c7c26f.f34ab","type":"mqtt in dynamic","z":"d93a928a.102338","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":130,"y":40,"wires":[["abcd9cc8.62c66"]]},{"id":"abcd9cc8.62c66","type":"switch","z":"d93a928a.102338","name":"is enter sensor?","property":"payload.node_id","propertyType":"msg","rules":[{"t":"eq","v":"36","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":40,"wires":[["dfd84967.d01698"],["1bbaa4cb.070c8b"]]},{"id":"1bbaa4cb.070c8b","type":"function","z":"d93a928a.102338","name":"is motion?","func":"if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 7) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":590,"y":100,"wires":[["b8a85653.1252"]]},{"id":"d681abe2.1ced","type":"function","z":"d93a928a.102338","name":"save door","func":"let data = global.get('door');\n\nif(data == null) {\n    data = {};\n}\n\n\ndata.value = msg.payload.value;\n\nconst now = new Date();\n\nif(data.value) {\n    data.lastOpenDate = now;\n} else {\n     data.lastCloseDate = now;\n}\n\ndata.statusChanged = now;\n\nglobal.set('door', data);\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":40,"wires":[["96e97999.8057b"]]},{"id":"dfd84967.d01698","type":"function","z":"d93a928a.102338","name":"is enter?","func":"if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":580,"y":40,"wires":[["d681abe2.1ced"]]},{"id":"b8a85653.1252","type":"function","z":"d93a928a.102338","name":"save motion","func":"const id = `motion_${msg.payload.node_id}`;\nlet data = global.get(id);\n\nif(!data) {\n    data = {};\n}\n\nconst now = new Date();\n\nif(msg.payload.value === 8) {\n    data.lastMotion = now;\n}\n\ndata.lastChange = now;\ndata.value = msg.payload.value === 8;\n\nglobal.set(id, data);\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":100,"wires":[["96e97999.8057b"]]},{"id":"96e97999.8057b","type":"function","z":"d93a928a.102338","name":"save presence and report","func":"let presence = global.get('presence');\nconst vacation = global.get('vacation');\n\nconst ble = flow.get('BLE');\nconst doorSensor = global.get('door');\nconst motionSensors = [3, 15, 29, 31, 33, 47, 48]\n        .map(x=>global.get(`motion_${x}`)).filter(x=>x != null);\n\nif(!presence && (ble || (doorSensor && doorSensor.value) || motionSensors.some(x=>x.value))) {\n    global.set('presence', true);\n    global.set('vacation', false);\n    flow.set('awayPending', false);\n    \n    return [{payload: {presence: true}}, null, null];\n}\n\nconst pending = flow.get('awayPending');\nif(pending && presence)\n{\n    flow.set('awayPending', false);\n    return [null, null, {payload: 'stop'}];\n}\n\n\nif(!pending && doorSensor && !vacation && presence && !ble && motionSensors.every(x=>!x.value)) {\n    const last = motionSensors.sort((a,b) => b.lastMotion - a.lastMotion)[0];\n    const doorClosedPeriod = doorSensor.lastCloseDate - doorSensor.lastOpenDate;\n    if(last.lastMotion <= doorSensor.lastCloseDate && doorClosedPeriod <= (60000 * 5)) {\n            flow.set('awayPending', true);\n            return [null, {payload: {presence: false}}, null];\n    }\n}\n\nreturn;","outputs":3,"noerr":0,"x":1010,"y":40,"wires":[["461e4afb.ef707c","1d7e811d.cc2367"],["938d56b2.2c4bc8"],["1d7e811d.cc2367"]]},{"id":"d2a48e22.c873a8","type":"subflow:97ace3bb.49fd58","z":"d93a928a.102338","name":"","env":[],"x":1450,"y":160,"wires":[["7454731.7ecd18c"],[],[]]},{"id":"7454731.7ecd18c","type":"function","z":"d93a928a.102338","name":"all out","func":"global.set('presence', false);\nflow.set('awayPending', false);\nreturn msg;","outputs":1,"noerr":0,"x":1650,"y":160,"wires":[["461e4afb.ef707c"]]},{"id":"461e4afb.ef707c","type":"mqtt out dynamic","z":"d93a928a.102338","name":"presence","topic":"/system/presence","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1740,"y":80,"wires":[]},{"id":"938d56b2.2c4bc8","type":"function","z":"d93a928a.102338","d":true,"name":"set message","func":"msg.payload.content = 'Похоже я остался один. Перехожу в режим \"Вне дома\"?';\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":160,"wires":[["ea654a7.2efadb8"]]},{"id":"c9cc33ff.8ca07","type":"function","z":"97ace3bb.49fd58","name":"cancel msgs","func":"const newMsg = {payload: {}};\n\nconst msgId = flow.get('msgId');\n\nflow.set('msgId', undefined);\nflow.set('original', undefined);\n\nif(msgId) {\n    const payload = {};\n    payload.type = 'deleteMessage';\n\n    payload.chatId = '403702051';\n    payload.content = msgId;\n\n    payload.options = {\n        chat_id : payload.chatId,\n        message_id : msgId\n    }; \n        \n    newMsg.payload = payload;\n    \n    return newMsg;\n}","outputs":1,"noerr":0,"x":510,"y":60,"wires":[["ecc5e093.73195"]]},{"id":"fdae9023.7d455","type":"switch","z":"97ace3bb.49fd58","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":170,"y":60,"wires":[["c9cc33ff.8ca07","b879d684.5e5618"],["eeae6682.7d5158"]]},{"id":"30cfcf41.1a099","type":"function","z":"ff9f5d72.eb6f2","name":"no one home","func":"if(msg.payload.presence === false || msg.payload.vacation) {\n    return {payload:{}};\n}\n\nreturn;","outputs":1,"noerr":0,"x":340,"y":60,"wires":[["6ca809de.4990a8"]]},{"id":"c3d231ef.bab4c","type":"mqtt in dynamic","z":"ff9f5d72.eb6f2","topic":"/system/presence","qos":"1","name":"presence event","broker":"e312d9ea.c89338","x":1280,"y":120,"wires":[["7240781b.97374"]]},{"id":"7240781b.97374","type":"link out","z":"ff9f5d72.eb6f2","name":"presence in","links":["b4110ce6.dc14d","c57c1538.866b3"],"x":1435,"y":120,"wires":[]},{"id":"b4110ce6.dc14d","type":"link in","z":"ff9f5d72.eb6f2","name":"","links":["7240781b.97374"],"x":160,"y":60,"wires":[["30cfcf41.1a099"]]},{"id":"e56d530.ecd1a3","type":"function","z":"ff9f5d72.eb6f2","name":"some one home","func":"if(msg.payload.presence) {\n    return {payload:{}};\n}\n\nreturn;","outputs":1,"noerr":0,"x":220,"y":340,"wires":[["cdce281e.8c2ea"]]},{"id":"c57c1538.866b3","type":"link in","z":"ff9f5d72.eb6f2","name":"","links":["7240781b.97374"],"x":90,"y":340,"wires":[["e56d530.ecd1a3"]]},{"id":"cdce281e.8c2ea","type":"subflow:8f22b76d.1c6718","z":"ff9f5d72.eb6f2","name":"","x":410,"y":340,"wires":[["e926acb0.7f2348"],["e06809e0.64731"]]},{"id":"2c72a98c.468ffe","type":"mqtt in dynamic","z":"4a108442.009864","topic":"/system/presence","qos":"1","name":"presence event","broker":"e312d9ea.c89338","x":160,"y":980,"wires":[["4c7a6a0c.656a7c"]]},{"id":"4c7a6a0c.656a7c","type":"link out","z":"4a108442.009864","name":"presence in","links":["9bfa4e0d.81f4d8","77a9777.bbdd208","a670a7d4.e2361"],"x":315,"y":980,"wires":[]},{"id":"e3810105.77d198","type":"function","z":"4a108442.009864","name":"no one home","func":"if(msg.payload.presence === false) {\n    return {payload:{}};\n}\n\nreturn;","outputs":1,"noerr":0,"x":230,"y":400,"wires":[["6417fee.2b6d2"]]},{"id":"9bfa4e0d.81f4d8","type":"link in","z":"4a108442.009864","name":"","links":["4c7a6a0c.656a7c"],"x":95,"y":400,"wires":[["e3810105.77d198"]]},{"id":"3c15b717.f925e8","type":"function","z":"4a108442.009864","name":"some one home","func":"if(msg.payload.presence) {\n    return {payload:{}};\n}\n\nreturn;","outputs":1,"noerr":0,"x":180,"y":220,"wires":[["8691ce28.43e508"]]},{"id":"77a9777.bbdd208","type":"link in","z":"4a108442.009864","name":"","links":["4c7a6a0c.656a7c"],"x":50,"y":220,"wires":[["3c15b717.f925e8"]]},{"id":"1e49f694.a34439","type":"function","z":"4a108442.009864","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":570,"y":120,"wires":[["8bebb322.3ca118"]]},{"id":"5c059a7d.7a8484","type":"function","z":"4a108442.009864","name":"some one home?","func":"if(global.get('presence')) {\n    return [msg, null];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"x":1050,"y":300,"wires":[["e937a043.221c78"],["bd67cd0e.f1bfb8"]]},{"id":"876d54dc.70e7e8","type":"time-range-switch","z":"4a108442.009864","name":"","lat":"","lon":"","startTime":"23:05","endTime":"06:55","startOffset":0,"endOffset":0,"x":1000,"y":220,"wires":[["8bebb322.3ca118"],["e937a043.221c78"]]},{"id":"e926acb0.7f2348","type":"time-range-switch","z":"ff9f5d72.eb6f2","name":"","lat":"","lon":"","startTime":"09:30","endTime":"23:00","startOffset":0,"endOffset":0,"x":640,"y":300,"wires":[["e8f05113.ea47b8"],[]]},{"id":"e06809e0.64731","type":"time-range-switch","z":"ff9f5d72.eb6f2","name":"","lat":"","lon":"","startTime":"06:30","endTime":"23:00","startOffset":0,"endOffset":0,"x":640,"y":360,"wires":[["e8f05113.ea47b8"],[]]},{"id":"5da4466e.10c608","type":"telegram command","z":"d93a928a.102338","name":"/away","command":"/away@YOUR_BOT","bot":"7fd9f3a.bc9e48c","strict":false,"x":1250,"y":220,"wires":[["6d1feaae.a918dc"],[]]},{"id":"6d1feaae.a918dc","type":"function","z":"d93a928a.102338","name":"transform away","func":"global.set('vacation', false);\nreturn {payload: {\n    presence: false\n}};","outputs":1,"noerr":0,"x":1460,"y":220,"wires":[["7454731.7ecd18c","e969a1e.f5525e"]]},{"id":"a64d29d1.11a35","type":"function","z":"93883042.bbe68","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":470,"y":240,"wires":[["96eb7e23.99e938"]]},{"id":"6c8769ac.e5004","type":"function","z":"ff9f5d72.eb6f2","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":670,"y":440,"wires":[["e8f05113.ea47b8"]]},{"id":"ee382737.992fa8","type":"cron scheduler","z":"ff9f5d72.eb6f2","name":"bathroom (weekday)","schedule":"0 30 8 * * *","x":180,"y":200,"wires":[["89d13514.5041b"]]},{"id":"89d13514.5041b","type":"subflow:8f22b76d.1c6718","z":"ff9f5d72.eb6f2","name":"","x":390,"y":200,"wires":[[],["287654ec.789a2c"]]},{"id":"287654ec.789a2c","type":"function","z":"ff9f5d72.eb6f2","name":"disable","func":"const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nmsg.payload = {value: value};\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":200,"wires":[["3a068fb9.cd8b08"]]},{"id":"2515d159.cd41ee","type":"function","z":"97ace3bb.49fd58","name":"cancel msgs","func":"const msgId = flow.get('msgId');\n\nif(msgId) {\n    const payload = {};\n    payload.type = 'deleteMessage';\n\n    payload.chatId = '403702051';\n    payload.content = msgId;\n\n    payload.options = {\n        chat_id : payload.chatId,\n        message_id : msgId\n    }; \n        \n    msg.payload = payload;\n   \n    \n    flow.set('msgId', undefined);\n    flow.set('original', undefined);\n    \n     return [msg, null];\n}\n\n\n\nreturn [null, msg];","outputs":2,"noerr":0,"x":330,"y":340,"wires":[["3ebdbb84.5ecfec"],["78efb41b.bfb62c"]]},{"id":"3ebdbb84.5ecfec","type":"telegram sender","z":"97ace3bb.49fd58","name":"remove","bot":"7fd9f3a.bc9e48c","x":440,"y":240,"wires":[["78efb41b.bfb62c"]]},{"id":"eeae6682.7d5158","type":"function","z":"97ace3bb.49fd58","name":"save payload","func":"msg.cachedPayload = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":150,"y":340,"wires":[["2515d159.cd41ee"]]},{"id":"ede0b265.c4e2a8","type":"function","z":"d82282fe.72a6f","name":"check zwave ready","func":"if(flow.get('ready')) {\n   return [msg, null]; \n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"x":700,"y":1040,"wires":[["855b1daa.33ae"],["be2ac85b.3bc078"]]},{"id":"be2ac85b.3bc078","type":"delay","z":"d82282fe.72a6f","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":930,"y":1040,"wires":[["ede0b265.c4e2a8"]]},{"id":"1d7e811d.cc2367","type":"function","z":"d93a928a.102338","name":"stop confirm","func":"msg.payload = 'stop';\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":80,"wires":[["d2a48e22.c873a8","ea654a7.2efadb8"]]},{"id":"e7bbb0d.61bb2d","type":"cron scheduler","z":"d93a928a.102338","d":true,"name":"every 24 h","schedule":"0 0 0/24 * * *","x":110,"y":240,"wires":[["603edda4.3e71cc"]]},{"id":"603edda4.3e71cc","type":"function","z":"d93a928a.102338","name":"away or vacation","func":"const presence = global.get('presence');\n\nconst motionSensors = [15, 16, 19, 29, 31, 33]\n        .map(x=>flow.get(`motion_${x}`)).filter(x=>x != null);\n\nconst last = motionSensors.sort((a,b) => a.lastMotion - b.lastMotion)[0];\n\nconst now = new Date();\n\nif((now - last) >= 86400000) {\n    if(presence) {\n        return [{},null];\n    } else {\n        return [null, {}];\n    }\n}\n","outputs":2,"noerr":0,"x":310,"y":240,"wires":[["be0c423c.faad68"],["86a65afe.9b81c"]]},{"id":"aa8655a.0b6a5a8","type":"link in","z":"d93a928a.102338","name":"presence","links":["be0c423c.faad68","f260c1d8.7f16a8"],"x":895,"y":160,"wires":[["938d56b2.2c4bc8"]]},{"id":"be0c423c.faad68","type":"link out","z":"d93a928a.102338","name":"","links":["aa8655a.0b6a5a8"],"x":455,"y":200,"wires":[]},{"id":"86a65afe.9b81c","type":"function","z":"d93a928a.102338","name":"vacation","func":"return {\n    payload: {\n        vacation: true,\n        content: 'Похоже вы в отпуске, ухожу в глубокий сон.'\n    }\n};","outputs":1,"noerr":0,"x":500,"y":280,"wires":[["dcad5256.ae9ff"]]},{"id":"dcad5256.ae9ff","type":"subflow:97ace3bb.49fd58","z":"d93a928a.102338","name":"","env":[],"x":690,"y":280,"wires":[["6756d62a.1ec93"],[],[]]},{"id":"a3179367.4b5c28","type":"mqtt out dynamic","z":"d93a928a.102338","name":"vacation","topic":"/system/vacation","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1060,"y":280,"wires":[]},{"id":"dd1b44c2.33a3f","type":"telegram command","z":"d93a928a.102338","name":"/vacation","command":"/vacation@YOUR_BOT","bot":"7fd9f3a.bc9e48c","strict":false,"x":440,"y":360,"wires":[["103e5c29.6dc94c"],[]]},{"id":"103e5c29.6dc94c","type":"function","z":"d93a928a.102338","name":"transform vacation","func":"return {payload: {\n    vacation: true\n}};","outputs":1,"noerr":0,"x":690,"y":340,"wires":[["6756d62a.1ec93"]]},{"id":"d26b7558.d83e08","type":"mqtt in dynamic","z":"ff9f5d72.eb6f2","topic":"/system/vacation","qos":"1","name":"vacation event","broker":"e312d9ea.c89338","x":1280,"y":180,"wires":[["7240781b.97374"]]},{"id":"cca865bf.ee2448","type":"mqtt in dynamic","z":"4a108442.009864","topic":"/system/vacation","qos":"1","name":"vacation event","broker":"e312d9ea.c89338","x":160,"y":1040,"wires":[["4c7a6a0c.656a7c"]]},{"id":"6756d62a.1ec93","type":"function","z":"d93a928a.102338","name":"set out","func":"global.set('vacation', true);\nglobal.set('presence', false);\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":280,"wires":[["a3179367.4b5c28"]]},{"id":"fad3b697.5ea058","type":"mqtt in dynamic","z":"93883042.bbe68","topic":"/system/vacation","qos":"1","name":"vacation event","broker":"e312d9ea.c89338","x":120,"y":120,"wires":[["3061ceb3.c8325a"]]},{"id":"87a3fa01.d35a9","type":"function","z":"93883042.bbe68","name":"check night","func":"if(msg.payload.night === false) return;\nreturn msg;","outputs":1,"noerr":0,"x":310,"y":60,"wires":[["c9b8c431.fe0fb"]]},{"id":"3061ceb3.c8325a","type":"function","z":"93883042.bbe68","name":"check vacation","func":"if(!msg.payload.vacation) return;\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":120,"wires":[["c9b8c431.fe0fb"]]},{"id":"a670a7d4.e2361","type":"link in","z":"4a108442.009864","name":"","links":["4c7a6a0c.656a7c"],"x":1175,"y":560,"wires":[["d0683d9b.1f029"]]},{"id":"d0683d9b.1f029","type":"function","z":"4a108442.009864","name":"check vacation","func":"if(msg.payload.vacation) {\n    return {\n        payload: {\n            value: 0\n        }\n    }\n}","outputs":1,"noerr":0,"x":1300,"y":560,"wires":[["c1cb2d60.34c288"]]},{"id":"c1cb2d60.34c288","type":"link out","z":"4a108442.009864","name":"","links":["a55aff8d.0c5e98"],"x":1415,"y":560,"wires":[]},{"id":"a55aff8d.0c5e98","type":"link in","z":"4a108442.009864","name":"power","links":["c1cb2d60.34c288","b59d9d8e.38fe28","9d73fb5a.4d2d78","6302b82f.55f76"],"x":95,"y":780,"wires":[["b346a895.a744e"]]},{"id":"b346a895.a744e","type":"mqtt out dynamic","z":"4a108442.009864","name":"power","topic":"/ventilation/setpower/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":205,"y":780,"wires":[]},{"id":"c5fcb39c.abafa","type":"function","z":"93883042.bbe68","name":"open vika","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":200,"wires":[["291ca239.37eed6","5b42709c.d72a28"]]},{"id":"68e9683f.fe8ab8","type":"function","z":"93883042.bbe68","name":"open livingroom","func":"const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":280,"wires":[["2fa77910.02730e"]]},{"id":"73e492b9.c02824","type":"function","z":"93883042.bbe68","name":"open kitchen","func":"const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":360,"wires":[["9da38239.6e301"]]},{"id":"291ca239.37eed6","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":1415,"y":200,"wires":[]},{"id":"96eb7e23.99e938","type":"function","z":"93883042.bbe68","name":"vika override","func":"if(!flow.get('vika_override'))\nreturn msg;","outputs":1,"noerr":0,"x":710,"y":260,"wires":[["603117a5.12526"]]},{"id":"916328a3.f349a","type":"function","z":"93883042.bbe68","name":"living room override","func":"if(!flow.get('livingroom_override'))\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":300,"wires":[["ba6edcbd.f672d"]]},{"id":"91d17d8.91c518","type":"telegram receiver","z":"93883042.bbe68","name":"all msgs","bot":"7fd9f3a.bc9e48c","saveDataDir":"","x":100,"y":500,"wires":[["4a088ea3.5cf2e"],[]]},{"id":"4a088ea3.5cf2e","type":"function","z":"93883042.bbe68","name":"parse message","func":"const text = msg.payload.content.toLowerCase();\nif(text.startsWith('вика шторы')) {\n    const match = text.match(/(\\d{1,2}(:| )\\d{1,2})/);\n    if(match && match.length > 1) {\n        return [{payload: {\n            time: match[1]\n        }}, null];\n    }\n}\n\nif(text.startsWith('зал шторы')) {\n    const match = text.match(/(\\d{1,2}(:| )\\d{1,2})/);\n    if(match && match.length > 1) {\n        return [null, {payload: {\n            time: match[1]\n        }}];\n    }\n}","outputs":2,"noerr":0,"x":280,"y":500,"wires":[["29e12c59.9b64dc"],["3b2b3194.2c21b6"]]},{"id":"29e12c59.9b64dc","type":"function","z":"93883042.bbe68","name":"parse time","func":"const split = msg.payload.time.split(/(:| )/).filter(x=>!Number.isNaN(Number(x))).map(x=>Number(x));\n\nif(split[0] < 0 || split[0] > 23) return;\nif(split[1] < 0 || split[1] > 59) return;\n\nflow.set('vika_override', true);\n\nreturn {\n    payload: {\n        schedule: `0 ${split[1]} ${split[0]} * * *`\n    }\n};","outputs":1,"noerr":0,"x":470,"y":460,"wires":[["6e254e5d.c11ab8","cc5a91b3.9ed0b"]]},{"id":"6e254e5d.c11ab8","type":"cron scheduler","z":"93883042.bbe68","name":"vika scheduler","schedule":"","x":680,"y":460,"wires":[["fbe1249f.781d18","603117a5.12526"]]},{"id":"fbe1249f.781d18","type":"function","z":"93883042.bbe68","name":"cancel","func":"flow.set('vika_override', false);\n\nreturn {\n    payload: {\n        cancel: true\n    }\n};","outputs":1,"noerr":0,"x":850,"y":460,"wires":[["6e254e5d.c11ab8"]]},{"id":"3b2b3194.2c21b6","type":"function","z":"93883042.bbe68","name":"parse time","func":"const split = msg.payload.time.split(/(:| )/).filter(x=>!Number.isNaN(Number(x))).map(x=>Number(x));\n\nif(split[0] < 0 || split[0] > 23) return;\nif(split[1] < 0 || split[1] > 59) return;\n\nflow.set('livingroom_override', true);\n\nreturn {\n    payload: {\n        schedule: `0 ${split[1]} ${split[0]} * * *`\n    }\n};","outputs":1,"noerr":0,"x":470,"y":540,"wires":[["cca9d087.ecedd8","cc5a91b3.9ed0b"]]},{"id":"cca9d087.ecedd8","type":"cron scheduler","z":"93883042.bbe68","name":"living room scheduler","schedule":"","x":700,"y":540,"wires":[["714bf598.032e44","ba6edcbd.f672d"]]},{"id":"714bf598.032e44","type":"function","z":"93883042.bbe68","name":"cancel","func":"flow.set('livingroom_override', false);\n\nreturn {\n    payload: {\n        cancel: true\n    }\n};","outputs":1,"noerr":0,"x":910,"y":540,"wires":[["cca9d087.ecedd8"]]},{"id":"6029317f.3ba4b","type":"telegram sender","z":"fdf44b03.831398","name":"msg","bot":"7fd9f3a.bc9e48c","x":340,"y":80,"wires":[[]]},{"id":"231cc159.27ce0e","type":"function","z":"fdf44b03.831398","name":"msg","func":"const content = msg.payload.content;\n\nconst newPayload = {};\n\nnewPayload.type = 'message';\nnewPayload.chatId = '403702051';\nnewPayload.content = content;\n\nmsg.payload = newPayload;\n\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":80,"wires":[["6029317f.3ba4b"]]},{"id":"869c208f.7c09a","type":"subflow:fdf44b03.831398","z":"93883042.bbe68","x":890,"y":640,"wires":[]},{"id":"cc5a91b3.9ed0b","type":"function","z":"93883042.bbe68","name":"telegram transform","func":"return {\n    payload: {\n        content: 'Действие подтверждено'\n    }\n}","outputs":1,"noerr":0,"x":690,"y":640,"wires":[["869c208f.7c09a"]]},{"id":"80886b8d.7089b","type":"function","z":"cd15286e.157c08","name":"get ventilation","func":"return {\n    payload: {\n        id: 1\n    },\n    cachedPayload: msg.payload\n};","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["d80cfd8b.80122"]]},{"id":"d80cfd8b.80122","type":"mongodb in","z":"cd15286e.157c08","mongodb":"b0c4e7bf.f27208","name":"find","collection":"ventilation","operation":"find","x":350,"y":80,"wires":[["1ee1a448.c539cc"]]},{"id":"1ee1a448.c539cc","type":"function","z":"cd15286e.157c08","name":"vent result","func":"msg.payload = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":80,"wires":[[]]},{"id":"8691ce28.43e508","type":"subflow:cd15286e.157c08","z":"4a108442.009864","x":400,"y":220,"wires":[["3bc00883.552e78"]]},{"id":"3bc00883.552e78","type":"function","z":"4a108442.009864","name":"is enabled","func":"if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];","outputs":2,"noerr":0,"x":630,"y":220,"wires":[["876d54dc.70e7e8"],["b0b085b8.ef0d28"]]},{"id":"b0b085b8.ef0d28","type":"function","z":"4a108442.009864","name":"power on","func":" return {\n        payload: {\n            value: 1\n        }\n    }\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":280,"wires":[["b59d9d8e.38fe28","1930e303.c87f4d"]]},{"id":"b59d9d8e.38fe28","type":"link out","z":"4a108442.009864","name":"","links":["a55aff8d.0c5e98"],"x":755,"y":260,"wires":[]},{"id":"1930e303.c87f4d","type":"delay","z":"4a108442.009864","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":620,"y":340,"wires":[["876d54dc.70e7e8"]]},{"id":"9b529d8c.771dd8","type":"delay","z":"4a108442.009864","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":680,"y":520,"wires":[["38c026b2.d3c5ea"]]},{"id":"f3d79778.0bcb88","type":"function","z":"4a108442.009864","name":"power on","func":" return {\n        payload: {\n            value: 1\n        }\n    }\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":460,"wires":[["9d73fb5a.4d2d78","9b529d8c.771dd8"]]},{"id":"9d73fb5a.4d2d78","type":"link out","z":"4a108442.009864","name":"","links":["a55aff8d.0c5e98"],"x":815,"y":440,"wires":[]},{"id":"70513737.4ab24","type":"function","z":"4a108442.009864","name":"is enabled","func":"if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];","outputs":2,"noerr":0,"x":690,"y":400,"wires":[["38c026b2.d3c5ea"],["f3d79778.0bcb88"]]},{"id":"6417fee.2b6d2","type":"subflow:cd15286e.157c08","z":"4a108442.009864","x":460,"y":400,"wires":[["70513737.4ab24"]]},{"id":"f1d02c55.470488","type":"link in","z":"4a108442.009864","name":"set fan speed","links":["3e666c80.2bda34","44c4e588.2d2874","bef3e21f.4bbdd","4e1280c1.de6918"],"x":1080,"y":780,"wires":[["f7452808.5fb9b8"]]},{"id":"f7452808.5fb9b8","type":"function","z":"4a108442.009864","name":"set fan speed","func":"return {\n    payload: {\n        value: msg.payload\n    }\n};","outputs":1,"noerr":0,"x":1200,"y":780,"wires":[["b1db395f.ff3a9","b8a10bec.ddeec"]]},{"id":"b1db395f.ff3a9","type":"switch","z":"4a108442.009864","name":"select temperature","property":"payload.value","propertyType":"msg","rules":[{"t":"gte","v":"30","vt":"num"},{"t":"eq","v":"20","vt":"str"},{"t":"lt","v":"20","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":1430,"y":780,"wires":[["d76fd4d0.ab52a"],["154d640f.511004"],["c682e263.426f08"]]},{"id":"b8a10bec.ddeec","type":"link out","z":"4a108442.009864","name":"","links":["3fc6a335.d99c8c"],"x":1275,"y":840,"wires":[]},{"id":"d76fd4d0.ab52a","type":"function","z":"4a108442.009864","name":"set temperature","func":"msg.payload = {};\nmsg.payload.value = 12;\n\nreturn msg;","outputs":1,"noerr":0,"x":1640,"y":740,"wires":[["f937fc05.f39f1"]]},{"id":"154d640f.511004","type":"function","z":"4a108442.009864","name":"set temperature","func":"msg.payload = {};\nmsg.payload.value = 10;\n\nreturn msg;","outputs":1,"noerr":0,"x":1640,"y":780,"wires":[["f937fc05.f39f1"]]},{"id":"c682e263.426f08","type":"function","z":"4a108442.009864","name":"set temperature","func":"msg.payload = {};\nmsg.payload.value = 5;\n\nreturn msg;","outputs":1,"noerr":0,"x":1640,"y":820,"wires":[["f937fc05.f39f1"]]},{"id":"f937fc05.f39f1","type":"link out","z":"4a108442.009864","name":"","links":["3e4d8433.b8a33c"],"x":1795,"y":780,"wires":[]},{"id":"eee0884c.66d68","type":"function","z":"9f161aad.b6b7b8","name":"consumption","func":"const newMsg = {\n    measurement: 'ventilation',\n    payload: []\n};\n\nconst field = {value: msg.payload.value};\nconst tag = {};\n\nif(msg.topic === 'fan consumption') {\n    tag.type = 'fan';\n} else {\n    tag.type = 'ten';\n}\n\nnewMsg.payload[0] = field;\nnewMsg.payload[1] = tag;\n\nreturn newMsg;","outputs":1,"noerr":0,"x":1730,"y":560,"wires":[[]]},{"id":"fa780afc.d295e","type":"influxdb out","z":"9f161aad.b6b7b8","influxdb":"d47f185f.a8541","name":"save to influx","measurement":"","precision":"","retentionPolicy":"","x":1910,"y":560,"wires":[]},{"id":"d4d1b099.26b188","type":"mqtt in dynamic","z":"2708f35f.d8411c","topic":"/zwave/changevalue/response","qos":"1","name":"value changed","broker":"e312d9ea.c89338","x":120,"y":60,"wires":[["5a8a611e.e685a"]]},{"id":"5a8a611e.e685a","type":"function","z":"2708f35f.d8411c","name":"is sensors?","func":"if([3].some(x=>msg.payload.node_id === x))\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":60,"wires":[["f47b246c.a08478","c5942149.899098","82d45be9.e1ade"]]},{"id":"f47b246c.a08478","type":"function","z":"2708f35f.d8411c","name":"is temperature?","func":"if(msg.payload.value_id === `${msg.payload.node_id}-49-1-1`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'temperature'\n            }\n        }\n    }\n}","outputs":1,"noerr":0,"x":540,"y":60,"wires":[["200fe8ab.e477b8"]]},{"id":"28db7245.d468d6","type":"influxdb out","z":"2708f35f.d8411c","influxdb":"d47f185f.a8541","name":"save influx","measurement":"","precision":"","retentionPolicy":"","x":1150,"y":60,"wires":[]},{"id":"a2fc38e.35416c8","type":"function","z":"2708f35f.d8411c","name":"add measurement","func":"const tags = msg.payload.tags;\nmsg.measurement = 'sensors';\nmsg.payload = [{\n            value: Number(msg.payload.value)\n        }];\n        \n        msg.payload[1] = tags;\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":60,"wires":[["28db7245.d468d6"]]},{"id":"c5942149.899098","type":"function","z":"2708f35f.d8411c","name":"is humidity?","func":"if(msg.payload.value_id === `${msg.payload.node_id}-49-1-5`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'humidity'\n            }\n        }\n    }\n}","outputs":1,"noerr":0,"x":530,"y":100,"wires":[["200fe8ab.e477b8"]]},{"id":"82d45be9.e1ade","type":"function","z":"2708f35f.d8411c","name":"is luminance?","func":"if(msg.payload.value_id === `${msg.payload.node_id}-49-1-3`)\n{\n    return {\n        payload: {\n            value: msg.payload.value,\n            nodeid: msg.payload.node_id,\n            tags: {\n                type: 'luminance'\n            }\n        }\n    }\n}","outputs":1,"noerr":0,"x":540,"y":140,"wires":[["200fe8ab.e477b8"]]},{"id":"200fe8ab.e477b8","type":"function","z":"2708f35f.d8411c","name":"place type","func":"const nodeid = msg.payload.nodeid;\n\nif(nodeid === 3) {\n    msg.payload.tags.place = 'hall';\n}\n\nif(nodeid === 46) {\n    msg.payload.tags.place = 'bathroom';\n}\n\nif(nodeid === 29) {\n    msg.payload.tags.place = 'kitchen';\n}\n\nif(nodeid === 31) {\n    msg.payload.tags.place = 'living';\n}\n\nif(nodeid === 33) {\n    msg.payload.tags.place = 'vika';\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":60,"wires":[["a2fc38e.35416c8"]]},{"id":"66b77f1f.1b0e78","type":"mongodb in","z":"9ae1a772.3c7408","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":340,"y":80,"wires":[["160ba9d0.14edb6"]]},{"id":"1306de92.ae96c9","type":"function","z":"9ae1a772.3c7408","name":"check db","func":"msg.payload = {nodeid: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["66b77f1f.1b0e78"]]},{"id":"160ba9d0.14edb6","type":"function","z":"9ae1a772.3c7408","name":"check should up","func":"if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-38-1-0`);\n    if(value != null && value.value === 0) {\n        return [msg, null];\n    }\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"x":500,"y":80,"wires":[[],[]]},{"id":"a8fb01f9.e24e08","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","x":1120,"y":300,"wires":[["68e9683f.fe8ab8"],["4a49e5aa.d6eb3c"]]},{"id":"ba6edcbd.f672d","type":"function","z":"93883042.bbe68","name":"check living","func":"return {\n    payload: 11\n}","outputs":1,"noerr":0,"x":930,"y":300,"wires":[["a8fb01f9.e24e08"]]},{"id":"a049200.e3ff7e","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","x":1160,"y":340,"wires":[["73e492b9.c02824"],[]]},{"id":"eee3de9e.6a94d","type":"function","z":"93883042.bbe68","name":"check kitchen","func":"return {\n    payload: 25\n}","outputs":1,"noerr":0,"x":940,"y":360,"wires":[["a049200.e3ff7e"]]},{"id":"e36bd9b9.b50358","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","name":"","env":[],"x":1120,"y":260,"wires":[["c5fcb39c.abafa"],["39942913.db7536"]]},{"id":"603117a5.12526","type":"function","z":"93883042.bbe68","name":"check vika","func":"return {\n    payload: 2\n}","outputs":1,"noerr":0,"x":890,"y":260,"wires":[["e36bd9b9.b50358"]]},{"id":"6302b82f.55f76","type":"link out","z":"4a108442.009864","name":"","links":["a55aff8d.0c5e98"],"x":1775,"y":340,"wires":[]},{"id":"2c53f66c.15836a","type":"function","z":"4a108442.009864","name":"power off","func":" return {\n        payload: {\n            value: 0\n        }\n    }\nreturn msg;","outputs":1,"noerr":0,"x":1660,"y":340,"wires":[["6302b82f.55f76"]]},{"id":"d41b3a23.9c36e8","type":"function","z":"4a108442.009864","name":"is enabled","func":"if(msg.payload.enabled) {\n    return [{payload: msg.cachedPayload}, null];\n}\nreturn [null, {payload: {}}];","outputs":2,"noerr":0,"x":1510,"y":340,"wires":[[],["2c53f66c.15836a"]]},{"id":"bd67cd0e.f1bfb8","type":"subflow:cd15286e.157c08","z":"4a108442.009864","name":"","env":[],"x":1280,"y":340,"wires":[["d41b3a23.9c36e8"]]},{"id":"d7d35584.4a561","type":"link out","z":"d82282fe.72a6f","name":"","links":["a2281af3.764448"],"x":355,"y":40,"wires":[]},{"id":"a2281af3.764448","type":"link in","z":"d82282fe.72a6f","name":"enable pooling","links":["d7d35584.4a561"],"x":65,"y":1220,"wires":[["7d01b6e5.3ca79"]]},{"id":"7d01b6e5.3ca79","type":"function","z":"d82282fe.72a6f","name":"get all nodes","func":"return {\n    payload: {}\n}","outputs":1,"noerr":0,"x":200,"y":1220,"wires":[["5e5ecac4.f2dff4"]]},{"id":"5e5ecac4.f2dff4","type":"mongodb in","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"get nodes","collection":"zwave-nodes","operation":"find","x":350,"y":1220,"wires":[["6c81eb71.098f6c"]]},{"id":"6c81eb71.098f6c","type":"function","z":"d82282fe.72a6f","name":"filter 38  and 37","func":"let values = msg.payload\n.map(x=>x.values.filter(x=>(x.class_id === 38 || x.class_id === 37) && x.index === 0));\n\nvalues = [].concat.apply([], values);\n\nreturn{\n    payload: values\n}","outputs":1,"noerr":0,"x":530,"y":1220,"wires":[["72ec58ef.7f504"]]},{"id":"72ec58ef.7f504","type":"function","z":"d82282fe.72a6f","name":"create pooling","func":"msg.payload.forEach(x=>{\n   const newMsg = {};\n   newMsg.topic = 'enablePoll';\n   newMsg.payload = {\n       args: [x, 1]\n   }\n   \n   node.send(newMsg);\n});","outputs":1,"noerr":0,"x":730,"y":1220,"wires":[["aeca2828.fd8788"]]},{"id":"aeca2828.fd8788","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":885,"y":1220,"wires":[]},{"id":"2f31cba9.61eafc","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/addassociation/request","qos":"1","name":"add association in","broker":"e312d9ea.c89338","x":130,"y":1360,"wires":[["8f9f1eb8.6f23b8"]]},{"id":"8f9f1eb8.6f23b8","type":"function","z":"d82282fe.72a6f","name":"transform","func":"const payload = msg.payload;\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\nconst args1 =  [0, payload.nodeid, payload.group, payload.targetid];\n\nreturn {\n    topic: 'addAssociation',\n    payload: {\n        args: args\n//        args: args1\n    }\n}","outputs":1,"noerr":0,"x":310,"y":1360,"wires":[["aece5505.3a1","57e8e943.88d04"]]},{"id":"aece5505.3a1","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":435,"y":1300,"wires":[]},{"id":"88d59a2e.6eb858","type":"function","z":"d82282fe.72a6f","name":"get associations","func":"msg.topic = 'getAssociations';\nmsg.payload = {args: [msg.payload.args[0], msg.payload.args[1]]};\n//msg.payload = {args: [msg.payload.args[0], msg.payload.args[1], msg.payload.args[2]]};\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":1360,"wires":[["e8a3f9c6.2ddb2","c83f577.532e528"]]},{"id":"57e8e943.88d04","type":"delay","z":"d82282fe.72a6f","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":490,"y":1360,"wires":[["88d59a2e.6eb858"]]},{"id":"e8a3f9c6.2ddb2","type":"zwave-out","z":"d82282fe.72a6f","name":"zwave out","controller":"77f89cfa.c3377c","x":820,"y":1360,"wires":[["3cbde36a.9d143c","b866128c.480748","7d0939f7.fd9b2"]]},{"id":"3cbde36a.9d143c","type":"function","z":"d82282fe.72a6f","name":"transform to db","func":"msg.query = {\n        nodeid: msg.payload.args[0],\n};\n\nconst result = msg.payload.result;\nconst name = `associations.${msg.payload.args[1] - 1}.associations`;\n\nmsg.payload = {};\nmsg.payload[name] = result;\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":1360,"wires":[["4d84ef64.735b18"]]},{"id":"b866128c.480748","type":"function","z":"d82282fe.72a6f","name":"transform to ui","func":"return {\n    topic: '/zwave/associationsupdate/response',\n    payload: {\n        nodeid: msg.payload.args[0],\n        group: msg.payload.args[1] - 1,\n        targetids: msg.payload.result\n    }\n};","outputs":1,"noerr":0,"x":1000,"y":1400,"wires":[["39971fdf.4f6398"]]},{"id":"39971fdf.4f6398","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":1155,"y":1400,"wires":[]},{"id":"4d84ef64.735b18","type":"link out","z":"d82282fe.72a6f","name":"","links":["72798ba6.7ac72c","82cc3504.c1f368"],"x":1155,"y":1360,"wires":[]},{"id":"1fc50465.ca1d74","type":"link out","z":"d82282fe.72a6f","name":"","links":["b1d47c39.dad518"],"x":455,"y":1440,"wires":[]},{"id":"a2c3176f.35b6","type":"function","z":"d82282fe.72a6f","name":"transform","func":"const payload = msg.payload;\n\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\nreturn {\n    topic: 'removeAssociation',\n    payload: {\n        args: args\n    }\n}","outputs":1,"noerr":0,"x":340,"y":1440,"wires":[["1fc50465.ca1d74","57e8e943.88d04"]]},{"id":"b78085e4.82b83","type":"mqtt in dynamic","z":"d82282fe.72a6f","topic":"/zwave/removeassociation/request","qos":"1","name":"remove association in","broker":"e312d9ea.c89338","x":150,"y":1440,"wires":[["a2c3176f.35b6"]]},{"id":"cce0606f.a671a8","type":"telegram command","z":"d93a928a.102338","name":"/warmup","command":"/warmup@YOUR_BOT","bot":"7fd9f3a.bc9e48c","strict":false,"x":370,"y":900,"wires":[["4b95d5c.954b8ac","8eb0b923.790db8"],[]]},{"id":"4b95d5c.954b8ac","type":"function","z":"d93a928a.102338","name":"transform warmup","func":"return {payload: {\n    warmup: true\n}};","outputs":1,"noerr":0,"x":610,"y":900,"wires":[["ff04f0e4.df116"]]},{"id":"ff04f0e4.df116","type":"function","z":"d93a928a.102338","name":"set out","func":"global.set('vacation', false);\nglobal.set('presence', false);\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":900,"wires":[["4ae2a5f5.9ebc54"]]},{"id":"4ae2a5f5.9ebc54","type":"mqtt out dynamic","z":"d93a928a.102338","name":"warmup","topic":"/system/warmup","qos":"1","retain":"","broker":"e312d9ea.c89338","x":980,"y":900,"wires":[]},{"id":"c0c1cc78.a5f6c","type":"mqtt in dynamic","z":"93883042.bbe68","topic":"/system/warmup","qos":"1","name":"warmup in","broker":"e312d9ea.c89338","x":260,"y":980,"wires":[["9a7141bd.83ef68"]]},{"id":"763a9f51.ad75f8","type":"function","z":"93883042.bbe68","name":"open kitchen","func":"const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":1020,"wires":[["cca425d4.d9f6e"]]},{"id":"8a572bf8.130ae","type":"function","z":"93883042.bbe68","name":"open livingroom","func":"const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":980,"wires":[["f248867.594dff8"]]},{"id":"2ad3b43a.57a0ec","type":"function","z":"93883042.bbe68","name":"open vika","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":940,"wires":[["8d0549a4.6fbf3"]]},{"id":"9a7141bd.83ef68","type":"function","z":"93883042.bbe68","name":"is day","func":"flow.set('vika_override', false);\nflow.set('livingroom_override', false);\n\nif(!global.get('isNight'))\n    return msg;","outputs":1,"noerr":0,"x":430,"y":980,"wires":[["2ad3b43a.57a0ec","8a572bf8.130ae","763a9f51.ad75f8"]]},{"id":"8d0549a4.6fbf3","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":815,"y":940,"wires":[]},{"id":"f248867.594dff8","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":815,"y":980,"wires":[]},{"id":"cca425d4.d9f6e","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":815,"y":1020,"wires":[]},{"id":"2a884112.f1d106","type":"mqtt in dynamic","z":"4a108442.009864","topic":"/system/warmup","qos":"1","name":"warmup in","broker":"e312d9ea.c89338","x":150,"y":1100,"wires":[["b11cbf2f.bf2ca"]]},{"id":"593d03fc.d814f4","type":"link in","z":"4a108442.009864","name":"warmup","links":["b11cbf2f.bf2ca"],"x":235,"y":160,"wires":[["8691ce28.43e508"]]},{"id":"b11cbf2f.bf2ca","type":"link out","z":"4a108442.009864","name":"","links":["593d03fc.d814f4"],"x":275,"y":1100,"wires":[]},{"id":"581a9561.638d24","type":"mqtt in dynamic","z":"ff9f5d72.eb6f2","topic":"/system/warmup","qos":"1","name":"warmup in","broker":"e312d9ea.c89338","x":1270,"y":240,"wires":[["df308619.91348"]]},{"id":"df308619.91348","type":"link out","z":"ff9f5d72.eb6f2","name":"","links":["d8c57cf0.b0ba88"],"x":1395,"y":240,"wires":[]},{"id":"d8c57cf0.b0ba88","type":"link in","z":"ff9f5d72.eb6f2","name":"warmup","links":["df308619.91348"],"x":295,"y":280,"wires":[["cdce281e.8c2ea"]]},{"id":"cf6e83c1.42b31","type":"subflow:fdf44b03.831398","z":"d93a928a.102338","name":"","x":840,"y":1000,"wires":[]},{"id":"8eb0b923.790db8","type":"function","z":"d93a928a.102338","name":"telegram transform","func":"return {\n    payload: {\n        content: 'Начинаю прогрев'\n    }\n}","outputs":1,"noerr":0,"x":630,"y":1000,"wires":[["cf6e83c1.42b31"]]},{"id":"e280c80f.037a9","type":"mqtt in dynamic","z":"98f6b4ab.de8e9","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":150,"y":80,"wires":[["85bd7bea.2eb5c8"]]},{"id":"c3b0ee8e.2e4d","type":"switch","z":"98f6b4ab.de8e9","name":"switch sensors","property":"payload.node_id","propertyType":"msg","rules":[{"t":"eq","v":"37","vt":"num"},{"t":"eq","v":"38","vt":"str"},{"t":"eq","v":"40","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":600,"y":80,"wires":[["f47b6699.fbd1c8"],["56341d7c.b013d4"],["f4d609ec.7516b8"]]},{"id":"ea8c4fe9.6ae1e","type":"cron scheduler","z":"98f6b4ab.de8e9","name":"check up time","schedule":"0 0 4 1/14 * *","x":140,"y":360,"wires":[["a92e447f.4395e"]]},{"id":"df600c55.57e968","type":"mqtt out dynamic","z":"98f6b4ab.de8e9","name":"set zwave out","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1660,"y":60,"wires":[]},{"id":"3e3741a0.e8854e","type":"link in","z":"98f6b4ab.de8e9","name":"zwave out","links":["c66789d7.a13cd8","1c6b55d9.0e10b2"],"x":1520,"y":60,"wires":[["df600c55.57e968"]]},{"id":"33c79c34.988f64","type":"function","z":"98f6b4ab.de8e9","name":"close valve","func":"const value = {\n        node_id: 20,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":360,"wires":[["c66789d7.a13cd8"]]},{"id":"c66789d7.a13cd8","type":"link out","z":"98f6b4ab.de8e9","name":"","links":["3e3741a0.e8854e"],"x":935,"y":360,"wires":[]},{"id":"8ab11c85.7ef0e8","type":"delay","z":"98f6b4ab.de8e9","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":800,"y":420,"wires":[["ead907a2.0cbce"]]},{"id":"ead907a2.0cbce","type":"function","z":"98f6b4ab.de8e9","name":"open valve","func":"const value = {\n        node_id: 20,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":420,"wires":[["1c6b55d9.0e10b2"]]},{"id":"1c6b55d9.0e10b2","type":"link out","z":"98f6b4ab.de8e9","name":"","links":["3e3741a0.e8854e"],"x":1075,"y":420,"wires":[]},{"id":"e38e044b.cbd4c8","type":"subflow:fdf44b03.831398","z":"98f6b4ab.de8e9","name":"","x":1660,"y":160,"wires":[]},{"id":"f47b6699.fbd1c8","type":"function","z":"98f6b4ab.de8e9","name":"telegram transform (bath)","func":"return {\n    payload: {\n        content: 'Протечка под раковинной в ванной'\n    }\n}","outputs":1,"noerr":0,"x":830,"y":60,"wires":[["c5d77726.e22a2"]]},{"id":"d5d4f350.794e8","type":"link in","z":"98f6b4ab.de8e9","name":"send msg","links":["c5d77726.e22a2","2e2a0e7d.48238a","3b24c4d2.de2d14"],"x":1535,"y":160,"wires":[["e38e044b.cbd4c8"]]},{"id":"85bd7bea.2eb5c8","type":"function","z":"98f6b4ab.de8e9","name":"check leak signal","func":"if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value === true) {\n    return msg;\n}\n\nreturn;\n","outputs":1,"noerr":0,"x":390,"y":80,"wires":[["c3b0ee8e.2e4d"]]},{"id":"56341d7c.b013d4","type":"function","z":"98f6b4ab.de8e9","name":"telegram transform (kitchen)","func":"return {\n    payload: {\n        content: 'Протечка под раковинной в кухне'\n    }\n}","outputs":1,"noerr":0,"x":840,"y":100,"wires":[["2e2a0e7d.48238a"]]},{"id":"c5d77726.e22a2","type":"link out","z":"98f6b4ab.de8e9","name":"","links":["d5d4f350.794e8"],"x":1000,"y":60,"wires":[]},{"id":"2e2a0e7d.48238a","type":"link out","z":"98f6b4ab.de8e9","name":"","links":["d5d4f350.794e8"],"x":1015,"y":100,"wires":[]},{"id":"f2324430.5d9e8","type":"json","z":"f2224d70.f96078","name":"","property":"payload","action":"","pretty":false,"x":490,"y":100,"wires":[["8c976ad1.d7f0e"]]},{"id":"20b10b3.4db19f4","type":"inject","z":"f2224d70.f96078","name":"request weather","topic":"","payload":"{}","payloadType":"json","repeat":"900","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":100,"wires":[["f687d92a.600548"]]},{"id":"f687d92a.600548","type":"http request","z":"f2224d70.f96078","name":"get weather","method":"GET","ret":"txt","paytoqs":false,"url":"https://api.darksky.net/forecast/acc9f8a65d01ed85dd70ea2d8e6a0619/56.806636,36.704848?exclude=minutely,alerts,flags&units=si","tls":"","persist":false,"proxy":"","authType":"basic","x":340,"y":100,"wires":[["f2324430.5d9e8"]]},{"id":"8c976ad1.d7f0e","type":"function","z":"f2224d70.f96078","name":"prepare object","func":"const newMsg = {};\nnewMsg.payload = msg.payload;\n\nreturn newMsg;","outputs":1,"noerr":0,"x":670,"y":100,"wires":[["a79bfc83.9663f","7516abb9.6d05f4","a52f7c7.379358"]]},{"id":"a79bfc83.9663f","type":"function","z":"f2224d70.f96078","name":"set ready to save","func":"msg.payload.id = 1;\nconst $set = {$set: msg.payload};\nconst newMsg ={payload: $set, query: {id:msg.payload.id}};\nreturn newMsg;","outputs":1,"noerr":0,"x":880,"y":100,"wires":[["c276026f.5088a8"]]},{"id":"c276026f.5088a8","type":"mongodb out","z":"f2224d70.f96078","mongodb":"b0c4e7bf.f27208","name":"save to db","collection":"weather","payonly":false,"upsert":true,"multi":false,"operation":"update","x":1080,"y":100,"wires":[]},{"id":"515f4be1.6352d4","type":"mqtt out dynamic","z":"f2224d70.f96078","name":"weather out","topic":"/weather/response","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1130,"y":200,"wires":[]},{"id":"b6034c02.02288","type":"link in","z":"f2224d70.f96078","name":"weatre out","links":["7516abb9.6d05f4","da143a84.31bab"],"x":1005,"y":200,"wires":[["515f4be1.6352d4"]]},{"id":"7516abb9.6d05f4","type":"link out","z":"f2224d70.f96078","name":"","links":["b6034c02.02288"],"x":825,"y":160,"wires":[]},{"id":"c0c8e8fb.e60d9","type":"mqtt in dynamic","z":"f2224d70.f96078","topic":"/weather/request","qos":"1","name":"weather request","broker":"e312d9ea.c89338","x":120,"y":240,"wires":[["f0de2af6.57e67"]]},{"id":"f0de2af6.57e67","type":"function","z":"f2224d70.f96078","name":"request weather from db","func":"msg.payload = {id: 1};\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":240,"wires":[["b151476e.ca2f38"]]},{"id":"b151476e.ca2f38","type":"mongodb in","z":"f2224d70.f96078","mongodb":"b0c4e7bf.f27208","name":"weather find","collection":"weather","operation":"find","x":580,"y":240,"wires":[["43890201.9d6c1c"]]},{"id":"43890201.9d6c1c","type":"function","z":"f2224d70.f96078","name":"set payload","func":"msg.payload = msg.payload[0];\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":240,"wires":[["da143a84.31bab"]]},{"id":"da143a84.31bab","type":"link out","z":"f2224d70.f96078","name":"","links":["b6034c02.02288"],"x":905,"y":240,"wires":[]},{"id":"9932ba00.d84eb","type":"link out","z":"d82282fe.72a6f","name":"","links":["72798ba6.7ac72c","82cc3504.c1f368"],"x":665,"y":1100,"wires":[]},{"id":"ffba13c7.cc6cb8","type":"function","z":"d82282fe.72a6f","name":"update value","func":"const payload = msg.payload;\nconst valueId = `${payload.nodeid}-${payload.cmdclass}-${payload.instance}-${payload.cmdidx}`;\nmsg.query = {\n        nodeid: payload.nodeid,\n        values: { \n            $elemMatch:{\n                value_id: valueId\n            }\n        }\n};\n\nmsg.payload = {\n    'values.$.value': payload.value\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":1100,"wires":[["9932ba00.d84eb"]]},{"id":"64853206.9d007c","type":"link out","z":"d82282fe.72a6f","name":"","links":["5ca2a6ed.aa3178"],"x":935,"y":1160,"wires":[]},{"id":"6af5584b.ba551","type":"function","z":"d82282fe.72a6f","name":"get node","func":"msg.originalPayload = msg.payload;\nmsg.payload = {nodeid: msg.payload.nodeid};\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1160,"wires":[["1b0e5f84.8f5ac"]]},{"id":"1b0e5f84.8f5ac","type":"mongodb in","z":"d82282fe.72a6f","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":670,"y":1160,"wires":[["8715a01f.62f468"]]},{"id":"8715a01f.62f468","type":"function","z":"d82282fe.72a6f","name":"transform","func":"const payload = msg.payload[0];\nconst originalPayload = msg.originalPayload;\nconst valueId = `${originalPayload.nodeid}-${originalPayload.cmdclass}-${originalPayload.instance}-${originalPayload.cmdidx}`;\n\nconst value = payload.values.find(x=>x.value_id === valueId);\n\nif(value) {\n    value.value = originalPayload.value;\n    \n    return {payload: value, topic: '/zwave/changevalue/response'};\n}\n","outputs":1,"noerr":0,"x":830,"y":1160,"wires":[["64853206.9d007c"]]},{"id":"a92e447f.4395e","type":"function","z":"98f6b4ab.de8e9","name":"find","func":"return {payload: {nodeid: 20}};","outputs":1,"noerr":0,"x":330,"y":360,"wires":[["1112a5bd.949232"]]},{"id":"1112a5bd.949232","type":"mongodb in","z":"98f6b4ab.de8e9","mongodb":"b0c4e7bf.f27208","name":"find","collection":"zwave-nodes","operation":"find","x":450,"y":360,"wires":[["aa145b67.a579c"]]},{"id":"aa145b67.a579c","type":"function","z":"98f6b4ab.de8e9","name":"transform","func":"if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-37-1-0`);\n    if(value != null && value.value === false) {\n        return msg;\n    }\n}\n","outputs":1,"noerr":0,"x":600,"y":360,"wires":[["8ab11c85.7ef0e8","33c79c34.988f64"]]},{"id":"39942913.db7536","type":"function","z":"93883042.bbe68","name":"cancel","func":"flow.set('vika_override', false);\n","outputs":1,"noerr":0,"x":1310,"y":240,"wires":[[]]},{"id":"4a49e5aa.d6eb3c","type":"function","z":"93883042.bbe68","name":"cancel","func":"flow.set('livingroom_override', false);\n","outputs":1,"noerr":0,"x":1350,"y":320,"wires":[[]]},{"id":"da376006.98044","type":"RM","z":"dc8c9c.eb0bdb68","name":"vika","device":"3e9f2b83.e4fc44","action":"_msg_","remote":"","button":"","fix":1,"RFSweep":"false","x":1710,"y":260,"wires":[[]]},{"id":"857c2b7f.b74418","type":"function","z":"dc8c9c.eb0bdb68","name":"generate id","func":"let modetype = context.get('mt');\n\nif(!modetype) {\n    modetype = 2;\n}\n\nconst mode = 'c';\nlet temperature = context.get('t') || 28;\n\n\nlet fs = context.get('fs') || \"a\";\n\nif(modetype === 2) {\nif(fs === \"1\") {\n    fs = \"a\";\n    modetype = 1;\n}\nelse if(fs === \"a\") {\n    fs = \"3\";\n}\nelse if(fs === \"3\") {\n    fs = \"2\";\n}\nelse if(fs === \"2\") {\n    fs = \"1\";\n}\n}\n\n\nif(modetype === 1) {\n    temperature++;\n    modetype = 2;\n}\n\ncontext.set('fs', fs);\ncontext.set('mt', modetype);\ncontext.set('t', temperature);\n\nmsg.payload.id = `${mode}${temperature}${fs}`;\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":940,"wires":[[]]},{"id":"ae8767c1.381be","type":"RM","z":"dc8c9c.eb0bdb68","name":"living","device":"c0f9546c.dfb49","action":"_msg_","remote":"","button":"","fix":1,"RFSweep":"false","x":1710,"y":320,"wires":[[]]},{"id":"ea14cb53.a347c","type":"link in","z":"dc8c9c.eb0bdb68","name":"vika ir","links":["7050a504.2d3744"],"x":1595,"y":260,"wires":[["da376006.98044"]]},{"id":"1ee04eb7.5a0621","type":"link in","z":"dc8c9c.eb0bdb68","name":"living ir","links":["56ec468f.d57b48"],"x":1595,"y":320,"wires":[["ae8767c1.381be"]]},{"id":"cc9a60e1.a3ca2","type":"mqtt in dynamic","z":"dc8c9c.eb0bdb68","topic":"/conditionaire/request","qos":"1","name":"cond in","broker":"e312d9ea.c89338","x":120,"y":120,"wires":[["970551fc.b4b368"]]},{"id":"161ff71c.ebe9d9","type":"mqtt out dynamic","z":"dc8c9c.eb0bdb68","name":"cond out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1730,"y":420,"wires":[]},{"id":"b9d8a104.583be","type":"link in","z":"dc8c9c.eb0bdb68","name":"cond out","links":["54a6ef8d.7d9c98","6915d8f1.117148","66f6a266.08ae04","5bdb68ce.3aa19"],"x":1595,"y":420,"wires":[["161ff71c.ebe9d9"]]},{"id":"f3540f12.0cd29","type":"inject","z":"dc8c9c.eb0bdb68","name":"inject id","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":140,"y":680,"wires":[["bfb3a5f.bc88cd8"]]},{"id":"bb5b2812.51957","type":"mongodb in","z":"dc8c9c.eb0bdb68","mongodb":"b0c4e7bf.f27208","name":"conditionare","collection":"conditionare","operation":"find","x":530,"y":680,"wires":[["468f8a2b.f6e16c"]]},{"id":"54a6ef8d.7d9c98","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["b9d8a104.583be"],"x":815,"y":680,"wires":[]},{"id":"970551fc.b4b368","type":"function","z":"dc8c9c.eb0bdb68","name":"generate command","func":"let command = \"\";\n\nif(msg.payload.powerChange) {\n    command = msg.payload.enabled ? 'on' : \"off\";\n} else {\n    const fan = msg.payload.fan === 0 ? 'a' : msg.payload.fan;\n    const mode = msg.payload.mode === 'cool' ? 'c' : 'w';\n    \n    command = `${mode}${msg.payload.temperature}${fan}`;\n}\n\ndelete msg.payload.powerChange;\ndelete msg.payload._id;\n\nmsg.cache = msg.payload;\n\nmsg.payload = {id: command};\n\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":120,"wires":[["e2c2ca3d.6ef7d8"]]},{"id":"788946ea.b96878","type":"switch","z":"dc8c9c.eb0bdb68","name":"check command","property":"code.id","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"on","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":940,"y":200,"wires":[["df5e7a12.8dfe58","8fd7e954.887ae8","bd001e8.dbf03e"],["df5e7a12.8dfe58","8fd7e954.887ae8","adf4764c.054818"],["8fd7e954.887ae8","5bdb68ce.3aa19"]]},{"id":"e2c2ca3d.6ef7d8","type":"mongodb in","z":"dc8c9c.eb0bdb68","mongodb":"b0c4e7bf.f27208","name":"get code","collection":"conditionare","operation":"find","x":560,"y":120,"wires":[["e46d6d8c.91fda8"]]},{"id":"e46d6d8c.91fda8","type":"function","z":"dc8c9c.eb0bdb68","name":"set code","func":"msg.code = msg.payload[0];\nmsg.payload = msg.cache;\n\ndelete msg.cache;\n\nmsg.topic = '/conditionaire/response';\ndelete msg.clientId;\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":120,"wires":[["788946ea.b96878"]]},{"id":"df5e7a12.8dfe58","type":"function","z":"dc8c9c.eb0bdb68","name":"set loading","func":"msg.payload.loading = true;\nreturn msg;","outputs":1,"noerr":0,"x":1210,"y":180,"wires":[["6915d8f1.117148"]]},{"id":"3378657c.31cac2","type":"mongodb out","z":"dc8c9c.eb0bdb68","mongodb":"b0c4e7bf.f27208","name":"save","collection":"conditionare","payonly":true,"upsert":false,"multi":false,"operation":"update","x":1750,"y":500,"wires":[]},{"id":"5ffbc9ff.e32ab8","type":"link in","z":"dc8c9c.eb0bdb68","name":"save","links":["6915d8f1.117148","66f6a266.08ae04","5bdb68ce.3aa19"],"x":1495,"y":500,"wires":[["4fbb88c2.6eaf08"]]},{"id":"6915d8f1.117148","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["b9d8a104.583be","5ffbc9ff.e32ab8"],"x":1355,"y":180,"wires":[]},{"id":"bd001e8.dbf03e","type":"delay","z":"dc8c9c.eb0bdb68","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1060,"y":80,"wires":[["28db86e5.f62c5a"]]},{"id":"28db86e5.f62c5a","type":"function","z":"dc8c9c.eb0bdb68","name":"set loading","func":"msg.payload.loading = false;\nreturn msg;","outputs":1,"noerr":0,"x":1330,"y":120,"wires":[["66f6a266.08ae04"]]},{"id":"66f6a266.08ae04","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["b9d8a104.583be","5ffbc9ff.e32ab8"],"x":1455,"y":120,"wires":[]},{"id":"8fd7e954.887ae8","type":"switch","z":"dc8c9c.eb0bdb68","name":"check type","property":"payload.id","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1210,"y":280,"wires":[["eb95f49e.1ee1"],["233863b0.9a1ee4"]]},{"id":"56ec468f.d57b48","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["1ee04eb7.5a0621"],"x":1455,"y":240,"wires":[]},{"id":"7050a504.2d3744","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["ea14cb53.a347c"],"x":1475,"y":300,"wires":[]},{"id":"4fbb88c2.6eaf08","type":"function","z":"dc8c9c.eb0bdb68","name":"prepare msg","func":"const $set = {$set: msg.payload};\nconst query = {id: msg.payload.id};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;","outputs":1,"noerr":0,"x":1610,"y":500,"wires":[["3378657c.31cac2"]]},{"id":"5bdb68ce.3aa19","type":"link out","z":"dc8c9c.eb0bdb68","name":"","links":["b9d8a104.583be","5ffbc9ff.e32ab8"],"x":1055,"y":300,"wires":[]},{"id":"eb95f49e.1ee1","type":"function","z":"dc8c9c.eb0bdb68","name":"prepare","func":"\nreturn {\n    payload: {\n    action: 'send',\n    data: msg.code.data\n}};","outputs":1,"noerr":0,"x":1350,"y":240,"wires":[["56ec468f.d57b48"]]},{"id":"233863b0.9a1ee4","type":"function","z":"dc8c9c.eb0bdb68","name":"prepare","func":"\nreturn {\n    payload: {\n    action: 'send',\n    data: msg.code.data\n}};","outputs":1,"noerr":0,"x":1360,"y":300,"wires":[["7050a504.2d3744"]]},{"id":"468f8a2b.f6e16c","type":"function","z":"dc8c9c.eb0bdb68","name":"send all","func":"msg.topic = '/conditionaire/all/response'\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":680,"wires":[["54a6ef8d.7d9c98"]]},{"id":"78cb4baf.e7af14","type":"mqtt in dynamic","z":"dc8c9c.eb0bdb68","topic":"/conditionaire/all/request","qos":"1","name":"cond in","broker":"e312d9ea.c89338","x":140,"y":740,"wires":[["bfb3a5f.bc88cd8"]]},{"id":"bfb3a5f.bc88cd8","type":"function","z":"dc8c9c.eb0bdb68","name":"inject ids","func":"msg.payload = {\"$or\":[{\"id\":1},{\"id\":2}]};\nreturn msg;","outputs":1,"noerr":0,"x":350,"y":680,"wires":[["bb5b2812.51957"]]},{"id":"adf4764c.054818","type":"delay","z":"dc8c9c.eb0bdb68","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1100,"y":120,"wires":[["28db86e5.f62c5a","970551fc.b4b368"]]},{"id":"d0e6ae31.e3a708","type":"function","z":"1c7b4521.d6dd8b","name":"get weather","func":"\nreturn {payload: {\n    id: 1\n}};","outputs":1,"noerr":0,"x":230,"y":60,"wires":[["fab17ee2.9e5f68"]]},{"id":"fab17ee2.9e5f68","type":"mongodb in","z":"1c7b4521.d6dd8b","mongodb":"b0c4e7bf.f27208","name":"weather","collection":"weather","operation":"find","x":400,"y":60,"wires":[["190b79fe.383e26"]]},{"id":"190b79fe.383e26","type":"function","z":"1c7b4521.d6dd8b","name":"get temperature","func":"msg.weather = msg.payload[0];\nmsg.payload = {\"$or\":[{\"nodeid\":31},{\"nodeid\":33}]};\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":60,"wires":[["a9722a90.565dc8"]]},{"id":"a9722a90.565dc8","type":"mongodb in","z":"1c7b4521.d6dd8b","mongodb":"b0c4e7bf.f27208","name":"temperature","collection":"zwave-nodes","operation":"find","x":790,"y":60,"wires":[["8f83c5e8.0f3d4"]]},{"id":"8f83c5e8.0f3d4","type":"function","z":"1c7b4521.d6dd8b","name":"get cond status","func":"msg.zwave = msg.payload.map(x=>({nodeid: x.nodeid, temperature: x.values.filter(v=>v.class_id === 49 && v.instance === 1 && v.index === 1),  lux: x.values.filter(v=>v.class_id === 49 && v.instance === 1 && v.index === 3)}));\n\nmsg.payload = {\"$or\":[{\"id\":1},{\"id\":2}]};\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":60,"wires":[["9f0ddf9c.e3248"]]},{"id":"9f0ddf9c.e3248","type":"mongodb in","z":"1c7b4521.d6dd8b","mongodb":"b0c4e7bf.f27208","name":"conditionaire","collection":"conditionare","operation":"find","x":1190,"y":60,"wires":[["1ca08fed.36ef7"]]},{"id":"1ca08fed.36ef7","type":"function","z":"1c7b4521.d6dd8b","name":"conditionaire","func":"msg.conditionaire = msg.payload;\n\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":1380,"y":60,"wires":[["e072c36a.66af3"]]},{"id":"ebaf8c70.7a5e58","type":"link in","z":"1c7b4521.d6dd8b","name":"send msg","links":["9da7f97f.f96188","e6cb3d54.3f435","d8ef4103.060608","af60162c.8e9ed8","d1389f8f.76d4b","58d53b80.bf190c","7b39f177.908ba8","4743e32.828441c","3a9ff62f.f2931a","7b1caaf1.615d34","48fd91e3.8b6178","d1f01d9f.21e6f","38b9b750.79a8b","815cb756.62671"],"x":1680,"y":500,"wires":[["b7082caa.8b6578"]]},{"id":"b7082caa.8b6578","type":"mqtt out dynamic","z":"1c7b4521.d6dd8b","name":"cond out","topic":"/conditionaire/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1810,"y":500,"wires":[]},{"id":"24786057.3b27a8","type":"RM","z":"dc8c9c.eb0bdb68","name":"living","device":"c0f9546c.dfb49","action":"learn","remote":"","button":"","fix":1,"RFSweep":"false","x":1610,"y":940,"wires":[["dd9b7072.8f707"]]},{"id":"cee801b4.deebe8","type":"inject","z":"dc8c9c.eb0bdb68","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1500,"y":860,"wires":[["24786057.3b27a8"]]},{"id":"dd9b7072.8f707","type":"debug","z":"dc8c9c.eb0bdb68","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1800,"y":940,"wires":[]},{"id":"f1d0d3f2.b7f2c8","type":"link out","z":"3a3cfd59.03e752","name":"presence in","links":["1efbe86e.9b2768","763830dd.6be2b","1fb336a.a47d249","28812a8f.c3ddf6","1f2e49db.340916"],"x":1955,"y":60,"wires":[]},{"id":"fc529ac3.972d7","type":"mqtt in dynamic","z":"3a3cfd59.03e752","topic":"/system/presence","qos":"1","name":"presence event","broker":"e312d9ea.c89338","x":1780,"y":60,"wires":[["f1d0d3f2.b7f2c8"]]},{"id":"1efbe86e.9b2768","type":"link in","z":"3a3cfd59.03e752","name":"","links":["f1d0d3f2.b7f2c8"],"x":95,"y":100,"wires":[["7d026e21.00fe68"]]},{"id":"7d026e21.00fe68","type":"function","z":"3a3cfd59.03e752","name":"is presence","func":"if(!msg.payload.presence) return;\n\nconst now = Date.now();\nconst doorSensor = global.get('door');\n\nif(!doorSensor) return;\nif(now - doorSensor.lastOpenDate > 10000) return;\n\nreturn {payload: {nodeid: 15}};","outputs":1,"noerr":0,"x":225,"y":100,"wires":[["250e5e5b.dadc22"]]},{"id":"250e5e5b.dadc22","type":"mongodb in","z":"3a3cfd59.03e752","mongodb":"b0c4e7bf.f27208","name":"get lx","collection":"zwave-nodes","operation":"find","x":365,"y":100,"wires":[["5fef6129.191d7"]]},{"id":"b5d9a26d.41013","type":"function","z":"3a3cfd59.03e752","name":"check lux","func":"const lxParam = mag.lx.values.find(x=>x.value_id === '15-49-1-3');\n\nif(lxParam.value > 15) return null;\n\nreturn {payload:{}};","outputs":1,"noerr":0,"x":1000,"y":120,"wires":[["caa5e285.7a4148"]]},{"id":"e4ca0b03.e6455","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1315,"y":100,"wires":[]},{"id":"700bb3d1.45cadc","type":"link in","z":"3a3cfd59.03e752","name":"zwave out","links":["e4ca0b03.e6455","68782e95.299d9","e8301938.64641","564e3e7b.ca465","bd5dc5d0.41035","f23a488c.e59ad8","de5bea5d.c5a88","82306f75.b78bc","96d818a3.d5dd18","43f84c8.16fe134","4cb61ce.4e609e4","325dff65.bb4c7"],"x":1715,"y":140,"wires":[["906c547.bf572a8"]]},{"id":"906c547.bf572a8","type":"mqtt out dynamic","z":"3a3cfd59.03e752","name":"zwave out","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1860,"y":140,"wires":[]},{"id":"d172c091.50178","type":"comment","z":"3a3cfd59.03e752","name":"Включение света в коридоре когда кто-то приходит","info":"","x":295,"y":60,"wires":[]},{"id":"ab7da93a.509d3","type":"comment","z":"3a3cfd59.03e752","name":"включение света там где кто-то есть при опускании штор на ночь","info":"","x":345,"y":180,"wires":[]},{"id":"af15b277.4d9d48","type":"mqtt out dynamic","z":"51445fb5.e4d8f8","name":"night","topic":"/system/night","qos":"1","retain":"","broker":"e312d9ea.c89338","x":450,"y":380,"wires":[]},{"id":"a8cfbedd.5ac2a","type":"nighttime","z":"51445fb5.e4d8f8","name":"","lon":"37.617298","lat":"55.755825","start":"sunrise","end":"sunset","x":120,"y":380,"wires":[[],["f838f4d6.0d214"]]},{"id":"ac85285c.2bf6d8","type":"mqtt in dynamic","z":"93883042.bbe68","topic":"/system/night","qos":"1","name":"night event","broker":"e312d9ea.c89338","x":110,"y":60,"wires":[["87a3fa01.d35a9"]]},{"id":"b21f31f5.3fe56","type":"function","z":"3a3cfd59.03e752","name":"check lamels","func":"if(msg.payload.class_id === 38 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) {\n    let previous = context.get(`n_${msg.payload.node_id}`);\n    if(previous == null) {\n        previous = msg.payload.value;\n    }\n    \n     context.set(`n_${msg.payload.node_id}`, msg.payload.value);\n    \n    if(previous !== 0 && msg.payload.value === 0) {\n        return {\n            payload: {\n                nodeid: msg.payload.node_id\n            }\n        };\n    }\n}\n\n","outputs":1,"noerr":0,"x":730,"y":240,"wires":[["a25d32e0.ba4858","4e8f4c5.1da7db4"]]},{"id":"589d0e73.756b9","type":"function","z":"3a3cfd59.03e752","name":"should turn on","func":"const nodes = [];\nconst now = Date.now();\n\nconst movement = [33,31,29].map(x=>({id: x, data: global.get(`motion_${x}`)}))\n.map(x=>({id:x.id, movement: now - x.data.lastMotion <= (15 * 60) * 1000}));\n\n\nmovement.forEach(x=> {\n    if(x.id === 33 && x.movement &&  msg.payload.nodeid === 2) {\n        nodes.push(4);\n    }\n    if(x.id === 31 && x.movement && msg.payload.nodeid === 11) {\n        nodes.push(9);\n    }\n    if(x.id === 29 && x.movement && msg.payload.nodeid === 25) {\n        nodes.push(39);\n    }\n})\n\nreturn {payload: nodes};","outputs":1,"noerr":0,"x":1120,"y":280,"wires":[["995fe358.153978"]]},{"id":"995fe358.153978","type":"split","z":"3a3cfd59.03e752","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1290,"y":280,"wires":[["b39dca18.670488"]]},{"id":"f838f4d6.0d214","type":"function","z":"51445fb5.e4d8f8","name":"set night","func":"msg.payload = {night: msg.payload}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":380,"wires":[["af15b277.4d9d48"]]},{"id":"b39dca18.670488","type":"function","z":"3a3cfd59.03e752","name":"set value","func":"let value = {\n        node_id: msg.payload,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 50\n    };\n    \n    \n    if(msg.payload === 39) {\n        value = {\n        node_id: msg.payload,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n    }\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":1420,"y":280,"wires":[["68782e95.299d9"]]},{"id":"68782e95.299d9","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1515,"y":280,"wires":[]},{"id":"aa75445f.691dc8","type":"comment","z":"3a3cfd59.03e752","name":"Свет на кухне вечером","info":"","x":230,"y":740,"wires":[]},{"id":"f4d609ec.7516b8","type":"function","z":"98f6b4ab.de8e9","name":"telegram transform (bath tubs)","func":"return {\n    payload: {\n        content: 'Протечка в тех шкафу'\n    }\n}","outputs":1,"noerr":0,"x":850,"y":140,"wires":[["3b24c4d2.de2d14"]]},{"id":"3b24c4d2.de2d14","type":"link out","z":"98f6b4ab.de8e9","name":"","links":["d5d4f350.794e8"],"x":1015,"y":140,"wires":[]},{"id":"5cb27c26.d81b2c","type":"function","z":"3a3cfd59.03e752","name":"check motion","func":"if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 10 &&\nmsg.payload.value === 8 && (msg.payload.node_id === 15 || msg.payload.node_id === 47 || msg.payload.node_id === 29)) {\n    return {payload: {nodeid: msg.payload.node_id}};\n}\n\nreturn;\n","outputs":1,"noerr":0,"x":170,"y":800,"wires":[["62cebe3e.99ab08"]]},{"id":"67f1eab5.283c64","type":"function","z":"3a3cfd59.03e752","name":"should turn on","func":"const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":1260,"y":760,"wires":[["e8301938.64641"]]},{"id":"e8301938.64641","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1395,"y":760,"wires":[]},{"id":"24b7097e.006c56","type":"function","z":"3a3cfd59.03e752","name":"should turn off","func":"const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: false\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":1480,"y":880,"wires":[["564e3e7b.ca465"]]},{"id":"564e3e7b.ca465","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1615,"y":880,"wires":[]},{"id":"f5418141.46a478","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":"-60","x":1040,"y":760,"wires":[["67f1eab5.283c64","8c928e14.c7613"],[]]},{"id":"635be452.bcb7b4","type":"switch","z":"3a3cfd59.03e752","name":"switch node","property":"payload.nodeid","propertyType":"msg","rules":[{"t":"eq","v":"15","vt":"num"},{"t":"eq","v":"16","vt":"num"},{"t":"eq","v":"29","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":840,"y":800,"wires":[["f5418141.46a478"],["f5418141.46a478"],["f5418141.46a478"]]},{"id":"8c928e14.c7613","type":"stoptimer","z":"3a3cfd59.03e752","duration":"2","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":1260,"y":900,"wires":[["24b7097e.006c56"],[]]},{"id":"4ed97e48.35a61","type":"comment","z":"ff9f5d72.eb6f2","name":"Поднять температуру пола в ванной на время купашек","info":"","x":350,"y":580,"wires":[]},{"id":"b950de08.0193a","type":"mqtt in dynamic","z":"ff9f5d72.eb6f2","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":1290,"y":60,"wires":[["4f800201.4e42b4"]]},{"id":"4f800201.4e42b4","type":"link out","z":"ff9f5d72.eb6f2","name":"zwave in","links":["9161f153.995af8"],"x":1435,"y":60,"wires":[]},{"id":"9161f153.995af8","type":"link in","z":"ff9f5d72.eb6f2","name":"","links":["4f800201.4e42b4"],"x":75,"y":780,"wires":[["41a95b74.441cac"]]},{"id":"41a95b74.441cac","type":"function","z":"ff9f5d72.eb6f2","name":"check humidity","func":"if(msg.payload === 'stop') {\n    context.set('h', 0);\n    return;\n}\nconst humidity =  Number(context.get('h')) || 0;\n\nif(msg.payload.class_id === 49 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 5 && msg.payload.node_id === 48) {\n    if(humidity === 0) {\n         context.set('h', Number(msg.payload.value));\n         return {payload: 'stop'};\n    }\n    \n    if(Number(msg.payload.value) - humidity >= 5) {\n        context.set('h',  Number(msg.payload.value));\n        return msg;\n    }\n}","outputs":1,"noerr":0,"x":200,"y":780,"wires":[["883cfd56.aead58"]]},{"id":"8576af59.97f8c8","type":"function","z":"ff9f5d72.eb6f2","name":"check motion","func":"const now = Date.now();\nconst motion = global.get('motion_48');\n\nif(now - motion.lastMotion <= (25*60)*1000) {\n    return msg;\n}","outputs":1,"noerr":0,"x":550,"y":780,"wires":[["5b51bca8.b2cb04"]]},{"id":"7f18b9f5.6aaf9","type":"function","z":"ff9f5d72.eb6f2","name":"enable","func":"const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Heat (Default)'\n    };\n    \nflow.set('blockBath', true);\n\nreturn {\n    payload: {value: value}\n};","outputs":1,"noerr":0,"x":1230,"y":780,"wires":[["4f6c56d0.560958","fab4fe5a.967038"]]},{"id":"4f6c56d0.560958","type":"link out","z":"ff9f5d72.eb6f2","name":"","links":["49348cef.06733c","c0382aa6.c634b"],"x":1335,"y":720,"wires":[]},{"id":"3a068fb9.cd8b08","type":"function","z":"ff9f5d72.eb6f2","name":"block disable","func":"if(!!flow.get('blockBath') && msg.payload.value.node_id === 18) {\n    flow.set('disableBath', true);\n    return;\n}\nreturn msg;","outputs":1,"noerr":0,"x":770,"y":180,"wires":[["e3c13df9.5af368"]]},{"id":"1076c09d.88fc67","type":"function","z":"ff9f5d72.eb6f2","name":"remove block","func":"flow.set('disableBath', false);\nreturn msg;","outputs":1,"noerr":0,"x":1320,"y":400,"wires":[["46a65d9b.ff3bdc"]]},{"id":"fab4fe5a.967038","type":"stoptimer","z":"ff9f5d72.eb6f2","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":1420,"y":780,"wires":[["b650abd3.40bb68"],[]]},{"id":"b650abd3.40bb68","type":"function","z":"ff9f5d72.eb6f2","name":"check disable","func":"flow.set('blockBath', false);\n\nif(!!flow.get('disableBath')) {\n    return [msg, null];\n}\nreturn [null, msg];","outputs":2,"noerr":0,"x":1620,"y":760,"wires":[["2fb816f4.abca32"],["effeb985.51d37"]]},{"id":"effeb985.51d37","type":"function","z":"ff9f5d72.eb6f2","name":"enable","func":"const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Energy Heat'\n    };\n\nreturn {\n    payload: {value: value}\n};","outputs":1,"noerr":0,"x":1810,"y":780,"wires":[["fffd7f66.cc6a88"]]},{"id":"2fb816f4.abca32","type":"function","z":"ff9f5d72.eb6f2","name":"disable","func":"const value = {\n        node_id: 18,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Off'\n    };\n\nreturn {\n    payload: {value: value}\n};","outputs":1,"noerr":0,"x":1820,"y":740,"wires":[["fffd7f66.cc6a88"]]},{"id":"fffd7f66.cc6a88","type":"link out","z":"ff9f5d72.eb6f2","name":"","links":["49348cef.06733c","c0382aa6.c634b"],"x":1955,"y":760,"wires":[]},{"id":"5b51bca8.b2cb04","type":"function","z":"ff9f5d72.eb6f2","name":"get bath thermo","func":"msg.payload = {\"$or\":[{\"nodeid\":18},{\"nodeid\":17}]};\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":780,"wires":[["26b38dca.d9a88a"]]},{"id":"26b38dca.d9a88a","type":"mongodb in","z":"ff9f5d72.eb6f2","mongodb":"b0c4e7bf.f27208","name":"get zwave nodes","collection":"zwave-nodes","operation":"find","x":930,"y":780,"wires":[["a188796e.629958"]]},{"id":"a188796e.629958","type":"function","z":"ff9f5d72.eb6f2","name":"check off","func":"const bath = msg.payload.find(x=>x.nodeid === 18);\nconst light =  msg.payload.find(x=>x.nodeid === 17);\n\nif(!light.values.find(x=>x.value_id === '17-37-1-0').value) {\n    return;\n}\n\nif(bath.values.find(x=>x.value_id === '18-64-1-0').value === 'Off') {\n    flow.set('disableBath', true);\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":780,"wires":[["7f18b9f5.6aaf9"]]},{"id":"d873376d.daffe","type":"mongodb in","z":"3a3cfd59.03e752","mongodb":"b0c4e7bf.f27208","name":"get zwave nodes","collection":"zwave-nodes","operation":"find","x":530,"y":800,"wires":[["f1edb92d.2d1268"]]},{"id":"f1edb92d.2d1268","type":"function","z":"3a3cfd59.03e752","name":"is on","func":"const switchK = msg.payload[0];\nmsg.payload = msg.cache;\n\nif(switchK.values.some(x=>x.value_id === '39-37-1-0' && x.value)) {\n    return;\n}\n\nmsg.on = switchK.values.some(x=>x.value_id === '39-37-2-0' && x.value);\n\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":800,"wires":[["635be452.bcb7b4"]]},{"id":"62cebe3e.99ab08","type":"function","z":"3a3cfd59.03e752","name":"get switch","func":"msg.cache = msg.payload;\nmsg.payload = {nodeid: 39};\n\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":800,"wires":[["d873376d.daffe"]]},{"id":"188b9fb8.dc8848","type":"comment","z":"3a3cfd59.03e752","name":"свет в ванной","info":"","x":220,"y":1020,"wires":[]},{"id":"993b86b1.06e9f8","type":"comment","z":"3a3cfd59.03e752","name":"общий свет","info":"","x":210,"y":1460,"wires":[]},{"id":"d54ece50.1b7cf8","type":"function","z":"3a3cfd59.03e752","name":"check main","func":"if(msg.payload.class_id === 37 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value && msg.payload.node_id === 39) {\n    return {payload: 'stop'}\n}\n\nreturn;\n","outputs":1,"noerr":0,"x":350,"y":880,"wires":[["8c928e14.c7613"]]},{"id":"91ac9e18.d10fa8","type":"RM","z":"8cb7951c.d33fd8","name":"living","device":"c0f9546c.dfb49","action":"_msg_","remote":"","button":"","fix":1,"RFSweep":"false","x":1750,"y":220,"wires":[[]]},{"id":"a6cab469.a2494","type":"link in","z":"8cb7951c.d33fd8","name":"send message","links":["9e5b31b8.bf4788"],"x":1435,"y":220,"wires":[["198b3159.274247"]]},{"id":"198b3159.274247","type":"function","z":"8cb7951c.d33fd8","name":"prepare data","func":"\nreturn {\n    payload: {\n        action: 'send',\n        data: msg.payload.data\n    }\n};","outputs":1,"noerr":0,"x":1570,"y":220,"wires":[["91ac9e18.d10fa8"]]},{"id":"9bd67e99.c16998","type":"mqtt in dynamic","z":"8cb7951c.d33fd8","topic":"/media/request","qos":"1","name":"media in","broker":"e312d9ea.c89338","x":100,"y":120,"wires":[["bb06d5ea.60c22"]]},{"id":"20ac56ed.3c68f2","type":"switch","z":"8cb7951c.d33fd8","name":"command","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"pc","vt":"str"},{"t":"eq","v":"vol+","vt":"str"},{"t":"eq","v":"vol-","vt":"str"},{"t":"eq","v":"mute","vt":"str"},{"t":"eq","v":"off","vt":"str"},{"t":"eq","v":"tvoff","vt":"str"},{"t":"eq","v":"tvon","vt":"str"},{"t":"eq","v":"server","vt":"str"}],"checkall":"true","repair":false,"outputs":8,"x":440,"y":120,"wires":[["9f0c9415.8fb5b8"],["735b8451.ec4ab4"],["a819abc0.b8894"],["7da76eaf.47831"],["2b41e6c1.e1074a"],["1a8bafd6.a73a28"],["ff2cd6e7.7ff78"],["5a1ca11c.aee2d8"]]},{"id":"bb06d5ea.60c22","type":"function","z":"8cb7951c.d33fd8","name":"cache","func":"msg.action = msg.payload.action;\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":120,"wires":[["20ac56ed.3c68f2","6ef1d12f.f1e2a8"]]},{"id":"c39faf7d.4ecb28","type":"mongodb in","z":"8cb7951c.d33fd8","mongodb":"b0c4e7bf.f27208","name":"get","collection":"media","operation":"find","x":830,"y":140,"wires":[["ce501ce8.ee26b8"]]},{"id":"9f0c9415.8fb5b8","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {\"$or\":[{\"id\":\"ampon\"},{\"id\":\"switchon\"},{\"id\":\"switch1\"}]};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":40,"wires":[["c39faf7d.4ecb28"]]},{"id":"9e5b31b8.bf4788","type":"link out","z":"8cb7951c.d33fd8","name":"","links":["a6cab469.a2494"],"x":1195,"y":140,"wires":[]},{"id":"2b41e6c1.e1074a","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {\"$or\":[{\"id\":\"switchoff\"},{\"id\":\"ampoff\"},{\"id\":\"tvoff\"}]};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":200,"wires":[["c39faf7d.4ecb28"]]},{"id":"735b8451.ec4ab4","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {id: \"ampv+\"};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":80,"wires":[["c39faf7d.4ecb28"]]},{"id":"a819abc0.b8894","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {id: \"ampv-\"};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":120,"wires":[["c39faf7d.4ecb28"]]},{"id":"7da76eaf.47831","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {id: \"ampmute\"};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":160,"wires":[["c39faf7d.4ecb28"]]},{"id":"f70f663e.287928","type":"link in","z":"8cb7951c.d33fd8","name":"save action","links":["98b5bbf4.e2f1a"],"x":1435,"y":160,"wires":[["80d11aa9.757078"]]},{"id":"30c8d12f.551566","type":"mongodb out","z":"8cb7951c.d33fd8","mongodb":"b0c4e7bf.f27208","name":"save media action","collection":"media","payonly":true,"upsert":false,"multi":false,"operation":"update","x":1770,"y":160,"wires":[]},{"id":"98b5bbf4.e2f1a","type":"link out","z":"8cb7951c.d33fd8","name":"","links":["f70f663e.287928"],"x":475,"y":460,"wires":[]},{"id":"80d11aa9.757078","type":"function","z":"8cb7951c.d33fd8","name":"prepare msg","func":"const $set = {$set: {action: msg.action}};\nconst query = {id: \"status\"};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;","outputs":1,"noerr":0,"x":1550,"y":160,"wires":[["30c8d12f.551566"]]},{"id":"f00ba1cb.d6e3d","type":"inject","z":"8cb7951c.d33fd8","name":"inject id","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":"0.5","x":120,"y":620,"wires":[["4cd51cab.ea211c"]]},{"id":"3b0d5819.96d8c8","type":"mongodb in","z":"8cb7951c.d33fd8","mongodb":"b0c4e7bf.f27208","name":"media","collection":"media","operation":"find","x":490,"y":620,"wires":[["b38e6bf6.9abf"]]},{"id":"e4634275.bcde3","type":"link out","z":"8cb7951c.d33fd8","name":"","links":["65cd534.797042c"],"x":795,"y":620,"wires":[]},{"id":"b38e6bf6.9abf","type":"function","z":"8cb7951c.d33fd8","name":"send all","func":"msg.topic = '/media/all/response';\nmsg.payload = {action: msg.payload[0].action};\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":620,"wires":[["e4634275.bcde3"]]},{"id":"7488585.7b81d28","type":"mqtt in dynamic","z":"8cb7951c.d33fd8","topic":"/media/all/request","qos":"1","name":"media in","broker":"e312d9ea.c89338","x":120,"y":680,"wires":[["4cd51cab.ea211c"]]},{"id":"4cd51cab.ea211c","type":"function","z":"8cb7951c.d33fd8","name":"inject ids","func":"msg.payload = {id: \"status\"};\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":620,"wires":[["3b0d5819.96d8c8"]]},{"id":"65cd534.797042c","type":"link in","z":"8cb7951c.d33fd8","name":"mqtt out","links":["e4634275.bcde3","fe2da5c9.19ea","4c43f240.4d7ef4"],"x":1435,"y":280,"wires":[["cf380f1f.7a107"]]},{"id":"6d7f638a.c3beb4","type":"function","z":"8cb7951c.d33fd8","name":"send status","func":"\nreturn {\n    topic: '/media/response',\n    payload: {\n        action: msg.action\n    }\n};","outputs":1,"noerr":0,"x":530,"y":420,"wires":[["fe2da5c9.19ea"]]},{"id":"fe2da5c9.19ea","type":"link out","z":"8cb7951c.d33fd8","name":"","links":["65cd534.797042c"],"x":655,"y":420,"wires":[]},{"id":"cf380f1f.7a107","type":"mqtt out dynamic","z":"8cb7951c.d33fd8","name":"media out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1560,"y":280,"wires":[]},{"id":"ce501ce8.ee26b8","type":"function","z":"8cb7951c.d33fd8","name":"send with delay","func":"function getNext(nodelay = false) {\n    if(!msg.payload.length) return;\n     const item = msg.payload.shift();\n     \n     setTimeout(() => {\n         node.send({payload: item});\n         getNext();\n     }, nodelay ? 0 : 3000);\n}\n\ngetNext(true);","outputs":1,"noerr":0,"x":1000,"y":140,"wires":[["9e5b31b8.bf4788"]]},{"id":"6ef1d12f.f1e2a8","type":"function","z":"8cb7951c.d33fd8","name":"save action","func":"if(msg.payload.action === 'off' || msg.payload.action === 'pc' || msg.payload.action === 'server')\n    return msg;","outputs":1,"noerr":0,"x":330,"y":420,"wires":[["6d7f638a.c3beb4","98b5bbf4.e2f1a"]]},{"id":"7446566c.d6ff08","type":"function","z":"2585caa7.9d343e","name":"check smoke","func":"if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.value && msg.payload.node_id === 45) {\n    return {payload:{}};\n}\n\nreturn;\n","outputs":1,"noerr":0,"x":450,"y":140,"wires":[["2e627a7.ab48e86","c49514d0.31f01"]]},{"id":"6d5e5795.a0f54","type":"mqtt in dynamic","z":"2585caa7.9d343e","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":250,"y":140,"wires":[["7446566c.d6ff08"]]},{"id":"c49514d0.31f01","type":"function","z":"2585caa7.9d343e","name":"send vent off","func":"return {\n    topic: '/ventilation/setpower/request',\n    payload: {value: 0}\n    \n}","outputs":1,"noerr":0,"x":660,"y":100,"wires":[["53f033fb.76c844"]]},{"id":"2e627a7.ab48e86","type":"function","z":"2585caa7.9d343e","name":"smoke msg","func":"return {\n    payload: {\n        content: 'Произошло задымление'\n    }\n}","outputs":1,"noerr":0,"x":660,"y":200,"wires":[["d6791f97.07281"]]},{"id":"d6791f97.07281","type":"subflow:fdf44b03.831398","z":"2585caa7.9d343e","name":"","x":880,"y":200,"wires":[]},{"id":"383a149c.35d6bc","type":"mqtt out dynamic","z":"2585caa7.9d343e","name":"","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1550,"y":100,"wires":[]},{"id":"f6dc8607.902ca","type":"link in","z":"2585caa7.9d343e","name":"mqtt out","links":["53f033fb.76c844"],"x":1415,"y":100,"wires":[["383a149c.35d6bc"]]},{"id":"53f033fb.76c844","type":"link out","z":"2585caa7.9d343e","name":"","links":["f6dc8607.902ca"],"x":775,"y":100,"wires":[]},{"id":"717ce008.4ec5c8","type":"mqtt in dynamic","z":"4a108442.009864","topic":"/co2/response","qos":"1","name":"co2","broker":"e312d9ea.c89338","x":130,"y":1160,"wires":[["1cc73222.e3e7f6"]]},{"id":"1cc73222.e3e7f6","type":"link out","z":"4a108442.009864","name":"co2 in","links":["ad181a3e.409f6","f77a9d97.601678","6c2bb65f.7ce9e8","6cc9b00e.9793c"],"x":225,"y":1160,"wires":[]},{"id":"ad181a3e.409f6","type":"link in","z":"4a108442.009864","name":"","links":["1cc73222.e3e7f6"],"x":1075,"y":940,"wires":[["a3cd3397.f49d3"]]},{"id":"a3cd3397.f49d3","type":"function","z":"4a108442.009864","name":"transform","func":"const data = msg.payload;\n\nconst tags = {\n    co2: data.index\n}\n\nmsg.measurement = 'sensors';\nmsg.payload = [{\n            value: Number(data.co2)\n        }];\n        \n        msg.payload[1] = tags;\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":940,"wires":[["14d7f4ad.ef5ce3"]]},{"id":"14d7f4ad.ef5ce3","type":"influxdb out","z":"4a108442.009864","influxdb":"d47f185f.a8541","name":"save influx","measurement":"","precision":"","retentionPolicy":"","x":1370,"y":940,"wires":[]},{"id":"cc3c6d5f.66fc5","type":"mqtt in dynamic","z":"3a3cfd59.03e752","topic":"/zwave/changevalue/response","qos":"1","name":"zwave in","broker":"e312d9ea.c89338","x":1740,"y":200,"wires":[["52497519.186f3c"]]},{"id":"52497519.186f3c","type":"link out","z":"3a3cfd59.03e752","name":"zwave in","links":["368e0577.4f9242","73296290.055b5c","aa2200bf.8138b","fe0bcf41.c942b"],"x":1855,"y":200,"wires":[]},{"id":"368e0577.4f9242","type":"link in","z":"3a3cfd59.03e752","name":"","links":["52497519.186f3c","f7fa672c.d74928","452c0356.2bfaa4"],"x":100,"y":880,"wires":[["5cb27c26.d81b2c","d54ece50.1b7cf8"]]},{"id":"73296290.055b5c","type":"link in","z":"3a3cfd59.03e752","name":"","links":["52497519.186f3c","f7fa672c.d74928","452c0356.2bfaa4"],"x":75,"y":240,"wires":[["9bd40d2.14539f"]]},{"id":"a25d32e0.ba4858","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"sunset","endTime":"sunset","startOffset":"-240","endOffset":"120","x":920,"y":200,"wires":[["f76e6b99.6464a8"],[]]},{"id":"e9b19f10.44eab8","type":"mqtt in dynamic","z":"1c7b4521.d6dd8b","topic":"/system/presence","qos":"1","name":"presence","broker":"e312d9ea.c89338","x":1720,"y":580,"wires":[["2631cc6f.6b123c"]]},{"id":"ba2d3164.f6767","type":"mqtt in dynamic","z":"1c7b4521.d6dd8b","topic":"/system/warmup","qos":"1","name":"warmup","broker":"e312d9ea.c89338","x":1720,"y":620,"wires":[["27949440.7d1874"]]},{"id":"b95f5a8a.2d02a8","type":"link in","z":"1c7b4521.d6dd8b","name":"params in","links":["27949440.7d1874","9a2db0f1.cfd4"],"x":95,"y":60,"wires":[["d0e6ae31.e3a708"]]},{"id":"bbf26212.51c93","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["b64dbc33.4494a8"],"x":1735,"y":60,"wires":[]},{"id":"2631cc6f.6b123c","type":"link out","z":"1c7b4521.d6dd8b","name":"presence in","links":["746d7005.62f04","62d9b328.98a764"],"x":1835,"y":580,"wires":[]},{"id":"746d7005.62f04","type":"link in","z":"1c7b4521.d6dd8b","name":"","links":["53ea8026.108e","2631cc6f.6b123c"],"x":95,"y":140,"wires":[["5631f08.fc5d89"]]},{"id":"5631f08.fc5d89","type":"function","z":"1c7b4521.d6dd8b","name":"no one home?","func":"if(!msg.payload.presence) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":220,"y":140,"wires":[["6223d02.73a24b"]]},{"id":"54865091.9ef658","type":"function","z":"1c7b4521.d6dd8b","name":"disable cond living","func":"if(msg.c && !msg.c.enabled) return;\n\nreturn {\n    payload: {\n    id: 1,\n    temperature: 25,\n    fan : 0,\n    enabled : false,\n    mode : \"cool\",\n    powerChange: true\n}\n};","outputs":1,"noerr":0,"x":1730,"y":840,"wires":[["d1f01d9f.21e6f"]]},{"id":"f629f2fa.5c0be8","type":"function","z":"1c7b4521.d6dd8b","name":"disable cond vika","func":"\nif(msg.c && !msg.c.enabled) return;\n\nreturn {\n    payload: {\n    id: 2,\n    temperature: 25,\n    fan : 0,\n    enabled : false,\n    mode : \"cool\",\n    powerChange: true\n}\n};","outputs":1,"noerr":0,"x":1730,"y":800,"wires":[["48fd91e3.8b6178"]]},{"id":"48fd91e3.8b6178","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["ebaf8c70.7a5e58"],"x":1865,"y":800,"wires":[]},{"id":"d1f01d9f.21e6f","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["ebaf8c70.7a5e58"],"x":1865,"y":840,"wires":[]},{"id":"2c9e4df4.90bed2","type":"link in","z":"1c7b4521.d6dd8b","name":"disable vcond","links":["6223d02.73a24b","d1cef25e.164368","3e0f9913.18dcae","292dad6c.f1bf8a"],"x":1575,"y":800,"wires":[["f629f2fa.5c0be8"]]},{"id":"2b7f1d61.7b9482","type":"link in","z":"1c7b4521.d6dd8b","name":"disable our cond","links":["6223d02.73a24b","dbb256b8.001918","ee751523.a63e88","292dad6c.f1bf8a"],"x":1575,"y":840,"wires":[["54865091.9ef658"]]},{"id":"6223d02.73a24b","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["2c9e4df4.90bed2","2b7f1d61.7b9482"],"x":355,"y":140,"wires":[]},{"id":"27949440.7d1874","type":"link out","z":"1c7b4521.d6dd8b","name":"warmup in","links":["b95f5a8a.2d02a8","ce700984.9563c"],"x":1835,"y":620,"wires":[]},{"id":"a1409aff.1bf81","type":"inject","z":"1c7b4521.d6dd8b","name":"every hour","topic":"","payload":"{}","payloadType":"json","repeat":"3600","crontab":"","once":false,"onceDelay":0.1,"x":1730,"y":740,"wires":[["9a2db0f1.cfd4"]]},{"id":"9a2db0f1.cfd4","type":"link out","z":"1c7b4521.d6dd8b","name":"every hour in","links":["b95f5a8a.2d02a8","ce700984.9563c"],"x":1835,"y":740,"wires":[]},{"id":"75ec8076.883378","type":"mqtt in dynamic","z":"1c7b4521.d6dd8b","topic":"/system/vacation","qos":"1","name":"vacation event","broker":"e312d9ea.c89338","x":1720,"y":680,"wires":[["53ea8026.108e"]]},{"id":"53ea8026.108e","type":"link out","z":"1c7b4521.d6dd8b","name":"vacation in","links":["746d7005.62f04","ce700984.9563c"],"x":1835,"y":680,"wires":[]},{"id":"9b34c76f.0ec168","type":"function","z":"1c7b4521.d6dd8b","name":"enable cond living","func":"if(msg.c)\n{\n    if(msg.c.enabled &&\n    msg.c.temperature === msg.payload.temperature &&\n    msg.c.mode === msg.payload.mode) {\n        return;\n    }\n}\n\nreturn {\n    payload: {\n    id: 1,\n    temperature: msg.payload.temperature,\n    fan : 0,\n    enabled : true,\n    mode : msg.payload.mode,\n    powerChange: !msg.c.enabled,\n}\n};","outputs":1,"noerr":0,"x":1730,"y":920,"wires":[["38b9b750.79a8b"]]},{"id":"33665930.79717e","type":"function","z":"1c7b4521.d6dd8b","name":"enable cond vika","func":"if(msg.c)\n{\n    if(msg.c.enabled &&\n    msg.c.temperature === msg.payload.temperature &&\n    msg.c.mode === msg.payload.mode) {\n        return;\n    }\n}\n\nreturn {\n    payload: {\n    id: 2,\n    temperature: msg.payload.temperature,\n    fan : 0,\n    enabled : true,\n    mode : msg.payload.mode,\n    powerChange: !msg.c.enabled,\n}\n};","outputs":1,"noerr":0,"x":1730,"y":880,"wires":[["815cb756.62671"]]},{"id":"630292.63073d7","type":"link in","z":"1c7b4521.d6dd8b","name":"enable vcond","links":["e4e612d1.6a455","ffe865ce.113818"],"x":1575,"y":880,"wires":[["33665930.79717e"]]},{"id":"38b9b750.79a8b","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["ebaf8c70.7a5e58"],"x":1875,"y":920,"wires":[]},{"id":"815cb756.62671","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["ebaf8c70.7a5e58"],"x":1875,"y":880,"wires":[]},{"id":"a017adec.b6faa8","type":"link in","z":"1c7b4521.d6dd8b","name":"enable our cond","links":["992fc957.79b03","e888a670.4da1f8"],"x":1575,"y":920,"wires":[["9b34c76f.0ec168"]]},{"id":"b64dbc33.4494a8","type":"link in","z":"1c7b4521.d6dd8b","name":"data in","links":["bbf26212.51c93"],"x":75,"y":400,"wires":[["295a2b19.5faafc"]]},{"id":"295a2b19.5faafc","type":"function","z":"1c7b4521.d6dd8b","name":"duplicate","func":"const vikaMsg = {...msg};\nconst livingMsg = {...msg};\n\nvikaMsg.payload = {\n    id: 2,\n    temperature: msg.zwave.find(x=>x.nodeid === 33).temperature[0]\n};\n\nlivingMsg.payload = {\n    id: 1,\n    temperature: msg.zwave.find(x=>x.nodeid === 31).temperature[0]\n};\n\nreturn [livingMsg, vikaMsg];","outputs":2,"noerr":0,"x":180,"y":400,"wires":[["c6d2fda.6db1d"],["c6d2fda.6db1d"]]},{"id":"c6d2fda.6db1d","type":"function","z":"1c7b4521.d6dd8b","name":"no one home","func":"if(msg.presence) {\n    return [msg, null]\n}\nreturn [null, msg];","outputs":2,"noerr":0,"x":350,"y":400,"wires":[["9d7531fc.54864"],["9d7531fc.54864","8d128375.785618"]]},{"id":"710a7755.c01198","type":"function","z":"1c7b4521.d6dd8b","name":"logic day","func":"const temperature = msg.payload.temperature.value;\n\nconst result = {temperature: 27, mode: 'cool', id: msg.payload.id};\nlet disable = false;\n\nif(temperature <= 24) {\n    result.temperature = 24;\n    result.mode = 'warm';\n}\n\n\nif(temperature < 26 && temperature > 24) {\n    disable = true;\n}\n\n\nif(temperature >= 26 && temperature <= 27) {\n    result.temperature = 27;\n    result.mode = 'cool';\n}\n\nif(temperature > 27) {\n    result.temperature = 26;\n    result.mode = 'cool';\n}\n\nconst cond = msg.conditionaire.find(x=>x.id === msg.payload.id);\n\nreturn [!disable ? {payload: result, c: cond, weather: msg.weather} : null, !disable ? null : {payload: {id: msg.payload.id}, c: cond}];","outputs":2,"noerr":0,"x":780,"y":380,"wires":[["953de29c.a119d"],["d7c1f595.13ea78"]]},{"id":"d7c1f595.13ea78","type":"switch","z":"1c7b4521.d6dd8b","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1150,"y":460,"wires":[["dbb256b8.001918"],["d1cef25e.164368"]]},{"id":"dbb256b8.001918","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["2b7f1d61.7b9482"],"x":1245,"y":440,"wires":[]},{"id":"d1cef25e.164368","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["2c9e4df4.90bed2"],"x":1245,"y":500,"wires":[]},{"id":"9acd7496.993ac8","type":"switch","z":"1c7b4521.d6dd8b","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1130,"y":340,"wires":[["992fc957.79b03"],["e4e612d1.6a455"]]},{"id":"992fc957.79b03","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["a017adec.b6faa8"],"x":1245,"y":320,"wires":[]},{"id":"e4e612d1.6a455","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["630292.63073d7"],"x":1245,"y":380,"wires":[]},{"id":"f878f8ca.96aa28","type":"function","z":"1c7b4521.d6dd8b","name":"logic night","func":"const temperature = msg.payload.temperature.value;\n\nconst result = {temperature: 27, mode: 'cool', id: msg.payload.id};\nlet disable = false;\n\nif(temperature <= 24) {\n    result.temperature = 24;\n    result.mode = 'warm';\n}\n\n\nif(temperature < 26.5 && temperature > 24) {\n    disable = true;\n}\n\n\nif(temperature >= 26.5 && temperature < 28) {\n    result.temperature = 27;\n    result.mode = 'cool';\n}\n\nif(temperature >= 28 && temperature < 30) {\n    result.temperature = 26;\n    result.mode = 'cool';\n}\n\nif(temperature >= 30) {\n    result.temperature = 25;\n    result.mode = 'cool';\n}\n\n\nconst cond = msg.conditionaire.find(x=>x.id === msg.payload.id);\n\n\nreturn [!disable ? {payload: result, c: cond, weather: msg.weather} : null, !disable ? null : {payload: {id: msg.payload.id}, c: cond}];","outputs":2,"noerr":0,"x":780,"y":420,"wires":[["953de29c.a119d"],["d7c1f595.13ea78"]]},{"id":"9d7531fc.54864","type":"time-range-switch","z":"1c7b4521.d6dd8b","name":"","lat":"55.755825","lon":"37.617298","startTime":"10:00","endTime":"sunset","startOffset":0,"endOffset":0,"x":580,"y":400,"wires":[["710a7755.c01198"],["f878f8ca.96aa28"]]},{"id":"292dad6c.f1bf8a","type":"link out","z":"1c7b4521.d6dd8b","name":"","links":["2c9e4df4.90bed2","2b7f1d61.7b9482"],"x":655,"y":500,"wires":[]},{"id":"8d128375.785618","type":"stoptimer","z":"1c7b4521.d6dd8b","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":500,"y":500,"wires":[["292dad6c.f1bf8a"],[]]},{"id":"ce700984.9563c","type":"link in","z":"1c7b4521.d6dd8b","name":"params in","links":["53ea8026.108e","27949440.7d1874","9a2db0f1.cfd4"],"x":195,"y":460,"wires":[["fcbf08e3.22a74"]]},{"id":"fcbf08e3.22a74","type":"function","z":"1c7b4521.d6dd8b","name":"set stop","func":"\nreturn {payload: 'stop'};","outputs":1,"noerr":0,"x":320,"y":500,"wires":[["8d128375.785618"]]},{"id":"62d9b328.98a764","type":"link in","z":"1c7b4521.d6dd8b","name":"params in","links":["2631cc6f.6b123c"],"x":35,"y":540,"wires":[["f592de43.c60358"]]},{"id":"f592de43.c60358","type":"function","z":"1c7b4521.d6dd8b","name":"some one home?","func":"if(msg.payload.presence) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":150,"y":540,"wires":[["fcbf08e3.22a74"]]},{"id":"1e2e6088.b1695f","type":"mqtt in dynamic","z":"93883042.bbe68","topic":"/zwave/changevalue/response","qos":"1","name":"zwave in","broker":"e312d9ea.c89338","x":1500,"y":80,"wires":[["452c0356.2bfaa4"]]},{"id":"452c0356.2bfaa4","type":"link out","z":"93883042.bbe68","name":"zwave in","links":["368e0577.4f9242","73296290.055b5c","69cb974a.54f25"],"x":1615,"y":80,"wires":[]},{"id":"69cb974a.54f25","type":"link in","z":"93883042.bbe68","name":"","links":["452c0356.2bfaa4"],"x":135,"y":1180,"wires":[["aece8100.6e18a8"]]},{"id":"468f57dc.c7aab8","type":"function","z":"93883042.bbe68","name":"cache","func":"msg.cache = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":1180,"wires":[["efdfb5b3.c7459","f68dab2e.17013","4c60cda5.f9b714"]]},{"id":"5cfdf8d.afac908","type":"function","z":"93883042.bbe68","name":"get light vika","func":"if(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 250) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 150) {\n    return [null, msg];\n}","outputs":2,"noerr":0,"x":2090,"y":1140,"wires":[["a61692d6.7935"],["a0e36f88.cc5588"]]},{"id":"aece8100.6e18a8","type":"function","z":"93883042.bbe68","name":"some one home? and nodes","func":"if(msg.payload.node_id !== 33 && msg.payload.node_id !== 31 && msg.payload.node_id !== 29) return;\n\nif(global.get('presence') && !global.get('isNight')) {\n    return msg;\n}\n\n\nreturn;","outputs":1,"noerr":0,"x":380,"y":1180,"wires":[["468f57dc.c7aab8"]]},{"id":"5f318294.d0ec0c","type":"function","z":"93883042.bbe68","name":"get light living","func":"if(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 350) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 250) {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2100,"y":1180,"wires":[["e82efebf.e82828"],["a94655ec.c34b"]]},{"id":"30c50810.e05b2","type":"function","z":"93883042.bbe68","name":"get light kitchen","func":"if(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value >= 300) {\n    return [msg, null];\n}\n\nif(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 49 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 3 &&\nmsg.cache.value <= 250) {\n    return [null, msg];\n}\n","outputs":2,"noerr":0,"x":2100,"y":1220,"wires":[["deb85d25.8e8c68"],["ff6049d3.d5df7"]]},{"id":"a94655ec.c34b","type":"function","z":"93883042.bbe68","name":"open livingroom","func":"const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2380,"y":1180,"wires":[["873d0b58.b03b28"]]},{"id":"a0e36f88.cc5588","type":"function","z":"93883042.bbe68","name":"open vika","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2360,"y":1100,"wires":[["9c30f59e.5cadf8"]]},{"id":"ff6049d3.d5df7","type":"function","z":"93883042.bbe68","name":"open kitchen","func":"const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 99\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2370,"y":1260,"wires":[["184bad8f.03280a"]]},{"id":"9c30f59e.5cadf8","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2475,"y":1100,"wires":[]},{"id":"873d0b58.b03b28","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2495,"y":1180,"wires":[]},{"id":"184bad8f.03280a","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2475,"y":1260,"wires":[]},{"id":"a61692d6.7935","type":"function","z":"93883042.bbe68","name":"half open vika","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2340,"y":1060,"wires":[["5ccb0e56.e5faf"]]},{"id":"5ccb0e56.e5faf","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2475,"y":1060,"wires":[]},{"id":"7ed56e69.6d4c28","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2535,"y":1140,"wires":[]},{"id":"e82efebf.e82828","type":"function","z":"93883042.bbe68","name":"half open livingroom","func":"const value = {\n        node_id: 11,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2400,"y":1140,"wires":[["7ed56e69.6d4c28"]]},{"id":"271833c9.bb4934","type":"link out","z":"93883042.bbe68","name":"","links":["3184e159.7495b6","56c6bee5.88f648"],"x":2515,"y":1220,"wires":[]},{"id":"deb85d25.8e8c68","type":"function","z":"93883042.bbe68","name":"half open kitchen","func":"const value = {\n        node_id: 25,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nmsg.payload = {};\nmsg.payload.value = value;\n\nreturn msg;","outputs":1,"noerr":0,"x":2390,"y":1220,"wires":[["271833c9.bb4934"]]},{"id":"929ef42d.939b1","type":"stoptimer","z":"3a3cfd59.03e752","duration":"4","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":540,"y":220,"wires":[["b21f31f5.3fe56"],[]]},{"id":"9bd40d2.14539f","type":"function","z":"3a3cfd59.03e752","name":"check nodes","func":"if(msg.payload.node_id !== 2 && msg.payload.node_id !== 11 && msg.payload.node_id !== 25) return;\n\nif(msg.payload.class_id === 38 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) return msg;\n\nreturn;","outputs":1,"noerr":0,"x":190,"y":240,"wires":[["6e2cc1c7.bcf788"]]},{"id":"6e2cc1c7.bcf788","type":"switch","z":"3a3cfd59.03e752","name":"","property":"payload.node_id","propertyType":"msg","rules":[{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"11","vt":"num"},{"t":"eq","v":"25","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":350,"y":240,"wires":[["929ef42d.939b1"],["cdd75948.ca8eb"],["84ad8182.fa3488"]]},{"id":"cdd75948.ca8eb","type":"stoptimer","z":"3a3cfd59.03e752","duration":"4","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":540,"y":260,"wires":[["b21f31f5.3fe56"],[]]},{"id":"84ad8182.fa3488","type":"stoptimer","z":"3a3cfd59.03e752","duration":"4","units":"Second","payloadtype":"num","payloadval":"0","name":"","x":540,"y":300,"wires":[["b21f31f5.3fe56"],[]]},{"id":"1b16bf4c.8a6329","type":"mqtt in dynamic","z":"3a3cfd59.03e752","topic":"/system/night","qos":"1","name":"night event","broker":"e312d9ea.c89338","x":1750,"y":260,"wires":[["d7230e30.a1886"]]},{"id":"d7230e30.a1886","type":"function","z":"3a3cfd59.03e752","name":"check night","func":"if(msg.payload.night === false) return;\nreturn msg;","outputs":1,"noerr":0,"x":1910,"y":260,"wires":[["84711f79.98cb18"]]},{"id":"84711f79.98cb18","type":"link out","z":"3a3cfd59.03e752","name":"night on","links":["84b0ee6d.896038"],"x":2035,"y":260,"wires":[]},{"id":"84b0ee6d.896038","type":"link in","z":"3a3cfd59.03e752","name":"","links":["84711f79.98cb18"],"x":55,"y":400,"wires":[["3d6526ee.5e7122","c31ad1.f49f453","4ac942ce.1d2e94"]]},{"id":"3d6526ee.5e7122","type":"function","z":"3a3cfd59.03e752","name":"check vika","func":"msg.payload = 2;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":360,"wires":[["1c8ac72e.06c779"]]},{"id":"c31ad1.f49f453","type":"function","z":"3a3cfd59.03e752","name":"check living","func":"msg.payload = 11;\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":400,"wires":[["da91a0c.ed728e"]]},{"id":"4ac942ce.1d2e94","type":"function","z":"3a3cfd59.03e752","name":"check kitchen","func":"msg.payload = 25;\n\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":440,"wires":[["75359509.199d0c"]]},{"id":"75359509.199d0c","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","name":"","env":[],"x":460,"y":440,"wires":[[],["280e8107.afee16"]]},{"id":"da91a0c.ed728e","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","x":460,"y":400,"wires":[[],["9371a1be.8e2c88"]]},{"id":"1c8ac72e.06c779","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","name":"","env":[],"x":460,"y":360,"wires":[[],["1a02985d.638c58"]]},{"id":"1a02985d.638c58","type":"function","z":"3a3cfd59.03e752","name":"set vika","func":"msg.payload = {nodeid: 2};\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":340,"wires":[["f76e6b99.6464a8"]]},{"id":"9371a1be.8e2c88","type":"function","z":"3a3cfd59.03e752","name":"set living","func":"msg.payload = {nodeid: 11};\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":380,"wires":[["f76e6b99.6464a8"]]},{"id":"280e8107.afee16","type":"function","z":"3a3cfd59.03e752","name":"setkitchen","func":"msg.payload = {nodeid: 25};\n\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":420,"wires":[["f76e6b99.6464a8"]]},{"id":"b65c08c2.8c05e","type":"influxdb out","z":"f2224d70.f96078","influxdb":"d47f185f.a8541","name":"save influx","measurement":"","precision":"","retentionPolicy":"","x":1080,"y":40,"wires":[]},{"id":"a52f7c7.379358","type":"function","z":"f2224d70.f96078","name":"add measurement","func":"msg.measurement = 'weather';\nmsg.payload = [{\n            temperature: Number(msg.payload.currently.temperature),\n            precip: Number(msg.payload.currently.precipProbability * 100)\n        }];\n        \nreturn msg;","outputs":1,"noerr":0,"x":880,"y":40,"wires":[["b65c08c2.8c05e"]]},{"id":"efdfb5b3.c7459","type":"function","z":"93883042.bbe68","name":"get switch vika","func":"msg.nodeid = 4;\nmsg.payload = {nodeid: 4};\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":1140,"wires":[["4ab798c1.8c99f"]]},{"id":"4ab798c1.8c99f","type":"mongodb in","z":"93883042.bbe68","mongodb":"b0c4e7bf.f27208","name":"get switch","collection":"zwave-nodes","operation":"find","x":1020,"y":1140,"wires":[["eecb0459.a2ca8"]]},{"id":"f68dab2e.17013","type":"function","z":"93883042.bbe68","name":"get switch living","func":"msg.nodeid = 9;\nmsg.payload = {nodeid: 9};\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":1180,"wires":[["e997fdc0.2d1898"]]},{"id":"4c60cda5.f9b714","type":"function","z":"93883042.bbe68","name":"get switch kitchen","func":"msg.nodeid = 39;\nmsg.payload = {nodeid: 39};\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":1220,"wires":[["858654d8.4d756"]]},{"id":"eecb0459.a2ca8","type":"function","z":"93883042.bbe68","name":"check light","func":"const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1210,"y":1140,"wires":[["aed8c0c8.a3263"]]},{"id":"aed8c0c8.a3263","type":"function","z":"93883042.bbe68","name":"check vika","func":"msg.payload = 2;\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1140,"wires":[["c108871a.ca2f38"]]},{"id":"f1a7abd4.3ee23","type":"function","z":"93883042.bbe68","name":"check living","func":"msg.payload = 11;\n\nreturn msg;","outputs":1,"noerr":0,"x":1430,"y":1180,"wires":[["101c2292.32804d"]]},{"id":"b509d9a0.60d108","type":"function","z":"93883042.bbe68","name":"check kitchen","func":"msg.payload = 25;\n\nreturn msg;","outputs":1,"noerr":0,"x":1440,"y":1220,"wires":[["b5b94cb0.f4ec3"]]},{"id":"b5b94cb0.f4ec3","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","name":"","env":[],"x":1660,"y":1220,"wires":[[],["e9b14fd6.f5928"]]},{"id":"101c2292.32804d","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","x":1660,"y":1180,"wires":[[],["2660db51.11a074"]]},{"id":"c108871a.ca2f38","type":"subflow:9ae1a772.3c7408","z":"93883042.bbe68","name":"","env":[],"x":1660,"y":1140,"wires":[[],["7661378e.357cd8"]]},{"id":"e997fdc0.2d1898","type":"mongodb in","z":"93883042.bbe68","mongodb":"b0c4e7bf.f27208","name":"get switch","collection":"zwave-nodes","operation":"find","x":1020,"y":1180,"wires":[["8eeffefb.61b4b8"]]},{"id":"8eeffefb.61b4b8","type":"function","z":"93883042.bbe68","name":"check light","func":"const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1210,"y":1180,"wires":[["f1a7abd4.3ee23"]]},{"id":"858654d8.4d756","type":"mongodb in","z":"93883042.bbe68","mongodb":"b0c4e7bf.f27208","name":"get switch","collection":"zwave-nodes","operation":"find","x":1020,"y":1220,"wires":[["743aaeb4.7805c"]]},{"id":"743aaeb4.7805c","type":"function","z":"93883042.bbe68","name":"check light","func":"const findSwitch = msg.payload.find(x=>x.nodeid === msg.nodeid);\n\nif(msg.nodeid === 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-37-1-0` && x.value)) {\n    return;\n}\n\nif(msg.nodeid !== 39 && findSwitch.values.some(x=>x.value_id === `${msg.nodeid}-38-1-0` && x.value > 0)) {\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1210,"y":1220,"wires":[["b509d9a0.60d108"]]},{"id":"7b66c9f8.7bae58","type":"cron scheduler","z":"93883042.bbe68","name":"weekday","schedule":"0 40 6 * * *","x":80,"y":300,"wires":[["a318356a.98b46"]]},{"id":"a318356a.98b46","type":"subflow:8f22b76d.1c6718","z":"93883042.bbe68","name":"","x":270,"y":300,"wires":[[],["22f9657d.a39e8a"]]},{"id":"22f9657d.a39e8a","type":"function","z":"93883042.bbe68","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":470,"y":300,"wires":[["916328a3.f349a","eee3de9e.6a94d"]]},{"id":"126aa53a.d228f3","type":"function","z":"93883042.bbe68","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":490,"y":360,"wires":[["96eb7e23.99e938","916328a3.f349a","eee3de9e.6a94d"]]},{"id":"aa2200bf.8138b","type":"link in","z":"3a3cfd59.03e752","name":"","links":["52497519.186f3c"],"x":115,"y":1720,"wires":[["e53bfc2e.24a7e"]]},{"id":"f0f81469.6c9b78","type":"function","z":"3a3cfd59.03e752","name":"cache","func":"msg.cache = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":530,"y":1720,"wires":[["9edc367e.8c48","df64347d.042808","fd8b7945.56d8e8"]]},{"id":"e53bfc2e.24a7e","type":"function","z":"3a3cfd59.03e752","name":"some one home? and nodes","func":"if(msg.payload.node_id !== 33 &&\nmsg.payload.node_id !== 31 &&\nmsg.payload.node_id !== 29 &&\nmsg.payload.node_id !== 2 &&\nmsg.payload.node_id !== 11 &&\nmsg.payload.node_id !== 25) \nreturn;\n\nif(global.get('presence') && !global.get('isNight')) {\n    return msg;\n}\n\n\nreturn;","outputs":1,"noerr":0,"x":320,"y":1720,"wires":[["f0f81469.6c9b78"]]},{"id":"9edc367e.8c48","type":"function","z":"3a3cfd59.03e752","name":"check vika","func":"msg.payload = 2;\n\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1540,"wires":[["d7262ab8.cfd3"]]},{"id":"df64347d.042808","type":"function","z":"3a3cfd59.03e752","name":"check living","func":"msg.payload = 11;\n\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":1720,"wires":[["8187b121.dcd36"]]},{"id":"fd8b7945.56d8e8","type":"function","z":"3a3cfd59.03e752","name":"check kitchen","func":"msg.payload = 25;\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":1880,"wires":[["e0cb45b3.db2d28"]]},{"id":"e0cb45b3.db2d28","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","name":"","env":[],"x":1000,"y":1880,"wires":[["f7314c1a.5d1a8"],["a5303787.d70d08"]]},{"id":"8187b121.dcd36","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","x":980,"y":1720,"wires":[["abc5730c.82aa38"],["96606069.bdb518"]]},{"id":"d7262ab8.cfd3","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","name":"","env":[],"x":960,"y":1540,"wires":[["7ffe83b7.c71124"],["8cef0830.3878e"]]},{"id":"e29e649d.8eb5","type":"influxdb in","z":"c06450d5.5deb8","influxdb":"d47f185f.a8541","name":"get temp","query":"SELECT MEAN(\"temperature\") FROM \"statistics\".\"autogen\".\"weather\" WHERE time > now() - 5d GROUP BY time(5d) fill(null)","rawOutput":false,"precision":"","retentionPolicy":"","x":260,"y":140,"wires":[["d3cec2d4.74a54"]]},{"id":"66fdfe8f.75aee8","type":"inject","z":"c06450d5.5deb8","name":"","topic":"","payload":"{}","payloadType":"json","repeat":"86400","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":140,"wires":[["e29e649d.8eb5"]]},{"id":"d3cec2d4.74a54","type":"function","z":"c06450d5.5deb8","name":"check avarage temp","func":"const pop = {\n    payload: [7,24,32]\n};\n\nconst temp = msg.payload[1];\nif(temp.mean <= 14) {\n    return [pop, null];\n}\nreturn [null, pop];","outputs":2,"noerr":0,"x":490,"y":140,"wires":[["61f2e6fc.3c5e4"],["fe2fb996.371838"]]},{"id":"d3cc57af.6ffef8","type":"mqtt out dynamic","z":"c06450d5.5deb8","name":"zwave out","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1840,"y":60,"wires":[]},{"id":"898fbe58.81f778","type":"link in","z":"c06450d5.5deb8","name":"zwave out","links":["c2422399.e79ed","2e7e2da6.fd39e2"],"x":1695,"y":60,"wires":[["d3cc57af.6ffef8"]]},{"id":"cd18fbdc.36613","type":"function","z":"c06450d5.5deb8","name":"turn on","func":"const value = {\n        node_id: msg.payload,\n        class_id: 67,\n        instance: 1,\n        index: 1,\n        value: 28\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":900,"y":100,"wires":[["2e7e2da6.fd39e2"]]},{"id":"2e7e2da6.fd39e2","type":"link out","z":"c06450d5.5deb8","name":"","links":["898fbe58.81f778"],"x":1005,"y":100,"wires":[]},{"id":"55698262.cb6524","type":"function","z":"c06450d5.5deb8","name":"turn off","func":"const value = {\n        node_id: msg.payload,\n        class_id: 67,\n        instance: 1,\n        index: 1,\n        value: 20\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":900,"y":160,"wires":[["c2422399.e79ed"]]},{"id":"c2422399.e79ed","type":"link out","z":"c06450d5.5deb8","name":"","links":["898fbe58.81f778"],"x":1005,"y":160,"wires":[]},{"id":"b048e762.36a77","type":"function","z":"3a3cfd59.03e752","name":"turn on","func":"const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2260,"y":1480,"wires":[["bd5dc5d0.41035"]]},{"id":"bd5dc5d0.41035","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":2375,"y":1480,"wires":[]},{"id":"61f2e6fc.3c5e4","type":"split","z":"c06450d5.5deb8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":690,"y":120,"wires":[["cd18fbdc.36613"]]},{"id":"fe2fb996.371838","type":"split","z":"c06450d5.5deb8","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":690,"y":160,"wires":[["55698262.cb6524"]]},{"id":"1aaba25d.545fee","type":"function","z":"3a3cfd59.03e752","name":"turn on","func":"const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2300,"y":1700,"wires":[["f23a488c.e59ad8"]]},{"id":"f23a488c.e59ad8","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":2415,"y":1700,"wires":[]},{"id":"88347001.cd6c28","type":"function","z":"3a3cfd59.03e752","name":"turn on","func":"const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2360,"y":1920,"wires":[["de5bea5d.c5a88"]]},{"id":"de5bea5d.c5a88","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":2475,"y":1920,"wires":[]},{"id":"5693f439.2c6e74","type":"stoptimer","z":"3a3cfd59.03e752","duration":"30","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":2100,"y":1440,"wires":[["9d664428.89f388"],[]]},{"id":"9d664428.89f388","type":"function","z":"3a3cfd59.03e752","name":"turn off","func":"const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 1\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2260,"y":1440,"wires":[["bd5dc5d0.41035"]]},{"id":"f0a05662.1754b8","type":"function","z":"3a3cfd59.03e752","name":"turn off","func":"const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2300,"y":1660,"wires":[["f23a488c.e59ad8"]]},{"id":"60870c07.625ff4","type":"stoptimer","z":"3a3cfd59.03e752","duration":"30","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":2120,"y":1660,"wires":[["f0a05662.1754b8"],[]]},{"id":"802a19a7.1eaef8","type":"stoptimer","z":"3a3cfd59.03e752","duration":"30","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":2200,"y":1840,"wires":[["1d03cf57.611801"],[]]},{"id":"1d03cf57.611801","type":"function","z":"3a3cfd59.03e752","name":"turn off","func":"const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":2360,"y":1880,"wires":[["de5bea5d.c5a88"]]},{"id":"7000c3d2.890694","type":"function","z":"fd825ba0.07d958","name":"check db","func":"msg.payload = {nodeid: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":140,"wires":[["87c507da.622"]]},{"id":"87c507da.622","type":"mongodb in","z":"fd825ba0.07d958","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":380,"y":140,"wires":[["39f29dd.de3d4e2"]]},{"id":"39f29dd.de3d4e2","type":"function","z":"fd825ba0.07d958","name":"get lux","func":"if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-49-1-3`);\n        if(value)\n        return {payload: value.value};\n}","outputs":1,"noerr":0,"x":510,"y":140,"wires":[[]]},{"id":"8cef0830.3878e","type":"function","z":"3a3cfd59.03e752","name":"get movement vika","func":"if(msg.cache.node_id === 33 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n      return {payload: 33};\n}","outputs":1,"noerr":0,"x":1370,"y":1560,"wires":[["7bbec0c3.b19c6"]]},{"id":"7bbec0c3.b19c6","type":"subflow:fd825ba0.07d958","z":"3a3cfd59.03e752","name":"","env":[],"x":1530,"y":1560,"wires":[["d91d68ed.488008"]]},{"id":"d91d68ed.488008","type":"function","z":"3a3cfd59.03e752","name":"check lux","func":"if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1660,"y":1560,"wires":[["cf1b9c41.610ac","8346ecd9.3972e8"]]},{"id":"bcad19f0.2308b8","type":"function","z":"3a3cfd59.03e752","name":"check lux","func":"if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1700,"y":1760,"wires":[["e91d49ab.bb429","3cb535bb.2777fa"]]},{"id":"5a1bc8cd.f223d","type":"subflow:fd825ba0.07d958","z":"3a3cfd59.03e752","name":"","env":[],"x":1570,"y":1760,"wires":[["bcad19f0.2308b8"]]},{"id":"96606069.bdb518","type":"function","z":"3a3cfd59.03e752","name":"get movement living","func":"if(msg.cache.node_id === 31 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n      return {payload: 31};\n}","outputs":1,"noerr":0,"x":1380,"y":1760,"wires":[["5a1bc8cd.f223d"]]},{"id":"a5303787.d70d08","type":"function","z":"3a3cfd59.03e752","name":"get movement kitchen","func":"if(msg.cache.node_id === 29 &&\n    msg.cache.class_id === 113 &&\nmsg.cache.instance === 1 &&\nmsg.cache.index === 10 &&\nmsg.cache.value === 8) {\n    return {payload: 29};\n}","outputs":1,"noerr":0,"x":1480,"y":1940,"wires":[["25c1b43a.a1f224"]]},{"id":"25c1b43a.a1f224","type":"subflow:fd825ba0.07d958","z":"3a3cfd59.03e752","name":"","env":[],"x":1670,"y":1940,"wires":[["46509aa8.9f809c"]]},{"id":"46509aa8.9f809c","type":"function","z":"3a3cfd59.03e752","name":"check lux","func":"if((msg.payload <= 10 && msg.payload >= 0) || global.get('isNight')) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1800,"y":1940,"wires":[["68660394.10dd24","505cb579.2c83d4"]]},{"id":"fe0bcf41.c942b","type":"link in","z":"3a3cfd59.03e752","name":"","links":["52497519.186f3c"],"x":75,"y":1160,"wires":[["5b86e019.5867c","b0cf526e.8a1ca8"]]},{"id":"5b86e019.5867c","type":"function","z":"3a3cfd59.03e752","name":"check motion","func":"if(msg.payload.class_id === 113 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 10 &&\nmsg.payload.value === 8 && \nmsg.payload.node_id === 48) {\n    const status = flow.get('bth_status');\n\n    if(status !== 'closed') {\n         return {payload: {}};\n    }\n}\n\nreturn;\n","outputs":1,"noerr":0,"x":190,"y":1160,"wires":[["77352e5f.d26c2","19e023af.fc67bc","7c40fbb5.43f964"]]},{"id":"b0cf526e.8a1ca8","type":"function","z":"3a3cfd59.03e752","name":"check door","func":"const status = flow.get('bth_status');\n\nif(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0 &&\nmsg.payload.node_id === 35) {\n    if(!msg.payload.value) {\n        flow.set('bth_status', 'closed');\n        return [{payload: 'stop'}, null];\n    }\n    \n     if(msg.payload.value && status === 'closed') {\n        flow.set('bth_status', undefined);\n        return [null, {payload: {}}];\n    }\n}\n\nreturn;\n","outputs":2,"noerr":0,"x":190,"y":1280,"wires":[["44949538.0ffb3c","cdfe424e.57531"],["cdfe424e.57531"]]},{"id":"612e27c8.65c96","type":"function","z":"3a3cfd59.03e752","name":"should turn on","func":"const value = {\n        node_id: 17,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":920,"y":1120,"wires":[["82306f75.b78bc"]]},{"id":"82306f75.b78bc","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1055,"y":1120,"wires":[]},{"id":"44949538.0ffb3c","type":"stoptimer","z":"3a3cfd59.03e752","duration":"15","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":920,"y":1180,"wires":[["2367423e.8eabde"],[]]},{"id":"7f2960a8.91c5e","type":"function","z":"3a3cfd59.03e752","name":"should turn off","func":"const value = {\n        node_id: 17,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n    \n    flow.set('bth_status', undefined);\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":1680,"y":1180,"wires":[["96d818a3.d5dd18"]]},{"id":"96d818a3.d5dd18","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":1815,"y":1180,"wires":[]},{"id":"cdfe424e.57531","type":"stoptimer","z":"3a3cfd59.03e752","duration":"2","units":"Minute","payloadtype":"num","payloadval":"0","name":"","x":920,"y":1240,"wires":[["7f2960a8.91c5e"],[]]},{"id":"883cfd56.aead58","type":"switch","z":"ff9f5d72.eb6f2","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"stop","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":780,"wires":[["95ef3a70.ab42"],["8576af59.97f8c8"]]},{"id":"95ef3a70.ab42","type":"delay","z":"ff9f5d72.eb6f2","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":310,"y":720,"wires":[["41a95b74.441cac"]]},{"id":"77352e5f.d26c2","type":"function","z":"3a3cfd59.03e752","name":"stop off","func":"return {payload: 'stop'};","outputs":1,"noerr":0,"x":360,"y":1080,"wires":[["cdfe424e.57531"]]},{"id":"18a65679.750f5a","type":"function","z":"dcdd460.216ae38","name":"check db","func":"msg.payload = {nodeid: msg.payload};\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":100,"wires":[["90f64ef4.7db248"]]},{"id":"90f64ef4.7db248","type":"mongodb in","z":"dcdd460.216ae38","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":420,"y":100,"wires":[["3d7cbbc6.6b1324"]]},{"id":"3d7cbbc6.6b1324","type":"function","z":"dcdd460.216ae38","name":"get humidity","func":"if(msg.payload && msg.payload.length) {\n    const zNode = msg.payload[0];\n    const value = zNode.values.find(x=>x.value_id === `${x.node_id}-49-1-5`);\n        if(value)\n        return {payload: value.value};\n}","outputs":1,"noerr":0,"x":570,"y":100,"wires":[[]]},{"id":"2a6190f7.06cba8","type":"subflow:dcdd460.216ae38","z":"3a3cfd59.03e752","name":"","env":[],"x":550,"y":1180,"wires":[["7250d5c6.d7ed24"]]},{"id":"19e023af.fc67bc","type":"function","z":"3a3cfd59.03e752","name":"get hum","func":"return {payload: 48};","outputs":1,"noerr":0,"x":390,"y":1180,"wires":[["2a6190f7.06cba8"]]},{"id":"7250d5c6.d7ed24","type":"function","z":"3a3cfd59.03e752","name":"save hum","func":"flow.set('bath_hum', msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":730,"y":1180,"wires":[["44949538.0ffb3c"]]},{"id":"2367423e.8eabde","type":"function","z":"3a3cfd59.03e752","name":"get hum","func":"return {payload: 48};","outputs":1,"noerr":0,"x":1080,"y":1180,"wires":[["15110508.3ef823"]]},{"id":"15110508.3ef823","type":"subflow:dcdd460.216ae38","z":"3a3cfd59.03e752","name":"","env":[],"x":1240,"y":1180,"wires":[["e353fee.3687a"]]},{"id":"e353fee.3687a","type":"function","z":"3a3cfd59.03e752","name":"check hum","func":"const savedHum = flow.get('bath_hum');\n\nif(savedHum < msg.payload) {\n    return [{payload:{}}, null];\n}\n\nreturn [null, {payload:{}}];","outputs":2,"noerr":0,"x":1410,"y":1120,"wires":[["44949538.0ffb3c"],["7f2960a8.91c5e"]]},{"id":"763830dd.6be2b","type":"link in","z":"3a3cfd59.03e752","name":"","links":["f1d0d3f2.b7f2c8"],"x":160,"y":2420,"wires":[["5cdbb1c9.a9527"]]},{"id":"7f5703c9.c7d2ec","type":"function","z":"3a3cfd59.03e752","name":"switch off","func":"const value = {\n        node_id: 39,\n        class_id: 37,\n        instance: 2,\n        index: 0,\n        value: false\n    };\n    \n    const value1 = {\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: false\n    };\n    \n    const nodes = [39, 17].\n    map(x=> ({...value1, node_id: x}));\n    \n    nodes.push(value);\n    \n    \nreturn {payload: nodes};","outputs":1,"noerr":0,"x":480,"y":2400,"wires":[["f6416919.2c4f68"]]},{"id":"96a446f1.0df85","type":"function","z":"3a3cfd59.03e752","name":"switch off dimmers","func":"const value = {\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 0\n    };\n    \n    \nconst nodes = [4, 5, 9, 10, 14].map(x=>({\n    node_id: x,\n    ...value\n}));\n    \n    \nreturn {payload: nodes};","outputs":1,"noerr":0,"x":510,"y":2440,"wires":[["f6416919.2c4f68"]]},{"id":"43f84c8.16fe134","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":975,"y":2420,"wires":[]},{"id":"f6416919.2c4f68","type":"split","z":"3a3cfd59.03e752","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":690,"y":2420,"wires":[["d4ee43ab.9e3ae"]]},{"id":"d4ee43ab.9e3ae","type":"function","z":"3a3cfd59.03e752","name":"map to value","func":"\nreturn {\n    payload: {\n        value: msg.payload\n    }\n};","outputs":1,"noerr":0,"x":840,"y":2420,"wires":[["43f84c8.16fe134"]]},{"id":"5d35ecad.a751ec","type":"comment","z":"3a3cfd59.03e752","name":"выключить весь свет когда все ушли","info":"","x":350,"y":2320,"wires":[]},{"id":"8346ecd9.3972e8","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":"0","x":1880,"y":1520,"wires":[["b048e762.36a77","5693f439.2c6e74"],[]]},{"id":"cf1b9c41.610ac","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"13:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1880,"y":1560,"wires":[["b048e762.36a77","5693f439.2c6e74"],[]]},{"id":"e91d49ab.bb429","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"13:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1900,"y":1760,"wires":[["60870c07.625ff4","1aaba25d.545fee"],[]]},{"id":"3cb535bb.2777fa","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":"0","x":1900,"y":1720,"wires":[["60870c07.625ff4","1aaba25d.545fee"],[]]},{"id":"68660394.10dd24","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"13:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1980,"y":1940,"wires":[["802a19a7.1eaef8","88347001.cd6c28"],[]]},{"id":"505cb579.2c83d4","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"sunset","endTime":"sunrise","startOffset":0,"endOffset":"0","x":1980,"y":1900,"wires":[["802a19a7.1eaef8","88347001.cd6c28"],[]]},{"id":"a206be68.c8db78","type":"function","z":"dc8c9c.eb0bdb68","name":"check dimmer","func":"msg.cache = msg.payload;\nmsg.payload = {id: 'dimmer'};\n\nreturn msg;","outputs":1,"noerr":0,"x":840,"y":400,"wires":[["d3810429.bf0f"]]},{"id":"d3810429.bf0f","type":"mongodb in","z":"dc8c9c.eb0bdb68","mongodb":"b0c4e7bf.f27208","name":"get code","collection":"conditionare","operation":"find","x":1000,"y":400,"wires":[["4555f514.17b3d4"]]},{"id":"4555f514.17b3d4","type":"function","z":"dc8c9c.eb0bdb68","name":"set code","func":"msg.code = msg.payload[0];\nmsg.payload = msg.cache;\n\ndelete msg.cache;\n\nreturn msg;","outputs":1,"noerr":0,"x":1140,"y":400,"wires":[["8fd7e954.887ae8"]]},{"id":"7ffe83b7.c71124","type":"function","z":"3a3cfd59.03e752","name":"stop timer","func":"return {\n    payload: 'stop'\n};","outputs":1,"noerr":0,"x":1240,"y":1480,"wires":[["5693f439.2c6e74"]]},{"id":"abc5730c.82aa38","type":"function","z":"3a3cfd59.03e752","name":"stop timer","func":"return {\n    payload: 'stop'\n};","outputs":1,"noerr":0,"x":1300,"y":1700,"wires":[["60870c07.625ff4"]]},{"id":"f7314c1a.5d1a8","type":"function","z":"3a3cfd59.03e752","name":"stop timer","func":"return {\n    payload: 'stop'\n};","outputs":1,"noerr":0,"x":1320,"y":1860,"wires":[["802a19a7.1eaef8"]]},{"id":"c83beb9a.6bb91","type":"mongodb in","z":"dc8c9c.eb0bdb68","mongodb":"b0c4e7bf.f27208","name":"conditionaire","collection":"conditionare","operation":"find","x":290,"y":240,"wires":[["b99eb0f1.8d6648"]]},{"id":"d37cd07d.ec3ff","type":"function","z":"dc8c9c.eb0bdb68","name":"get cond status","func":"msg.cache = msg.payload;\nmsg.payload = {id: msg.payload.id};\n\nreturn msg;","outputs":1,"noerr":0,"x":120,"y":240,"wires":[["c83beb9a.6bb91"]]},{"id":"b99eb0f1.8d6648","type":"function","z":"dc8c9c.eb0bdb68","name":"set cond","func":"msg.c = msg.payload[0];\n\nmsg.payload = msg.cache;\ndelete msg.cache;\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["18268afa.0044cd"]]},{"id":"18268afa.0044cd","type":"function","z":"dc8c9c.eb0bdb68","name":"is on","func":"if(msg.c.enabled) {\n    return [msg, null];\n}\n\nreturn [null, msg];","outputs":2,"noerr":0,"x":570,"y":240,"wires":[["411b1a8e.db0bbc"],["788946ea.b96878"]]},{"id":"d4bfabcf.4f5118","type":"delay","z":"dc8c9c.eb0bdb68","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":660,"y":400,"wires":[["a206be68.c8db78"]]},{"id":"411b1a8e.db0bbc","type":"delay","z":"dc8c9c.eb0bdb68","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":720,"y":200,"wires":[["788946ea.b96878"]]},{"id":"fd30aea5.69c1f","type":"inject","z":"d82282fe.72a6f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":1300,"wires":[["7d01b6e5.3ca79"]]},{"id":"7661378e.357cd8","type":"time-range-switch","z":"93883042.bbe68","name":"","lat":"55.755825","lon":"37.617298","startTime":"14:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1900,"y":1140,"wires":[["5cfdf8d.afac908"],[]]},{"id":"2660db51.11a074","type":"time-range-switch","z":"93883042.bbe68","name":"","lat":"55.755825","lon":"37.617298","startTime":"14:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1900,"y":1180,"wires":[["5f318294.d0ec0c"],[]]},{"id":"e9b14fd6.f5928","type":"time-range-switch","z":"93883042.bbe68","name":"","lat":"55.755825","lon":"37.617298","startTime":"14:00","endTime":"sunset","startOffset":0,"endOffset":"0","x":1900,"y":1220,"wires":[["30c50810.e05b2"],[]]},{"id":"5cdbb1c9.a9527","type":"function","z":"3a3cfd59.03e752","name":"is presence","func":"if(msg.payload.presence) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":2420,"wires":[["96a446f1.0df85","7f5703c9.c7d2ec"]]},{"id":"7e939529.f9f8f4","type":"link out","z":"8cb7951c.d33fd8","name":"presence in","links":["4d66deb4.8ea67"],"x":1675,"y":360,"wires":[]},{"id":"35266516.cf91ca","type":"mqtt in dynamic","z":"8cb7951c.d33fd8","topic":"/system/presence","qos":"1","name":"presence event","broker":"e312d9ea.c89338","x":1500,"y":360,"wires":[["7e939529.f9f8f4"]]},{"id":"4d66deb4.8ea67","type":"link in","z":"8cb7951c.d33fd8","name":"","links":["7e939529.f9f8f4"],"x":55,"y":800,"wires":[["b00baf9e.89e68"]]},{"id":"b00baf9e.89e68","type":"function","z":"8cb7951c.d33fd8","name":"is presence","func":"if(!msg.payload.presence) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":185,"y":800,"wires":[["c9e8573f.0c5268"]]},{"id":"c9e8573f.0c5268","type":"function","z":"8cb7951c.d33fd8","name":"send status","func":"\nreturn {\n    topic: '/media/request',\n    payload: {\n        action: 'off'\n    }\n};","outputs":1,"noerr":0,"x":370,"y":800,"wires":[["4c43f240.4d7ef4"]]},{"id":"4c43f240.4d7ef4","type":"link out","z":"8cb7951c.d33fd8","name":"","links":["65cd534.797042c"],"x":495,"y":800,"wires":[]},{"id":"5fef6129.191d7","type":"function","z":"3a3cfd59.03e752","name":"check kitchen","func":"msg.lx = msg.payload[0];\n\nmsg.payload = 25;\n\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":100,"wires":[["345cecda.1ee77c"]]},{"id":"345cecda.1ee77c","type":"subflow:9ae1a772.3c7408","z":"3a3cfd59.03e752","name":"","env":[],"x":760,"y":100,"wires":[["caa5e285.7a4148"],["b5d9a26d.41013"]]},{"id":"caa5e285.7a4148","type":"function","z":"3a3cfd59.03e752","name":"send on","func":"const value = {\n        node_id: 14,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":1180,"y":100,"wires":[["e4ca0b03.e6455"]]},{"id":"f77a9d97.601678","type":"link in","z":"4a108442.009864","name":"","links":["1cc73222.e3e7f6"],"x":675,"y":1160,"wires":[["e94dc44b.bdd168"]]},{"id":"e94dc44b.bdd168","type":"function","z":"4a108442.009864","name":"check co2","func":"const co2 = msg.payload.co2;\nconst savedCo2 = context.get('co2') || 0;\n\nif(savedCo2 === 0) {\n    context.set('co2', co2);\n    return;\n}\n\nconst diff = co2 - savedCo2;\n\nif(co2 > 550) {\n    if(diff >= 100 || co2 >= 700) {\n        context.set('co2', co2);\n        \n        return {payload: co2 >= 700 ? 2 : 1};\n    }\n}\nelse {\n     if(diff <= -100 || co2 <= 500) {\n        context.set('co2', co2);\n        return {payload: -1};\n    }\n}\n\nreturn;","outputs":1,"noerr":0,"x":810,"y":1160,"wires":[["ddb9631d.61d8d"]]},{"id":"2cde44ce.1a6e8c","type":"subflow:cd15286e.157c08","z":"4a108442.009864","name":"","env":[],"x":1100,"y":1160,"wires":[["1f10337a.dda26d"]]},{"id":"1f10337a.dda26d","type":"function","z":"4a108442.009864","name":"set speed","func":"if(msg.payload.enabled) {\n    msg.temperature = msg.payload.temperature;\n    const speed = msg.payload.settedSpeed;\n    if(msg.cachedPayload > 0 && speed < 100) {\n        \n        let resultSpeed = speed + (msg.cachedPayload * 10) - (speed === 15 ? 5 : 0);\n        if(resultSpeed > 100) resultSpeed = 100;\n        return {temperature: msg.temperature, payload: resultSpeed};\n    }\n    if(msg.cachedPayload < 0 && speed > 15) {\n        let resultSpeed1 = speed + (msg.cachedPayload * 10);\n        if(resultSpeed1 < 15) resultSpeed1 = 15;\n        return {temperature: msg.temperature, payload: resultSpeed1};\n    }\n}","outputs":1,"noerr":0,"x":1320,"y":1160,"wires":[["d917f743.8c221"]]},{"id":"4e1280c1.de6918","type":"link out","z":"4a108442.009864","name":"","links":["f1d02c55.470488"],"x":2295,"y":1180,"wires":[]},{"id":"d917f743.8c221","type":"function","z":"4a108442.009864","name":"get weather","func":"msg.cachedPayload = msg.payload;\nmsg.payload = {id: 1};\nreturn msg;","outputs":1,"noerr":0,"x":1490,"y":1160,"wires":[["ec891c46.297ba8"]]},{"id":"ec891c46.297ba8","type":"mongodb in","z":"4a108442.009864","mongodb":"b0c4e7bf.f27208","name":"weather","collection":"weather","operation":"find","x":1660,"y":1160,"wires":[["7578be47.6069b"]]},{"id":"7578be47.6069b","type":"function","z":"4a108442.009864","name":"limit speed","func":"const weather = msg.payload[0];\nmsg.payload = msg.cachedPayload;\n\nif(weather.currently.temperature <= 12.5 && msg.payload > 40) {\n    msg.payload = 40;\n    \n    if(weather.currently.temperature <= 0) {\n        msg.payload = 30;\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1830,"y":1160,"wires":[["1c779ccf.838d53"]]},{"id":"6c2bb65f.7ce9e8","type":"link in","z":"4a108442.009864","name":"","links":["1cc73222.e3e7f6"],"x":735,"y":1240,"wires":[["5feef2b9.328bb4"]]},{"id":"1b9d6f09.25a591","type":"mongodb out","z":"4a108442.009864","mongodb":"b0c4e7bf.f27208","name":"save co2","collection":"co2","payonly":true,"upsert":true,"multi":false,"operation":"update","x":1080,"y":1240,"wires":[]},{"id":"5feef2b9.328bb4","type":"function","z":"4a108442.009864","name":"prepare msg","func":"const $set = {$set: msg.payload};\nconst query = {index: msg.payload.index};\n\nconst newMsg = {payload: $set, query: query};\nreturn newMsg;","outputs":1,"noerr":0,"x":870,"y":1240,"wires":[["1b9d6f09.25a591"]]},{"id":"8e77c2.3a49104","type":"inject","z":"4a108442.009864","name":"inject id","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":800,"y":1320,"wires":[["f2f4583b.ba46f8"]]},{"id":"437c80de.8a311","type":"mongodb in","z":"4a108442.009864","mongodb":"b0c4e7bf.f27208","name":"co2","collection":"co2","operation":"find","x":1170,"y":1320,"wires":[["3a22b460.cf2584"]]},{"id":"e157373b.f4d138","type":"link out","z":"4a108442.009864","name":"","links":["3400b1de.2233e6"],"x":1475,"y":1320,"wires":[]},{"id":"3a22b460.cf2584","type":"function","z":"4a108442.009864","name":"send all","func":"msg.topic = '/co2/all/response'\nreturn msg;","outputs":1,"noerr":0,"x":1360,"y":1320,"wires":[["e157373b.f4d138"]]},{"id":"f2f4583b.ba46f8","type":"function","z":"4a108442.009864","name":"inject ids","func":"msg.payload = {index: 1};\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":1320,"wires":[["437c80de.8a311"]]},{"id":"67290a45.1c1274","type":"mqtt in dynamic","z":"4a108442.009864","topic":"/co2/all/request","qos":"1","name":"co2 all in","broker":"e312d9ea.c89338","x":120,"y":1240,"wires":[["149c9f0d.f75769"]]},{"id":"149c9f0d.f75769","type":"link out","z":"4a108442.009864","name":"co2 interface in","links":["cf80ba2d.24685"],"x":235,"y":1240,"wires":[]},{"id":"cf80ba2d.24685","type":"link in","z":"4a108442.009864","name":"","links":["149c9f0d.f75769"],"x":835,"y":1380,"wires":[["f2f4583b.ba46f8"]]},{"id":"3400b1de.2233e6","type":"link in","z":"4a108442.009864","name":"co2 interface out","links":["e157373b.f4d138","e9274c5f.f358d"],"x":75,"y":1300,"wires":[["2e1f7e5d.951ea2"]]},{"id":"2e1f7e5d.951ea2","type":"mqtt out dynamic","z":"4a108442.009864","name":"co2 interface out","topic":"","qos":"1","retain":"","broker":"e312d9ea.c89338","x":230,"y":1300,"wires":[]},{"id":"e9274c5f.f358d","type":"link out","z":"4a108442.009864","name":"","links":["3400b1de.2233e6"],"x":995,"y":1520,"wires":[]},{"id":"6cc9b00e.9793c","type":"link in","z":"4a108442.009864","name":"","links":["1cc73222.e3e7f6"],"x":755,"y":1520,"wires":[["3228c7dc.41da3"]]},{"id":"3228c7dc.41da3","type":"function","z":"4a108442.009864","name":"prepare msg","func":"msg.topic = '/co2/interface/response';\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":1520,"wires":[["e9274c5f.f358d"]]},{"id":"ea654a7.2efadb8","type":"stoptimer","z":"d93a928a.102338","duration":"2","units":"Minute","payloadtype":"num","payloadval":"0","name":"wait","x":1250,"y":160,"wires":[["d2a48e22.c873a8"],[]]},{"id":"cae88e89.f2b198","type":"subflow:fdf44b03.831398","z":"d93a928a.102338","name":"","env":[],"x":1720,"y":280,"wires":[]},{"id":"e969a1e.f5525e","type":"function","z":"d93a928a.102338","name":"telegram transform","func":"return {\n    payload: {\n        content: 'Действие подтверждено'\n    }\n}","outputs":1,"noerr":0,"x":1470,"y":280,"wires":[["cae88e89.f2b198"]]},{"id":"1fb336a.a47d249","type":"link in","z":"3a3cfd59.03e752","name":"","links":["f1d0d3f2.b7f2c8"],"x":815,"y":1460,"wires":[["e23cd30a.89e02"]]},{"id":"e23cd30a.89e02","type":"function","z":"3a3cfd59.03e752","name":"is presence","func":"if(msg.payload.presence) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":945,"y":1460,"wires":[["7ffe83b7.c71124"]]},{"id":"28812a8f.c3ddf6","type":"link in","z":"3a3cfd59.03e752","name":"","links":["f1d0d3f2.b7f2c8"],"x":915,"y":1660,"wires":[["eed5f388.0596a8"]]},{"id":"eed5f388.0596a8","type":"function","z":"3a3cfd59.03e752","name":"is presence","func":"if(msg.payload.presence) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":1045,"y":1660,"wires":[["abc5730c.82aa38"]]},{"id":"1f2e49db.340916","type":"link in","z":"3a3cfd59.03e752","name":"","links":["f1d0d3f2.b7f2c8"],"x":915,"y":1820,"wires":[["2ad5488f.32cfe"]]},{"id":"2ad5488f.32cfe","type":"function","z":"3a3cfd59.03e752","name":"is presence","func":"if(msg.payload.presence) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":1045,"y":1820,"wires":[["f7314c1a.5d1a8"]]},{"id":"1c779ccf.838d53","type":"time-range-switch","z":"4a108442.009864","name":"","lat":"55.755825","lon":"37.617298","startTime":"23:05","endTime":"06:55","startOffset":0,"endOffset":"0","x":2020,"y":1160,"wires":[["b9f37e5c.5d5848"],["4e1280c1.de6918"]]},{"id":"b9f37e5c.5d5848","type":"function","z":"4a108442.009864","name":"limit speed","func":"if(msg.payload > 40) {\n    msg.payload = 40;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":2210,"y":1100,"wires":[["4e1280c1.de6918"]]},{"id":"4e8f4c5.1da7db4","type":"link out","z":"3a3cfd59.03e752","name":"lamels down","links":["1e333bbe.3ffc7c","70207dac.07d66c","70e9cba9.c25dfc"],"x":855,"y":160,"wires":[]},{"id":"1e333bbe.3ffc7c","type":"link in","z":"3a3cfd59.03e752","name":"","links":["4e8f4c5.1da7db4"],"x":815,"y":1400,"wires":[["ac79c4b6.fa2be"]]},{"id":"ac79c4b6.fa2be","type":"function","z":"3a3cfd59.03e752","name":"check lamels","func":"if(msg.payload.nodeid === 2)\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":1400,"wires":[["7ffe83b7.c71124"]]},{"id":"70207dac.07d66c","type":"link in","z":"3a3cfd59.03e752","name":"","links":["4e8f4c5.1da7db4"],"x":915,"y":1600,"wires":[["8998d6c8.47f688"]]},{"id":"8998d6c8.47f688","type":"function","z":"3a3cfd59.03e752","name":"check lamels","func":"if(msg.payload.nodeid === 11)\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":1600,"wires":[["abc5730c.82aa38"]]},{"id":"70e9cba9.c25dfc","type":"link in","z":"3a3cfd59.03e752","name":"","links":["4e8f4c5.1da7db4"],"x":915,"y":1780,"wires":[["45780229.13a2f4"]]},{"id":"45780229.13a2f4","type":"function","z":"3a3cfd59.03e752","name":"check lamels","func":"if(msg.payload.nodeid === 25)\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":1780,"wires":[["f7314c1a.5d1a8"]]},{"id":"f76e6b99.6464a8","type":"function","z":"3a3cfd59.03e752","name":"some one home?","func":"if(global.get('presence'))\n{\n    return msg;\n}\n","outputs":1,"noerr":0,"x":1130,"y":220,"wires":[["589d0e73.756b9"]]},{"id":"ad2e3bb9.682368","type":"inject","z":"51445fb5.e4d8f8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":520,"wires":[["d281caae.6568b"]]},{"id":"894be35e.4a76a","type":"function","z":"d93a928a.102338","name":"format","func":"const doorSensor = global.get('door');\nlet motionSensors = [15, 47, 46, 29, 31, 33]\n        .map(x =>({id: x, data: global.get(`motion_${x}`)})).filter(x=>x.data != null);\n    const joined = motionSensors.map(x => \" motion_\" + x.id + \": \" + x.data.lastMotion).join(\", \");    \n        \n\n\nlet message = doorSensor != null ? \" door: \" + doorSensor.lastOpenDate : \"\";\nmessage += joined;\n\nreturn {\n    payload: {\n        content: \"дома \" + message\n    }\n}","outputs":1,"noerr":0,"x":1290,"y":340,"wires":[[]]},{"id":"f6962f27.d5636","type":"function","z":"d93a928a.102338","name":"format","func":"const doorSensor = global.get('door');\nif(doorSensor)\n{\n    const doorClosedPeriod = doorSensor.lastCloseDate - doorSensor.lastOpenDate;\nif(global.get('presence') && doorClosedPeriod <= (60000 * 5)) \n{\n    return {\n    payload: {\n        content: \"движение или дверь \" + JSON.stringify(msg.payload)\n    }\n}\n}\n\n}\n\n","outputs":1,"noerr":0,"x":190,"y":120,"wires":[[]]},{"id":"ddb9631d.61d8d","type":"function","z":"4a108442.009864","name":"some one home?","func":"if(global.get('presence')) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":930,"y":1100,"wires":[["2cde44ce.1a6e8c"]]},{"id":"5a1ca11c.aee2d8","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {\"$or\":[{\"id\":\"ampon\"},{\"id\":\"switchon\"},{\"id\":\"switch2\"},{\"id\":\"tvon\"}]};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":320,"wires":[["c39faf7d.4ecb28"]]},{"id":"ff2cd6e7.7ff78","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {id: \"tvon\"};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":280,"wires":[["c39faf7d.4ecb28"]]},{"id":"1a8bafd6.a73a28","type":"function","z":"8cb7951c.d33fd8","name":"get data","func":"msg.payload = {id: \"tvoff\"};\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":240,"wires":[["c39faf7d.4ecb28"]]},{"id":"6f5c295a.72fed","type":"mqtt out dynamic","z":"93883042.bbe68","name":"send blinds open","topic":"/system/blinds/open","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1910,"y":80,"wires":[]},{"id":"85754c92.daa208","type":"link in","z":"93883042.bbe68","name":"send blind open","links":["8d65fad1.e1cdc","7e010cb8.324f6c"],"x":1755,"y":80,"wires":[["6f5c295a.72fed"]]},{"id":"5b42709c.d72a28","type":"function","z":"93883042.bbe68","name":"vika transform","func":"return {\n    payload: {room: \"vika\"}\n}","outputs":1,"noerr":0,"x":1460,"y":160,"wires":[["8d65fad1.e1cdc"]]},{"id":"8d65fad1.e1cdc","type":"link out","z":"93883042.bbe68","name":"","links":["85754c92.daa208"],"x":1595,"y":180,"wires":[]},{"id":"7e010cb8.324f6c","type":"link out","z":"93883042.bbe68","name":"","links":["85754c92.daa208"],"x":1955,"y":420,"wires":[]},{"id":"88550280.de9e4","type":"function","z":"93883042.bbe68","name":"living transform","func":"return {\n    payload: {room: \"living\"}\n}","outputs":1,"noerr":0,"x":1800,"y":380,"wires":[["7e010cb8.324f6c"]]},{"id":"9fca134e.63cc4","type":"comment","z":"3a3cfd59.03e752","name":"Включить свет в комнатах на подъем штор по будильнику","info":"","x":360,"y":2560,"wires":[]},{"id":"57f340c6.78aa1","type":"mqtt in dynamic","z":"3a3cfd59.03e752","topic":"/system/blinds/open","qos":"1","name":"blinds open in","broker":"e312d9ea.c89338","x":1770,"y":340,"wires":[["e03bed43.b48e78"]]},{"id":"e03bed43.b48e78","type":"link out","z":"3a3cfd59.03e752","name":"blinds open in","links":["e69d5473.981c68"],"x":1900,"y":340,"wires":[]},{"id":"e69d5473.981c68","type":"link in","z":"3a3cfd59.03e752","name":"","links":["e03bed43.b48e78"],"x":75,"y":2700,"wires":[["27750ab0.55ce26"]]},{"id":"27750ab0.55ce26","type":"function","z":"3a3cfd59.03e752","name":"check date","func":"const now = new Date();\nconst month = now.getMonth();\n\nif(month < 2 || month >= 10)\n    return msg;","outputs":1,"noerr":0,"x":200,"y":2700,"wires":[["97dc20a9.2a5348"]]},{"id":"77d3af02.3648f","type":"switch","z":"3a3cfd59.03e752","name":"check blinds","property":"payload.room","propertyType":"msg","rules":[{"t":"eq","v":"vika","vt":"str"},{"t":"eq","v":"living","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":2700,"wires":[["20e7182c.9a6728"],["ea4d8e94.051b2"]]},{"id":"ea4d8e94.051b2","type":"function","z":"3a3cfd59.03e752","name":"turn on living","func":"const value = {\n        node_id: 9,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: msg.value || 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":660,"y":2760,"wires":[["f1f68c99.869428","4cb61ce.4e609e4"]]},{"id":"f1f68c99.869428","type":"delay","z":"3a3cfd59.03e752","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":850,"y":2760,"wires":[["c20d8c34.a389b8"]]},{"id":"c20d8c34.a389b8","type":"function","z":"3a3cfd59.03e752","name":"check param","func":"if(msg.payload.value.value < 50)\nreturn {value: msg.payload.value.value + 1};","outputs":1,"noerr":0,"x":1070,"y":2760,"wires":[["ea4d8e94.051b2"]]},{"id":"4cb61ce.4e609e4","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":765,"y":2820,"wires":[]},{"id":"20e7182c.9a6728","type":"function","z":"3a3cfd59.03e752","name":"turn on vika","func":"const value = {\n        node_id: 4,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: msg.value || 1\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":700,"y":2620,"wires":[["f568d5b6.12e2e8","325dff65.bb4c7"]]},{"id":"f568d5b6.12e2e8","type":"delay","z":"3a3cfd59.03e752","name":"","pauseType":"delay","timeout":"500","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":2620,"wires":[["cb796a65.6bc48"]]},{"id":"cb796a65.6bc48","type":"function","z":"3a3cfd59.03e752","name":"check param","func":"if(msg.payload.value.value < 50)\nreturn {value: msg.payload.value.value + 1};","outputs":1,"noerr":0,"x":1120,"y":2620,"wires":[["20e7182c.9a6728"]]},{"id":"325dff65.bb4c7","type":"link out","z":"3a3cfd59.03e752","name":"","links":["700bb3d1.45cadc"],"x":805,"y":2680,"wires":[]},{"id":"97dc20a9.2a5348","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"03:00","endTime":"09:00","startOffset":0,"endOffset":0,"x":340,"y":2760,"wires":[["77d3af02.3648f"],[]]},{"id":"953de29c.a119d","type":"function","z":"1c7b4521.d6dd8b","name":"checks","func":"const vacation = global.get('vacation');\n\nif(vacation) return;\n\nif(msg.weather.currently.temperature < 1) return;\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":340,"wires":[["9acd7496.993ac8"]]},{"id":"e072c36a.66af3","type":"function","z":"1c7b4521.d6dd8b","name":"checks presence","func":"const presence = global.get('presence');\n\nmsg.presence = presence;\n\nreturn msg;","outputs":1,"noerr":0,"x":1570,"y":60,"wires":[["bbf26212.51c93"]]},{"id":"7c40fbb5.43f964","type":"time-range-switch","z":"3a3cfd59.03e752","name":"","lat":"55.755825","lon":"37.617298","startTime":"23:00","endTime":"06:00","startOffset":0,"endOffset":0,"x":640,"y":1100,"wires":[[],["612e27c8.65c96"]]},{"id":"12d9ca7f.4b7c56","type":"debug","z":"d82282fe.72a6f","name":"zwave in","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":140,"y":40,"wires":[]},{"id":"9a8b2db5.7bd458","type":"function","z":"b3e2291e.f32e58","name":"Set 30%","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 30\n    };\n\nconst setTemp = {\n        node_id: 8,\n        class_id: 67,\n        instance: 1,\n        index: 101,\n        value: '11.0'\n    };\n\nconst onOff = {\n        node_id: 6,\n        class_id: 37,\n        instance: 1,\n        index: 0,\n        value: true\n    };\n\nconst mode = {\n        node_id: 7,\n        class_id: 64,\n        instance: 1,\n        index: 0,\n        value: 'Heat'\n    };\n\n\nreturn {\n    payload: {\n        value: setTemp\n    }\n};","outputs":1,"noerr":0,"x":540,"y":240,"wires":[["5c873b60.3731d4"]]},{"id":"9f11778a.bedca8","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":240,"wires":[["9a8b2db5.7bd458"]]},{"id":"5c873b60.3731d4","type":"mqtt out dynamic","z":"b3e2291e.f32e58","name":"zwave out","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":720,"y":240,"wires":[]},{"id":"49170926.1b91d8","type":"function","z":"b3e2291e.f32e58","name":"Off","func":"const value = {\n        node_id: 2,\n        class_id: 38,\n        instance: 1,\n        index: 0,\n        value: 0\n    };\n    \n\nreturn {\n    payload: {\n        value: value\n    }\n};","outputs":1,"noerr":0,"x":540,"y":320,"wires":[["5c873b60.3731d4"]]},{"id":"5df313c6.5c00ec","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":320,"wires":[["49170926.1b91d8"]]},{"id":"c6244e99.f9d5e","type":"debug","z":"d82282fe.72a6f","name":"before","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":970,"y":460,"wires":[]},{"id":"76f137b5.3678c","type":"debug","z":"d82282fe.72a6f","name":"after","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":910,"y":560,"wires":[]},{"id":"c83f577.532e528","type":"debug","z":"d82282fe.72a6f","name":"second","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":1280,"wires":[]},{"id":"7d0939f7.fd9b2","type":"debug","z":"d82282fe.72a6f","name":"second after","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1080,"y":1300,"wires":[]},{"id":"5bb64a8f.23f9dc","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":320,"y":420,"wires":[["7b939f4c.d37918"]]},{"id":"7b939f4c.d37918","type":"function","z":"b3e2291e.f32e58","name":"get association","func":"const payload = msg.payload;\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\n//const args1 =  [6, 3];\nconst args1 =  [8, 3];\n\nreturn {\n    topic: 'getAssociations',\n//    topic: 'getAssociationsInstances',\n//    topic: 'isGroupMultiInstance',\n    payload: {\n//        args: args\n        args: args1\n    }\n}","outputs":1,"noerr":0,"x":520,"y":420,"wires":[["9384af42.bb9558","d8f02ccd.ea8918"]]},{"id":"d8f02ccd.ea8918","type":"debug","z":"b3e2291e.f32e58","name":"req","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":500,"wires":[]},{"id":"9384af42.bb9558","type":"zwave-out","z":"b3e2291e.f32e58","name":"get","controller":"77f89cfa.c3377c","x":690,"y":420,"wires":[["9fefe081.cabc48"]]},{"id":"9fefe081.cabc48","type":"debug","z":"b3e2291e.f32e58","name":"res","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":850,"y":420,"wires":[]},{"id":"98115819.90472","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":320,"y":580,"wires":[["26845d60.aedf02"]]},{"id":"26845d60.aedf02","type":"function","z":"b3e2291e.f32e58","name":"addAssociation","func":"const payload = msg.payload;\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\n//const args1 =  [4, 1, 1];\nconst args1 =  [6, 3, 7];\n//const args1 =  [8, 3, 7, 1];\n\nreturn {\n    topic: 'addAssociation',\n    payload: {\n//        args: args\n        args: args1\n    }\n}","outputs":1,"noerr":0,"x":500,"y":580,"wires":[["7e3f48a.6d8be38","d8f02ccd.ea8918"]]},{"id":"7e3f48a.6d8be38","type":"zwave-out","z":"b3e2291e.f32e58","name":"set","controller":"77f89cfa.c3377c","x":710,"y":580,"wires":[["9fefe081.cabc48"]]},{"id":"c224bdd2.a1788","type":"zwave-out","z":"b3e2291e.f32e58","name":"numGroups","controller":"77f89cfa.c3377c","x":690,"y":680,"wires":[["9fefe081.cabc48"]]},{"id":"d3dbee02.a7609","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":300,"y":680,"wires":[["cdf59733.bcb258"]]},{"id":"cdf59733.bcb258","type":"function","z":"b3e2291e.f32e58","name":"getNumGroups","func":"msg.topic = 'getNumGroups';\nmsg.nodeid = 2;\nmsg.payload = {args: [1]};\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":680,"wires":[["c224bdd2.a1788","d8f02ccd.ea8918"]]},{"id":"f0c709bc.5a1e4","type":"mqtt in dynamic","z":"b3e2291e.f32e58","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":170,"y":100,"wires":[["da60b773.1bc368"]]},{"id":"414693c5.7ca384","type":"debug","z":"b3e2291e.f32e58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":100,"wires":[]},{"id":"da60b773.1bc368","type":"switch","z":"b3e2291e.f32e58","name":"Sensor","property":"payload.label","propertyType":"msg","rules":[{"t":"eq","v":"Sensor","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":100,"wires":[["2c930ffa.aa754"],["78fef271.73b6b4"]]},{"id":"78fef271.73b6b4","type":"debug","z":"b3e2291e.f32e58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":160,"wires":[]},{"id":"36b10e50.0bd1fa","type":"function","z":"747dd001.60d558","name":"get node id","func":"msg.originalPayload = msg.payload;\nmsg.payload = {nodeid: msg.payload.node_id};\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":120,"wires":[["bc2f7de2.799e1"]]},{"id":"bc2f7de2.799e1","type":"mongodb in","z":"747dd001.60d558","mongodb":"b0c4e7bf.f27208","name":"find in db","collection":"zwave-nodes","operation":"find","x":420,"y":120,"wires":[["c598138a.8e5fc"]]},{"id":"c598138a.8e5fc","type":"function","z":"747dd001.60d558","name":"transform","func":"const payload = msg.payload[0];\n\nmsg.payload = msg.originalPayload;\ndelete msg.originalPayload;\n\nif (!payload) return msg;\n\nmsg.nodeName = payload.name;\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":120,"wires":[[]]},{"id":"2c930ffa.aa754","type":"subflow:747dd001.60d558","z":"b3e2291e.f32e58","name":"","x":580,"y":100,"wires":[["414693c5.7ca384"]]},{"id":"35b93ae9.cdd7b6","type":"mqtt in dynamic","z":"da0e7180.b9ebd8","topic":"/zwave/changevalue/response","qos":"1","name":"get zwave params","broker":"e312d9ea.c89338","x":130,"y":60,"wires":[["9fa4115f.97cff8"]]},{"id":"2a4a6654.c2d45a","type":"switch","z":"da0e7180.b9ebd8","name":"is enter sensor?","property":"nodeName","propertyType":"msg","rules":[{"t":"eq","v":"Вход","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":160,"y":160,"wires":[["ab9f458c.9fad7","86986363.89eee8"],["1fc027f3.fc7cb"]]},{"id":"86986363.89eee8","type":"function","z":"da0e7180.b9ebd8","name":"save door","func":"let data = global.get('door');\n\nif(data == null) {\n    data = {};\n}\n\ndata.value = msg.payload.value;\n\nconst now = new Date();\n\nif(data.value) {\n    data.lastOpenDate = now;\n    msg.payload.content = \"Дверь открыта\";\n} else {\n    data.lastCloseDate = now;\n    msg.payload.content = \"Дверь закрыта\";\n}\n\ndata.statusChanged = now;\n\nglobal.set('door', data);\n\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":140,"wires":[["fde0e8c8.5ca2d","1ec90d78.f17b63"]]},{"id":"1fc027f3.fc7cb","type":"function","z":"da0e7180.b9ebd8","name":"save motion","func":"const id = `motion_${msg.payload.node_id}`;\nlet data = global.get(id);\n\nif(!data) {\n    data = {};\n}\n\nconst now = new Date();\n\nif(msg.payload.value) {\n    data.lastMotion = now;\n}\n\ndata.lastChange = now;\ndata.value = msg.payload.value;\n\nglobal.set(id, data);\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":180,"wires":[["fde0e8c8.5ca2d"]]},{"id":"fde0e8c8.5ca2d","type":"function","z":"da0e7180.b9ebd8","name":"save presence and report","func":"let presence = global.get('presence');\nconst vacation = global.get('vacation');\n\nconst ble = flow.get('BLE');\nconst doorSensor = global.get('door');\nconst motionSensors = [3, 15, 29, 31, 33, 47, 48]\n        .map(x=>global.get(`motion_${x}`)).filter(x=>x != null);\n\nif(!presence && (ble || (doorSensor && doorSensor.value) || motionSensors.some(x=>x.value))) {\n    global.set('presence', true);\n    global.set('vacation', false);\n    flow.set('awayPending', false);\n    \n    return [{payload: {presence: true}}, null, null];\n}\n\nconst pending = flow.get('awayPending');\nif(pending && presence)\n{\n    flow.set('awayPending', false);\n    return [null, null, {payload: 'stop'}];\n}\n\n\nif(!pending && doorSensor && !vacation && presence && !ble && motionSensors.every(x=>!x.value)) {\n    const last = motionSensors.sort((a,b) => b.lastMotion - a.lastMotion)[0];\n    const doorClosedPeriod = doorSensor.lastCloseDate - doorSensor.lastOpenDate;\n    if(last.lastMotion <= doorSensor.lastCloseDate && doorClosedPeriod <= (60000 * 5)) {\n            flow.set('awayPending', true);\n            return [null, {payload: {presence: false}}, null];\n    }\n}\n\nreturn;","outputs":3,"noerr":0,"x":790,"y":140,"wires":[["e3b286c4.27a12","e9a7a148.8bc628","443c7c69.d01894"],[],["e3b286c4.27a12"]]},{"id":"e3b286c4.27a12","type":"function","z":"da0e7180.b9ebd8","name":"stop confirm","func":"msg.payload = 'stop';\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":200,"wires":[[]]},{"id":"40c4d0c3.e62da8","type":"subflow:747dd001.60d558","z":"da0e7180.b9ebd8","name":"","env":[],"x":520,"y":60,"wires":[["2a4a6654.c2d45a","bcb0ef86.bfbe88"]]},{"id":"443c7c69.d01894","type":"debug","z":"da0e7180.b9ebd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":970,"y":280,"wires":[]},{"id":"e9a7a148.8bc628","type":"mqtt out dynamic","z":"da0e7180.b9ebd8","name":"presence","topic":"/system/presence","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1040,"y":140,"wires":[]},{"id":"c03c4d8d.f0b8f","type":"mqtt in dynamic","z":"3c3e5440.4b857c","topic":"/hist/all/request","qos":"1","name":"get hist data","broker":"e312d9ea.c89338","x":150,"y":80,"wires":[["d51ceb84.9e2158","a16c0a9f.dd4218"]]},{"id":"d51ceb84.9e2158","type":"debug","z":"3c3e5440.4b857c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":80,"wires":[]},{"id":"6af85faa.ac6cd8","type":"influxdb in","z":"3c3e5440.4b857c","influxdb":"d47f185f.a8541","name":"select","query":"","rawOutput":false,"precision":"","retentionPolicy":"","x":750,"y":140,"wires":[["febf5619.29ff2"]]},{"id":"d38d8d39.45dd08","type":"function","z":"3c3e5440.4b857c","name":"query","func":"if (msg.type === 'weather') {\n    msg.query=`select * from ${msg.type} where time >= now() - 7d`;\n} else {\n    msg.query=`select * from sensors where type = '${msg.type}' and time >= now() - 7d`;\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":140,"wires":[["6af85faa.ac6cd8"]]},{"id":"febf5619.29ff2","type":"function","z":"3c3e5440.4b857c","name":"res","func":"if (msg.type === 'weather') {\n    let data = {};\n    data = msg.payload.map(x => {\n        return {time: x.time, value: x.temperature};\n    })\n    msg.payload = data;\n}\ndelete msg.type;\ndelete msg.query;\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":140,"wires":[["8f248327.76c498"]]},{"id":"8f248327.76c498","type":"join","z":"3c3e5440.4b857c","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","reduceRight":false,"x":1030,"y":140,"wires":[["d51ceb84.9e2158","ca0a705f.f40688"]]},{"id":"a16c0a9f.dd4218","type":"function","z":"3c3e5440.4b857c","name":"prepare","func":"return {\n    payload: {\n        weather: '',\n        temperature: '',\n        humidity: '',\n        luminance: '',\n    }\n};","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["919f5960.ffc57"]]},{"id":"8584eb55.12fc88","type":"inject","z":"3c3e5440.4b857c","name":"","topic":"","payload":"","payloadType":"date","repeat":"600","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":140,"wires":[["a16c0a9f.dd4218"]]},{"id":"919f5960.ffc57","type":"split","z":"3c3e5440.4b857c","name":"split","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"type","x":490,"y":140,"wires":[["d38d8d39.45dd08"]]},{"id":"ca0a705f.f40688","type":"mqtt out dynamic","z":"3c3e5440.4b857c","name":"out hist data","topic":"/hist/all/response","qos":"1","retain":"","broker":"e312d9ea.c89338","x":1210,"y":140,"wires":[]},{"id":"f0b6945b.44425","type":"debug","z":"51445fb5.e4d8f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1220,"y":460,"wires":[]},{"id":"48cdab0.605ca54","type":"debug","z":"51445fb5.e4d8f8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":760,"y":400,"wires":[]},{"id":"a95ca81.805aad8","type":"debug","z":"d82282fe.72a6f","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":300,"y":1120,"wires":[]},{"id":"f1c134d1.15d12","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":500,"wires":[["538793f2.068694"]]},{"id":"538793f2.068694","type":"function","z":"b3e2291e.f32e58","name":"removeAssociation","func":"const payload = msg.payload;\nconst args =  [payload.nodeid, payload.group, payload.targetid];\n\nif(payload.targetid === 1) {\n    args.push(0);\n}\n\n//const args1 =  [4, 1, 1];\nconst args1 =  [8, 3, 7];\n\nreturn {\n    topic: 'removeAssociation',\n    payload: {\n//        args: args\n        args: args1\n    }\n}","outputs":1,"noerr":0,"x":470,"y":500,"wires":[["7e3f48a.6d8be38"]]},{"id":"2b8d5ddc.af9b92","type":"subflow:fdf44b03.831398","z":"b3e2291e.f32e58","name":"","env":[],"x":1280,"y":160,"wires":[]},{"id":"d9521f30.06d99","type":"function","z":"b3e2291e.f32e58","name":"telegram transform","func":"return {\n    payload: {\n        content: 'Действие подтверждено'\n    }\n}","outputs":1,"noerr":0,"x":1070,"y":160,"wires":[["2b8d5ddc.af9b92"]]},{"id":"1bb943bf.78813c","type":"inject","z":"b3e2291e.f32e58","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":860,"y":160,"wires":[["d9521f30.06d99"]]},{"id":"919a4e3b.a5a1e","type":"telegram command","z":"b3e2291e.f32e58","name":"/vacation","command":"/vacation@YOUR_BOT","bot":"7fd9f3a.bc9e48c","strict":false,"x":1000,"y":260,"wires":[["6605fd55.147bb4"],["378b03ae.5d12c4"]]},{"id":"6605fd55.147bb4","type":"debug","z":"b3e2291e.f32e58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1190,"y":240,"wires":[]},{"id":"378b03ae.5d12c4","type":"debug","z":"b3e2291e.f32e58","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1220,"y":300,"wires":[]},{"id":"11bb53d4.3bd374","type":"comment","z":"b92ee226.f85478","name":"устройства в 'dev list fill'","info":"","x":150,"y":60,"wires":[]},{"id":"3d076b18.31770c","type":"comment","z":"b92ee226.f85478","name":"Против закисания штока","info":"","x":150,"y":260,"wires":[]},{"id":"8f129160.0e2068","type":"inject","z":"b92ee226.f85478","name":"eavry 2 week","topic":"","payload":"","payloadType":"date","repeat":"1209600","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":300,"wires":[["2b9cd419.b2dc4c"]]},{"id":"2b9cd419.b2dc4c","type":"function","z":"b92ee226.f85478","name":"dev list","func":"const devices = flow.get('devices');\n\nvar arr = [];\ndevices.forEach(x=>{\n    arr.push({\"nodeid\": x[1]});\n});\n\nmsg.payload = {\"$or\": arr};\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":300,"wires":[["911cdb26.f8303"]]},{"id":"911cdb26.f8303","type":"mongodb in","z":"b92ee226.f85478","mongodb":"b0c4e7bf.f27208","name":"get zwave nodes","collection":"zwave-nodes","operation":"find","x":490,"y":300,"wires":[["28042765.91784"]]},{"id":"6496b6f1.c054d8","type":"function","z":"b92ee226.f85478","name":"change 1","func":"const id = msg.payload[1];\nconst inst = msg.payload[2];\nconst cur = msg.payload[3];\n\nconst value = {\n        node_id: id,\n        class_id: 37,\n        instance: inst,\n        index: 0,\n        value: ! cur\n    };\n    \nreturn {\n    payload: {value: value},\n    dev: msg.payload\n};\n","outputs":1,"noerr":0,"x":920,"y":300,"wires":[["f2a44b93.e08ce","35770c61.201a84"]]},{"id":"4319d4d2.a1525c","type":"split","z":"b92ee226.f85478","name":"split","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":790,"y":300,"wires":[["6496b6f1.c054d8"]]},{"id":"28042765.91784","type":"function","z":"b92ee226.f85478","name":"prepare","func":"const devices = flow.get('devices');\n\ndevices.forEach(x=>{\n    const dev =  msg.payload.find(y=>y.nodeid === x[1]);\n    x[3] = dev.values.find(y=>y.value_id === `${x[1]}-37-${x[2]}-0`).value;\n});\n\nmsg.payload = devices;\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":300,"wires":[["4319d4d2.a1525c"]]},{"id":"f2a44b93.e08ce","type":"delay","z":"b92ee226.f85478","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1080,"y":300,"wires":[["6a7caad3.a90b8c"]]},{"id":"6a7caad3.a90b8c","type":"function","z":"b92ee226.f85478","name":"change 2","func":"const id = msg.dev[1];\nconst inst = msg.dev[2];\nconst cur = msg.dev[3];\n\nconst value = {\n        node_id: id,\n        class_id: 37,\n        instance: inst,\n        index: 0,\n        value: cur\n    };\n    \nreturn {\n    payload: {value: value},\n};\n","outputs":1,"noerr":0,"x":1220,"y":300,"wires":[["396e1c25.2738b4"]]},{"id":"8315a287.ef73e","type":"mqtt out dynamic","z":"b92ee226.f85478","name":"set drive","topic":"/zwave/changevalue/request","qos":"1","retain":"","broker":"e312d9ea.c89338","x":580,"y":100,"wires":[]},{"id":"44f4f874.4baeb","type":"link in","z":"b92ee226.f85478","name":"","links":["ad8b9e7c.2bb2e","396e1c25.2738b4","35770c61.201a84","a68b1f48.686d58","a194b6f3.66d56"],"x":475,"y":100,"wires":[["8315a287.ef73e"]]},{"id":"35770c61.201a84","type":"link out","z":"b92ee226.f85478","name":"","links":["44f4f874.4baeb"],"x":1035,"y":360,"wires":[]},{"id":"396e1c25.2738b4","type":"link out","z":"b92ee226.f85478","name":"","links":["44f4f874.4baeb"],"x":1315,"y":300,"wires":[]},{"id":"30c3cdd7.7ce192","type":"inject","z":"b92ee226.f85478","name":"start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":100,"wires":[["22981d33.bb268a"]]},{"id":"22981d33.bb268a","type":"function","z":"b92ee226.f85478","name":"dev list fill","func":"// в массиве [термостат, id исполнителя, instance исполнителя]\nconst devices = [\n    [11, 3, 1],    // srt321 кухня\n    [8, 3, 2],     // dandoss гостинная 1\n    [8, 4, 1],     // dandoss гостинная 2\n    [8, 4, 2],     // dandoss гостинная 3\n];\n\nflow.set('devices', devices);\n","outputs":1,"noerr":0,"x":280,"y":100,"wires":[[]]},{"id":"f4dc0754.677698","type":"inject","z":"b92ee226.f85478","name":"eavry 10 min","topic":"","payload":"","payloadType":"date","repeat":"600","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":200,"wires":[["4617f180.b53b"]]},{"id":"4617f180.b53b","type":"function","z":"b92ee226.f85478","name":"dev list","func":"const devices = flow.get('devices');\n\nvar arr = [];\ndevices.forEach(x=>{\n    arr.push({\"nodeid\": x[0]});\n});\n\nmsg.payload = {\"$or\": arr};\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":200,"wires":[["f6d96fd0.4a4ba"]]},{"id":"f6d96fd0.4a4ba","type":"mongodb in","z":"b92ee226.f85478","mongodb":"b0c4e7bf.f27208","name":"get zwave nodes","collection":"zwave-nodes","operation":"find","x":470,"y":200,"wires":[["dac2f46.8239588"]]},{"id":"ee3b2235.f435a","type":"function","z":"b92ee226.f85478","name":"prepare","func":"const devices = flow.get('devices');\n\nconst id = msg.payload.nodeid;\n\nconst temp = msg.payload.values.find(x=>x.value_id === `${id}-49-1-1`).value;\nconst level = msg.payload.values.find(x=>x.value_id === `${id}-67-1-1`).value;\nconst res = (parseFloat(temp) < parseFloat(level));\n\nvar arr = devices.filter(x=>x[0] === id);\n\narr.forEach(x=>x[3] = res);\n\nreturn {\n    payload: arr\n};\n","outputs":1,"noerr":0,"x":760,"y":200,"wires":[["a9219bbf.8b76e"]]},{"id":"dac2f46.8239588","type":"split","z":"b92ee226.f85478","name":"split","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":630,"y":200,"wires":[["ee3b2235.f435a"]]},{"id":"a9219bbf.8b76e","type":"split","z":"b92ee226.f85478","name":"split","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":890,"y":200,"wires":[["956e93b5.ba5ca"]]},{"id":"956e93b5.ba5ca","type":"function","z":"b92ee226.f85478","name":"prepare","func":"const arr = msg.payload;\n\nconst value = {\n        node_id: arr[1],\n        class_id: 37,\n        instance: arr[2],\n        index: 0,\n        value: arr[3]\n    };\n    \nreturn {\n    payload: {value: value}\n};\n","outputs":1,"noerr":0,"x":1020,"y":200,"wires":[["a194b6f3.66d56"]]},{"id":"a194b6f3.66d56","type":"link out","z":"b92ee226.f85478","name":"","links":["44f4f874.4baeb"],"x":1115,"y":200,"wires":[]},{"id":"bcb0ef86.bfbe88","type":"debug","z":"da0e7180.b9ebd8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":260,"wires":[]},{"id":"ab9f458c.9fad7","type":"debug","z":"da0e7180.b9ebd8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":740,"y":360,"wires":[]},{"id":"43d6d214.a9285c","type":"inject","z":"51445fb5.e4d8f8","name":"startup","topic":"","payload":"{}","payloadType":"json","repeat":"","crontab":"","once":true,"onceDelay":"60","x":140,"y":600,"wires":[["12fb2506.c4bb9b"]]},{"id":"12fb2506.c4bb9b","type":"function","z":"51445fb5.e4d8f8","name":"set watch","func":"global.set('watch', true);\nreturn {\n    payload: {content: \"Питание включено.\\nСлежение включено\"}\n};","outputs":1,"noerr":0,"x":280,"y":600,"wires":[["c9fae7bc.cf62f8"]]},{"id":"c9fae7bc.cf62f8","type":"subflow:fdf44b03.831398","z":"51445fb5.e4d8f8","name":"","x":440,"y":600,"wires":[]},{"id":"c74bb08.8c8205","type":"telegram command","z":"98294fdc.335fa","name":"/watch","command":"/watch","bot":"7fd9f3a.bc9e48c","strict":false,"x":130,"y":140,"wires":[["af60faf3.8c6ea"],[]]},{"id":"af60faf3.8c6ea","type":"function","z":"98294fdc.335fa","name":"set watch","func":"global.set('watch', true);\nreturn {\n    payload: {content: \"Слежение включено\"}\n};","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["8a092003.f49d48"]]},{"id":"1f33e81f.f249f","type":"telegram command","z":"98294fdc.335fa","name":"/unwatch","command":"/unwatch","bot":"7fd9f3a.bc9e48c","strict":false,"x":140,"y":220,"wires":[["b7de978a.fa87a8"],[]]},{"id":"b7de978a.fa87a8","type":"function","z":"98294fdc.335fa","name":"set unwatch","func":"global.set('watch', false);\nreturn {\n    payload: {content: \"Слежение выключено\"}\n};","outputs":1,"noerr":0,"x":290,"y":220,"wires":[["96b4e77e.cbd74"]]},{"id":"8a092003.f49d48","type":"subflow:fdf44b03.831398","z":"98294fdc.335fa","name":"","x":440,"y":140,"wires":[]},{"id":"96b4e77e.cbd74","type":"subflow:fdf44b03.831398","z":"98294fdc.335fa","name":"","x":460,"y":220,"wires":[]},{"id":"32e67734.1c198","type":"telegram command","z":"98294fdc.335fa","name":"/help","command":"/help","bot":"7fd9f3a.bc9e48c","strict":false,"x":130,"y":60,"wires":[["b758f961.f49e9"],[]]},{"id":"b758f961.f49e9","type":"function","z":"98294fdc.335fa","name":"prepare","func":"const txt = \"/help - список команд\\n/watch - включить слежение за дверью\\n/unwatch - выключить слежение за дверью\";\n\nreturn {\n    payload: {content: txt}\n};","outputs":1,"noerr":0,"x":280,"y":60,"wires":[["60d269f1.918f48"]]},{"id":"60d269f1.918f48","type":"subflow:fdf44b03.831398","z":"98294fdc.335fa","name":"","x":440,"y":60,"wires":[]},{"id":"9fa4115f.97cff8","type":"function","z":"da0e7180.b9ebd8","name":"is door or motion?","func":"if(msg.payload.class_id === 48 &&\nmsg.payload.instance === 1 &&\nmsg.payload.index === 0) {\n    return msg;\n}\n\nreturn;","outputs":1,"noerr":0,"x":330,"y":60,"wires":[["40c4d0c3.e62da8"]]},{"id":"1ec90d78.f17b63","type":"function","z":"da0e7180.b9ebd8","name":"check watch","func":"const watch = global.get('watch');\n\nif(watch) {\n    return msg;\n} else {\n    return;\n}\n","outputs":1,"noerr":0,"x":550,"y":440,"wires":[["e8e054bc.0d24d8"]]},{"id":"e8e054bc.0d24d8","type":"subflow:fdf44b03.831398","z":"da0e7180.b9ebd8","name":"","x":740,"y":440,"wires":[]}]